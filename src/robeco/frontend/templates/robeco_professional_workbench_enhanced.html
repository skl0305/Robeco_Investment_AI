<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robeco Investment Platform</title>
    <meta name="description" content="Investment research and analysis platform">
    
    <!-- Professional Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for Stock Price Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Analysis Persistence System -->
    <script src="/static/js/analysis_persistence.js"></script>
    
    <style>
        :root {
            /* Robeco Professional Brand Colors - PROPER BLUE */
            --robeco-navy: #001F3F;
            --robeco-blue: #0066CC;
            --robeco-light-blue: #3399FF;
            --robeco-bright-blue: #4DB8FF;
            --robeco-orange: #FF6600;
            --robeco-light-orange: #FF8533;
            --robeco-dark-orange: #CC5200;
            
            /* Transparency Variants - PROPER BLUE */
            --robeco-blue-alpha-95: rgba(0, 102, 204, 0.95);
            --robeco-blue-alpha-90: rgba(0, 102, 204, 0.9);
            --robeco-blue-alpha-80: rgba(0, 102, 204, 0.8);
            --robeco-blue-alpha-60: rgba(0, 102, 204, 0.6);
            --robeco-blue-alpha-40: rgba(0, 102, 204, 0.4);
            --robeco-blue-alpha-20: rgba(0, 102, 204, 0.2);
            --robeco-blue-alpha-10: rgba(0, 102, 204, 0.1);
            --robeco-blue-alpha-05: rgba(0, 102, 204, 0.05);
            
            --robeco-orange-alpha-95: rgba(255, 102, 0, 0.95);
            --robeco-orange-alpha-90: rgba(255, 102, 0, 0.9);
            --robeco-orange-alpha-80: rgba(255, 102, 0, 0.8);
            --robeco-orange-alpha-60: rgba(255, 102, 0, 0.6);
            --robeco-orange-alpha-40: rgba(255, 102, 0, 0.4);
            --robeco-orange-alpha-20: rgba(255, 102, 0, 0.2);
            --robeco-orange-alpha-10: rgba(255, 102, 0, 0.1);
            --robeco-orange-alpha-05: rgba(255, 102, 0, 0.05);
            
            /* Professional Gradients */
            --gradient-primary: linear-gradient(135deg, var(--robeco-blue) 0%, var(--robeco-light-blue) 100%);
            --gradient-accent: linear-gradient(135deg, var(--robeco-orange) 0%, var(--robeco-light-orange) 100%);
            --gradient-subtle: linear-gradient(135deg, var(--robeco-blue-alpha-05) 0%, var(--robeco-orange-alpha-05) 100%);
            --gradient-card: linear-gradient(135deg, var(--robeco-blue-alpha-10) 0%, transparent 100%);
            --gradient-overlay: linear-gradient(135deg, var(--robeco-blue-alpha-95) 0%, var(--robeco-orange-alpha-90) 100%);
            
            /* Enhanced Professional Investment Colors */
            --investment-dark: #0a0e1a;
            --investment-medium: #1a202c;
            --investment-light: #2d3748;
            --investment-accent: #00d4ff;
            --investment-success: #48bb78;
            --investment-warning: #ed8936;
            --investment-error: #f56565;
            
            /* Modern Professional Layout with Robeco Touches */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafe;
            --bg-tertiary: #f0f4f8;
            --bg-accent: rgba(30, 90, 135, 0.03);
            --bg-glass: rgba(255, 255, 255, 0.95);
            --bg-overlay: var(--robeco-blue-alpha-95);
            --bg-card: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(30, 90, 135, 0.02) 100%);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            
            /* Enhanced Professional Borders & Effects */
            --border-light: #e2e8f0;
            --border-medium: #cbd5e0;
            --border-accent: var(--robeco-blue);
            --shadow-professional: 0 4px 20px rgba(0, 102, 204, 0.08);
            --shadow-elevated: 0 8px 30px rgba(0, 102, 204, 0.12);
            --shadow-floating: 0 20px 50px rgba(0, 102, 204, 0.15);
            --shadow-glass: 0 8px 32px rgba(0, 102, 204, 0.1);
            --shadow-soft: 0 2px 8px rgba(0, 102, 204, 0.06);
            --shadow-premium: 0 12px 48px rgba(0, 102, 204, 0.12), 0 0 0 1px rgba(0, 102, 204, 0.05);
            --shadow-interactive: 0 8px 25px rgba(0, 102, 204, 0.15), 0 0 0 1px rgba(255, 102, 0, 0.1);
            
            /* Responsive Breakpoints */
            --mobile: 768px;
            --tablet: 1024px;
            --desktop: 1200px;
            --large: 1440px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 50%, var(--robeco-blue-alpha-05) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, var(--robeco-blue-alpha-05) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, var(--robeco-orange-alpha-05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        /* Ensure all icons are visible with proper colors */
        i.fas, i.far, i.fal, i.fab {
            color: inherit;
        }

        /* Enhanced Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-accent);
        }

        /* Enhanced Professional Robeco Header */
        .robeco-header {
            background: var(--gradient-primary);
            border-bottom: 3px solid var(--robeco-orange);
            padding: 16px 24px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px var(--robeco-blue-alpha-20);
        }

        .robeco-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
            opacity: 0.8;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { 
                opacity: 1;
                transform: translateX(-100%);
            }
            50% { 
                opacity: 0.8;
                transform: translateX(100%);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 0.6;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px var(--robeco-blue-alpha-40);
            }
            50% {
                box-shadow: 0 0 20px var(--robeco-blue-alpha-80), 0 0 30px var(--robeco-orange-alpha-40);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .robeco-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .robeco-logo {
            width: 52px;
            height: 52px;
            background: var(--bg-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-glass);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .robeco-logo:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-elevated);
        }

        .robeco-logo img {
            width: 38px;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 33, 71, 0.1));
        }

        /* Fallback for logo text if image fails */
        .robeco-logo-text {
            font-weight: 800;
            font-size: 18px;
            color: var(--robeco-navy);
            display: none;
        }

        .brand-text {
            color: var(--bg-primary);
        }

        .brand-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 2px;
        }

        .brand-subtitle {
            font-size: 13px;
            color: var(--robeco-light-blue);
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 12px;
            color: var(--bg-primary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--investment-success);
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7);
        }

        @keyframes pulse {
            0% { 
                opacity: 1; 
                box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7);
            }
            50% { 
                opacity: 0.8; 
                box-shadow: 0 0 0 8px rgba(72, 187, 120, 0);
            }
            100% { 
                opacity: 1; 
                box-shadow: 0 0 0 0 rgba(72, 187, 120, 0);
            }
        }

        /* Professional Layout Container */
        .workbench-container {
            display: flex;
            height: calc(100vh - 80px);
            max-width: 100vw;
            overflow: hidden;
        }

        /* Ultra-Professional Responsive Sidebar */
        .sidebar {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-light);
            width: 380px;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: var(--shadow-glass);
            position: relative;
            transition: all 0.3s ease;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--robeco-blue), transparent);
        }

        .sidebar-section {
            padding: 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: var(--robeco-blue);
        }

        /* Project Setup Section */
        .project-setup {
            background: var(--bg-accent);
            border: 1px solid var(--robeco-light-blue);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .project-setup::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--gradient-primary);
            border-radius: 14px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .project-setup:hover::before {
            opacity: 0.1;
        }

        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .professional-input {
            padding: 12px 16px;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            transition: all 0.2s ease;
        }

        .professional-input:focus {
            outline: none;
            border-color: var(--robeco-blue);
            box-shadow: 0 0 0 3px var(--robeco-blue-alpha-20);
            transform: translateY(-1px);
        }

        .setup-button {
            background: var(--gradient-primary);
            color: var(--bg-primary);
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            letter-spacing: 0.025em;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-professional);
        }

        .setup-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-elevated);
        }

        .setup-button:hover::before {
            left: 100%;
        }

        .setup-button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-professional);
        }
        
        .setup-button i {
            color: inherit;
        }

        /* Bulk Upload Progress Bar */
        .bulk-upload-progress {
            margin: 12px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 500;
        }
        
        .file-info {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Bulk upload section specific styles */
        .bulk-upload-section {
            margin-bottom: 20px;
        }
        
        .bulk-upload-section .setup-button:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }
        
        .bulk-upload-section .setup-button:disabled::before {
            display: none;
        }

        /* Ultra-Enhanced Responsive Analyst Cards */
        .analysts-section {
            flex: 1;
        }

        .analyst-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }

        .analyst-card {
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px var(--robeco-blue-alpha-10);
            background-clip: padding-box;
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: both;
        }

        .analyst-card:nth-child(1) { animation-delay: 0.1s; }
        .analyst-card:nth-child(2) { animation-delay: 0.2s; }
        .analyst-card:nth-child(3) { animation-delay: 0.3s; }
        .analyst-card:nth-child(4) { animation-delay: 0.4s; }
        .analyst-card:nth-child(5) { animation-delay: 0.5s; }
        .analyst-card:nth-child(6) { animation-delay: 0.6s; }

        .analyst-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .analyst-card:hover {
            transform: translateY(-8px) scale(1.03) rotateY(2deg);
            box-shadow: 0 12px 40px var(--robeco-blue-alpha-30), 
                        0 4px 12px var(--robeco-orange-alpha-15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-color: var(--robeco-blue-alpha-60);
            animation: glow 2s infinite;
        }

        .analyst-card:active {
            transform: translateY(-4px) scale(1.01);
            transition: all 0.1s ease;
        }

        .analyst-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-subtle);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .analyst-card:hover::after {
            opacity: 1;
        }

        .analyst-card:hover::before {
            transform: scaleX(1);
        }

        .analyst-card.active {
            border-color: var(--robeco-orange);
            background: linear-gradient(135deg, var(--robeco-orange-alpha-05), transparent);
            box-shadow: 0 8px 30px var(--robeco-orange-alpha-30),
                        0 0 20px var(--robeco-orange-alpha-20);
            animation: pulse 3s infinite, glow 2s infinite;
        }

        .analyst-card.active::before {
            background: var(--gradient-accent);
            transform: scaleX(1);
            animation: shimmer 2s infinite;
        }

        .analyst-card.completed {
            border-color: var(--robeco-blue);
            background: linear-gradient(135deg, var(--robeco-blue-alpha-05), transparent);
            box-shadow: 0 8px 30px var(--robeco-blue-alpha-30),
                        0 0 15px var(--robeco-blue-alpha-15);
            animation: float 4s ease-in-out infinite;
        }

        .analyst-card.completed::before {
            background: var(--gradient-primary);
            transform: scaleX(1);
        }

        .analyst-card.completed::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--robeco-blue);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px var(--robeco-blue-alpha-40);
        }

        .analyst-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .analyst-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .analyst-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg) translateX(-100%);
            transition: transform 0.8s ease;
        }
        
        .analyst-card:hover .analyst-icon::before {
            transform: rotate(45deg) translateX(100%);
        }

        .analyst-card.active .analyst-icon {
            background: var(--gradient-accent);
            animation: pulse-orange 2s infinite;
            box-shadow: 0 0 20px var(--robeco-orange-alpha-40);
        }

        .analyst-card.completed .analyst-icon {
            background: linear-gradient(135deg, var(--investment-success), #38a169);
        }

        @keyframes pulse-orange {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .analyst-info {
            flex: 1;
        }

        .analyst-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .analyst-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .analyst-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
            min-width: 80px;
            justify-content: center;
        }

        .analyst-status.ready {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-color: var(--border-medium);
        }

        .analyst-status.researching {
            background: linear-gradient(135deg, rgba(255, 102, 0, 0.1), rgba(255, 102, 0, 0.05));
            color: var(--robeco-orange);
            border-color: var(--robeco-orange);
            animation: pulse-status 2s infinite;
        }

        .analyst-status.completed {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(72, 187, 120, 0.05));
            color: var(--investment-success);
            border-color: var(--investment-success);
        }

        .analyst-status.cached {
            background: linear-gradient(135deg, rgba(0, 123, 123, 0.1), rgba(0, 123, 123, 0.05));
            color: var(--robeco-blue);
            border-color: var(--robeco-blue);
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Analysis Results Section */
        .analysis-section {
            flex: 1;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .analysis-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .analysis-title i {
            color: var(--robeco-blue);
        }

        .analysis-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-button {
            position: relative;
            overflow: hidden;
        }
        
        .control-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .control-button:hover {
            background: var(--robeco-blue);
            color: var(--bg-primary);
            border-color: var(--robeco-blue);
            transform: translateY(-1px);
            box-shadow: var(--shadow-elevated);
        }
        
        .control-button:hover::before {
            left: 100%;
        }

        .control-button.active {
            background: var(--robeco-orange);
            color: var(--bg-primary);
            border-color: var(--robeco-orange);
            box-shadow: var(--shadow-interactive);
        }
        
        .control-button i {
            color: inherit;
        }

        /* Enhanced Analysis Content Area */
        .analysis-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .analysis-main {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .analysis-chat {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-light);
            display: none;
            flex-direction: column;
        }

        .analysis-chat.active {
            display: flex;
        }

        /* Professional Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-size: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-elevated);
            position: relative;
            overflow: hidden;
            animation: float 6s ease-in-out infinite;
        }
        
        .welcome-icon::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: rotate-gradient 8s linear infinite;
        }
        
        @keyframes rotate-gradient {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 400px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            max-width: 600px;
        }

        .feature-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-professional);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--robeco-blue-alpha-05), transparent);
            transition: left 0.5s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-premium);
            border-color: var(--robeco-blue-alpha-40);
        }
        
        .feature-card:hover::before {
            left: 100%;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: var(--robeco-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            margin: 0 auto 12px;
            font-size: 18px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .feature-card:hover .feature-icon {
            background: var(--gradient-accent);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 4px 15px var(--robeco-blue-alpha-30);
        }

        .feature-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .feature-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Progress Indicator */
        .progress-section {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            padding: 16px 24px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--robeco-teal), var(--robeco-orange), var(--robeco-gold));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer-progress 2s infinite;
        }

        @keyframes shimmer-progress {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        /* Phase-specific styling */
        .progress-text.phase-starting {
            color: var(--robeco-blue);
            font-weight: 600;
        }

        .progress-text.phase-complete {
            color: #22c55e;
            font-weight: 600;
        }

        .progress-text.phase-transition {
            color: var(--robeco-orange);
            font-weight: 600;
        }

        .progress-text.phase-working {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Loading spinner animation */
        .loading-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            color: currentColor;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ultra-Enhanced Analysis Display */
        .analysis-display {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: var(--shadow-glass);
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .analysis-display:hover {
            box-shadow: var(--shadow-elevated);
            transform: translateY(-2px);
        }

        .analysis-display.has-content {
            display: block;
        }

        .analysis-content-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .content-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .content-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: 1px solid var(--border-medium);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn {
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }
        
        .action-btn:active::after {
            width: 300px;
            height: 300px;
            transition: all 0s;
        }
        
        .action-btn:hover {
            background: var(--robeco-blue);
            color: var(--bg-primary);
            border-color: var(--robeco-blue);
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-elevated);
        }

        .action-btn.chat-toggle {
            background: var(--robeco-orange);
            color: var(--bg-primary);
            border-color: var(--robeco-orange);
        }
        
        .action-btn i {
            color: inherit;
        }

        .streaming-content {
            padding: 20px;
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-primary);
            min-height: 200px;
        }

        .streaming-content h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--robeco-navy);
            margin-bottom: 16px;
            border-bottom: 2px solid var(--robeco-blue);
            padding-bottom: 8px;
        }

        .streaming-content h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--robeco-blue);
            margin: 20px 0 12px 0;
        }

        .streaming-content h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 16px 0 8px 0;
        }

        /* Professional Sources Section */
        .sources-section {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            padding: 20px;
        }

        .sources-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .source-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .source-card:hover {
            border-color: var(--robeco-blue);
            box-shadow: var(--shadow-professional);
            transform: translateY(-1px);
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .source-index {
            background: var(--robeco-blue);
            color: var(--bg-primary);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .source-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.3;
        }

        .source-meta {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .credibility-badge {
            background: var(--investment-success);
            color: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Report Viewer Styles */
        .report-viewer-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            padding: 20px;
        }

        .report-section {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .report-section .section-title {
            background: var(--robeco-navy);
            color: var(--bg-primary);
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            border-bottom: none;
        }

        .raw-html-viewer {
            flex: 1;
            overflow: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
        }

        .raw-html-viewer pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .rendered-report-viewer {
            flex: 1;
            overflow: auto;
            background: white;
            padding: 0;
        }

        .report-placeholder {
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Professional Chat Interface */
        .chat-header {
            background: var(--robeco-navy);
            color: var(--bg-primary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .chat-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-subtitle {
            font-size: 11px;
            color: var(--robeco-light-blue);
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .chat-message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: var(--robeco-orange);
            color: var(--bg-primary);
        }

        .message-avatar.ai {
            background: var(--robeco-blue);
            color: var(--bg-primary);
        }

        .message-content {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 13px;
            line-height: 1.5;
        }

        .message-content.ai {
            background: linear-gradient(135deg, rgba(0, 123, 123, 0.05), rgba(0, 123, 123, 0.02));
            border: 1px solid rgba(0, 123, 123, 0.1);
        }

        /* System debug messages */
        .message-avatar.system {
            background: var(--text-muted);
            color: var(--bg-primary);
            font-size: 10px;
        }

        .message-content.system {
            background: rgba(100, 100, 100, 0.05);
            border: 1px solid rgba(100, 100, 100, 0.2);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
        }

        .message-content.debug-critical {
            background: rgba(220, 38, 127, 0.1);
            border: 1px solid rgba(220, 38, 127, 0.3);
            color: var(--investment-warning);
        }

        .message-content.debug-info {
            background: rgba(0, 123, 123, 0.1);
            border: 1px solid rgba(0, 123, 123, 0.3);
        }

        .chat-input-section {
            padding: 16px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            font-size: 13px;
            background: var(--bg-primary);
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--robeco-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 123, 0.1);
        }

        .chat-send {
            background: var(--robeco-blue);
            color: var(--bg-primary);
            border: none;
            padding: 12px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-send:hover {
            background: var(--robeco-blue);
            transform: translateY(-1px);
        }

        .chat-send:disabled {
            background: var(--border-medium);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        /* Loading States */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-light);
            border-top: 2px solid var(--robeco-teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-indicator.api-ready {
            background: rgba(72, 187, 120, 0.1);
            color: var(--investment-success);
        }

        .status-indicator.api-suspended {
            background: rgba(245, 101, 101, 0.1);
            color: var(--investment-error);
        }

        .status-indicator.fallback-mode {
            background: rgba(237, 137, 54, 0.1);
            color: var(--investment-warning);
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1440px) {
            .header-content {
                max-width: 1200px;
            }
            
            .sidebar {
                width: 360px;
                min-width: 320px;
            }
        }

        @media (max-width: 1200px) {
            .analysis-chat {
                width: 280px;
            }
            
            .sidebar {
                width: 340px;
                min-width: 300px;
            }
            
            .brand-title {
                font-size: 20px;
            }
            
            .analyst-grid {
                gap: 12px;
            }
        }

        @media (max-width: 1024px) {
            .workbench-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                overflow-y: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-light);
            }
            
            .sidebar-section {
                padding: 20px;
            }
            
            .analyst-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 12px;
            }
            
            .analysis-content {
                flex-direction: column;
            }

            .analysis-chat {
                width: 100%;
                max-height: 300px;
                border-left: none;
                border-top: 1px solid var(--border-light);
            }
            
            .robeco-header {
                padding: 12px 20px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                gap: 12px;
            }
            
            .robeco-logo {
                width: 40px;
                height: 40px;
            }
            
            .robeco-logo img {
                width: 28px;
            }
            
            .brand-title {
                font-size: 18px;
            }
            
            .brand-subtitle {
                font-size: 11px;
            }
            
            .connection-indicator {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .sidebar {
                max-height: 35vh;
            }
            
            .sidebar-section {
                padding: 16px;
            }
            
            .setup-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .analyst-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .analyst-card {
                padding: 14px;
            }
            
            .analysis-main {
                padding: 16px;
            }
            
            .streaming-content {
                padding: 16px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .robeco-header {
                padding: 10px 16px;
            }
            
            .header-content {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .header-status {
                order: 3;
                width: 100%;
                margin-top: 8px;
                justify-content: space-between;
            }
            
            .sidebar-section {
                padding: 14px;
            }
            
            .project-setup {
                padding: 16px;
            }
            
            .analyst-card {
                padding: 12px;
                border-radius: 12px;
            }
            
            .analyst-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .analyst-name {
                font-size: 13px;
            }
            
            .analyst-desc {
                font-size: 10px;
            }
            
            .analysis-main {
                padding: 12px;
            }
            
            .streaming-content {
                padding: 12px;
                font-size: 12px;
            }
        }

        /* Professional Report Formatting Styles */
        .report-h1 {
            color: var(--robeco-navy);
            font-size: 28px;
            font-weight: 700;
            margin: 32px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--robeco-blue);
            line-height: 1.2;
        }

        .report-h2 {
            color: var(--robeco-blue);
            font-size: 22px;
            font-weight: 600;
            margin: 18px 0 10px 0;
            padding-left: 12px;
            border-left: 4px solid var(--robeco-orange);
            line-height: 1.3;
            position: relative;
        }

        .report-h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 60px;
            height: 2px;
            background: var(--gradient-accent);
            opacity: 0.6;
        }

        .report-h3 {
            color: var(--robeco-blue);
            font-size: 18px;
            font-weight: 600;
            margin: 14px 0 8px 0;
            line-height: 1.4;
            position: relative;
        }

        .report-h3::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 16px;
            background: var(--gradient-accent);
            border-radius: 2px;
        }

        .report-paragraph {
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 8px;
            text-align: justify;
        }

        /* List styling - COMPACT */
        .report-list {
            margin: 8px 0;
            padding-left: 24px;
        }

        .report-list-item {
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 4px;
            list-style-type: disc;
        }

        /* Table styling */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
            background: var(--bg-primary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .report-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--robeco-orange);
        }

        .report-table td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .report-table tr:hover {
            background: var(--robeco-blue-alpha-05);
        }

        .report-table tr:last-child td {
            border-bottom: none;
        }

        /* Citation styling */
        .citation-marker {
            background: var(--gradient-primary) !important;
            color: white !important;
            padding: 2px 5px !important;
            border-radius: 4px !important;
            font-size: 10px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            margin-left: 2px !important;
            display: inline-block !important;
            transition: all 0.3s ease !important;
            border: 1px solid var(--robeco-blue-alpha-20) !important;
            box-shadow: 0 2px 4px var(--robeco-blue-alpha-20) !important;
        }

        .citation-marker:hover {
            background: var(--gradient-accent) !important;
            transform: scale(1.15) translateY(-1px) !important;
            box-shadow: 0 4px 8px var(--robeco-orange-alpha-30) !important;
        }

        .report-bold {
            color: var(--robeco-blue);
            font-weight: 700;
        }

        .report-italic {
            color: var(--text-secondary);
            font-style: italic;
        }

        .report-code {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .report-inline-code {
            background: var(--bg-accent);
            color: var(--robeco-blue);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            font-weight: 500;
        }

        .report-list {
            margin: 16px 0 16px 20px;
            padding: 0;
        }

        .report-list-item {
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 8px;
            padding-left: 8px;
            position: relative;
        }

        .report-list-item:before {
            content: "â€¢";
            color: var(--robeco-blue);
            font-weight: bold;
            position: absolute;
            left: -12px;
        }

        /* Streaming Content Container Enhancement */
        #streamingContent {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Robeco, sans-serif;
            padding: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 33, 71, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        #streamingContent:empty::before {
            content: "Analysis results will appear here...";
            color: var(--text-tertiary);
            font-style: italic;
            display: block;
            text-align: center;
            padding: 40px;
        }
        
        /* Stock Chart Styles */
        .stock-chart-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: var(--shadow-elevated);
            border: 2px solid var(--robeco-blue-alpha-20);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--robeco-blue-alpha-10);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--robeco-navy);
        }
        
        .chart-period {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--robeco-blue-alpha-10);
            padding: 6px 12px;
            border-radius: 8px;
        }
        
        .stock-chart-canvas {
            height: 400px !important;
            width: 100% !important;
        }
        
        /* Citation marker styles */
        .citation-marker {
            display: inline;
            color: var(--robeco-blue);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            padding: 1px 3px;
            border-radius: 2px;
            transition: background-color 0.2s ease;
        }
        
        .citation-marker:hover {
            background-color: var(--robeco-blue-alpha-20);
            text-decoration: underline;
        }
        
        .citation-marker:active {
            background-color: var(--robeco-blue-alpha-40);
        }
    </style>
</head>
<body>
    <!-- Professional Robeco Header -->
    <div class="robeco-header">
        <div class="header-content">
            <div class="robeco-brand">
                <div class="robeco-logo">
                    <img src="https://images.ctfassets.net/tl4x668xzide/7mygwms2vuSwirnfvaCSvL/72d2bbd858a69aecbf59fd3fb8954484/robeco-logo-color.png" 
                         alt="Robeco Logo" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="robeco-logo-text">R</div>
                </div>
                <div class="brand-text">
                    <div class="brand-title">Robeco</div>
                    <div class="brand-subtitle">Investment Platform</div>
                </div>
            </div>
            <div class="header-status">
                <div class="connection-indicator">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">Connected</span>
                </div>
                <div class="status-indicator api-ready" id="apiStatus">
                    <i class="fas fa-check-circle"></i>
                    <span>API Ready</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workbench Container -->
    <div class="workbench-container">
        <!-- Enhanced Professional Sidebar -->
        <div class="sidebar">
            <!-- Project Setup Section -->
            <div class="sidebar-section">
                <div class="section-title">
                    <i class="fas fa-briefcase"></i>
                    Investment Project
                </div>
                <div class="project-setup">
                    <div class="setup-grid">
                        <div class="input-group">
                            <label class="input-label">Company Name</label>
                            <input type="text" id="companyInput" class="professional-input" placeholder="e.g., Apple Inc." style="width: 100%; min-width: 0;">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Ticker Symbol</label>
                            <input type="text" id="tickerInput" class="professional-input" placeholder="e.g., AAPL" style="width: 100%; min-width: 0; text-transform: uppercase;">
                        </div>
                    </div>
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label class="input-label">Investment Objective</label>
                        <input type="text" id="queryInput" class="professional-input" placeholder="e.g., Evaluate for core equity position">
                    </div>
                    
                    <!-- Context fields integrated into main form -->
                    <div class="input-group" style="margin-bottom: 14px;">
                        <label class="input-label">Data Sources</label>
                        <textarea id="dataSourcesInput" class="professional-input" placeholder="e.g., Bloomberg data, annual reports, recent earnings call..." style="min-height: 45px; resize: vertical;"></textarea>
                    </div>
                    <div class="input-group" style="margin-bottom: 14px;">
                        <label class="input-label">Key Information</label>
                        <textarea id="keyInformationInput" class="professional-input" placeholder="e.g., Recent management changes, upcoming earnings, industry trends..." style="min-height: 45px; resize: vertical;"></textarea>
                    </div>
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label class="input-label">Investment Context</label>
                        <textarea id="investmentContextInput" class="professional-input" placeholder="e.g., Growth vs value focus, portfolio allocation goals, risk tolerance..." style="min-height: 45px; resize: vertical;"></textarea>
                    </div>
                    
                    <button class="setup-button" onclick="setupInvestmentProject()">
                        <i class="fas fa-rocket"></i> Initialize Analysis
                    </button>
                </div>
            </div>


            <!-- Bulk File Upload Section -->
            <div class="sidebar-section bulk-upload-section">
                <div class="section-title">
                    <i class="fas fa-upload"></i>
                    Bulk Document Analysis
                </div>
                <div class="project-setup">
                    <div class="input-group" style="margin-bottom: 16px;">
                        <label class="input-label">Document Upload</label>
                        <input type="file" id="bulkFileInput" class="professional-input" multiple accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.jpg,.jpeg,.png,.webp" style="padding: 8px;">
                        <div class="file-info" style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            Max 10 files, 100MB each. Supports: PDF, Word, Excel, Images
                        </div>
                    </div>
                    <div class="bulk-upload-progress" id="bulkUploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="bulkProgressFill"></div>
                        </div>
                        <div class="progress-text" id="bulkProgressText">Processing files...</div>
                    </div>
                    <button class="setup-button" id="bulkUploadButton" onclick="startBulkUpload()" disabled>
                        <i class="fas fa-file-upload"></i> Analyze Documents
                    </button>
                </div>
            </div>

            <!-- Enhanced Analyst Cards -->
            <div class="sidebar-section analysts-section">
                <div class="section-title">
                    <i class="fas fa-users"></i>
                    Specialist Analysts
                </div>
                <div class="analyst-grid">
                    <div class="analyst-card" data-specialist="fundamentals" onclick="handleAnalystClick('fundamentals')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-chart-bar"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Fundamental Analysis</div>
                                <div class="analyst-desc">Financial performance, business model, growth drivers</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="industry" onclick="handleAnalystClick('industry')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-industry"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Industry Analysis</div>
                                <div class="analyst-desc">Sector trends, competitive landscape, market positioning</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="technical" onclick="handleAnalystClick('technical')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-chart-line"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Technical Analysis</div>
                                <div class="analyst-desc">Chart patterns, momentum, support/resistance levels</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="risk" onclick="handleAnalystClick('risk')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-shield-alt"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Risk Assessment</div>
                                <div class="analyst-desc">Risk factors, stress testing, portfolio impact</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="esg" onclick="handleAnalystClick('esg')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-leaf"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">ESG Analysis</div>
                                <div class="analyst-desc">Environmental, social, governance factors</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="valuation" onclick="handleAnalystClick('valuation')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-calculator"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Valuation Analysis</div>
                                <div class="analyst-desc">DCF modeling, comparable analysis, fair value</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <!-- New Analyst Types -->
                    <div class="analyst-card" data-specialist="bull" onclick="handleAnalystClick('bull')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-arrow-trend-up"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Bull Case Analysis</div>
                                <div class="analyst-desc">Upside catalysts, growth opportunities, long thesis</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="bear" onclick="handleAnalystClick('bear')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-arrow-trend-down"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Bear Case Analysis</div>
                                <div class="analyst-desc">Downside risks, structural challenges, short thesis</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="catalysts" onclick="handleAnalystClick('catalysts')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-bolt"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Catalysts Analysis</div>
                                <div class="analyst-desc">Event-driven opportunities, timing, impact</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="drivers" onclick="handleAnalystClick('drivers')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-gears"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Drivers & Developments</div>
                                <div class="analyst-desc">Key business drivers, recent developments</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="consensus" onclick="handleAnalystClick('consensus')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-users"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Consensus Analysis</div>
                                <div class="analyst-desc">Market consensus, analyst estimates, sentiment</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>

                    <div class="analyst-card" data-specialist="anti_consensus" onclick="handleAnalystClick('anti_consensus')">
                        <div class="analyst-header">
                            <div class="analyst-icon"><i class="fas fa-chess"></i></div>
                            <div class="analyst-info">
                                <div class="analyst-name">Anti-Consensus Analysis</div>
                                <div class="analyst-desc">Contrarian views, market inefficiencies, alpha</div>
                            </div>
                            <div class="analyst-status ready">Ready</div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Report Section -->
                <div class="report-generation-section" style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #007b7b, #005c5c); border-radius: 12px; text-align: center;">
                    <div style="color: white; font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                        <i class="fas fa-file-alt" style="margin-right: 8px;"></i>
                        Generate Investment Report
                    </div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 16px;">
                        Step 1: Generate HTML report â†’ Step 2: Convert to Word/PDF document
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap;">
                        <button class="generate-report-btn" onclick="console.log('ðŸŽ¯ BUTTON CLICKED - generateTemplateReport'); generateTemplateReport()" style="
                            background: rgba(255,255,255,0.2); 
                            color: white; 
                            border: 2px solid rgba(255,255,255,0.3); 
                            padding: 12px 24px; 
                            border-radius: 8px; 
                            font-weight: 600;
                            font-size: 14px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            backdrop-filter: blur(10px);
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.borderColor='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='rgba(255,255,255,0.3)'">
                            <i class="fas fa-magic" style="margin-right: 8px;"></i>
                            Generate HTML Report
                        </button>
                        
                        <button class="generate-word-btn" id="generateWordBtn" onclick="generateWordReport()" disabled style="
                            background: rgba(255,140,0,0.1); 
                            color: rgba(255,255,255,0.4); 
                            border: 2px solid rgba(255,140,0,0.2); 
                            padding: 12px 24px; 
                            border-radius: 8px; 
                            font-weight: 600;
                            font-size: 14px;
                            cursor: not-allowed;
                            transition: all 0.2s ease;
                            backdrop-filter: blur(10px);
                            display: inline-block;
                            opacity: 0.4;
                        " title="Generate HTML report first to enable Word conversion">
                            <i class="fas fa-file-word" style="margin-right: 8px;"></i>
                            Generate Word Document
                        </button>
                        <button class="generate-pdf-btn" id="generatePdfBtn" onclick="generatePdfReport()" disabled style="
                            background: rgba(220,53,69,0.1); 
                            color: rgba(255,255,255,0.4); 
                            border: 2px solid rgba(220,53,69,0.2); 
                            padding: 12px 24px; 
                            border-radius: 8px; 
                            font-weight: 600;
                            font-size: 14px;
                            cursor: not-allowed;
                            transition: all 0.2s ease;
                            backdrop-filter: blur(10px);
                            display: inline-block;
                            opacity: 0.4;
                        " title="Generate HTML report first to enable PDF conversion">
                            <i class="fas fa-file-pdf" style="margin-right: 8px;"></i>
                            Generate PDF Document
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Analysis Section -->
        <div class="analysis-section">
            <!-- Analysis Header -->
            <div class="analysis-header">
                <div class="analysis-title" id="analysisTitle">
                    <i class="fas fa-chart-area"></i>
                    Select an analyst to begin
                </div>
                <div class="analysis-controls">
                    <button class="control-button" id="refreshBtn" onclick="refreshCurrentAnalysis()" style="display: none;">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                    <button class="control-button chat-toggle" id="chatToggle" onclick="toggleChat()" style="display: none;">
                        <i class="fas fa-comments"></i> Discuss
                    </button>
                    <button class="control-button" onclick="exportAnalysis()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
                </div>
                <div class="progress-text" id="progressText">Initializing analysis...</div>
            </div>

            <!-- Analysis Content -->
            <div class="analysis-content">
                <!-- Main Analysis Display -->
                <div class="analysis-main">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="welcome-title">Investment Analysis</div>
                        <div class="welcome-subtitle">
                            Select a specialist analyst to begin comprehensive investment research
                        </div>
                        <div class="welcome-features">
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-search"></i></div>
                                <div class="feature-title">Google Research</div>
                                <div class="feature-desc">Real-time market intelligence</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-brain"></i></div>
                                <div class="feature-title">AI Analysis</div>
                                <div class="feature-desc">Quality insights</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-comments"></i></div>
                                <div class="feature-title">Expert Discussion</div>
                                <div class="feature-desc">Post-analysis consultation</div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Display -->
                    <div class="analysis-display" id="analysisDisplay" style="display: none;">
                        <div class="analysis-content-header">
                            <div class="content-title" id="contentTitle">Analysis Results</div>
                            <div class="content-actions">
                                <button class="action-btn" onclick="generateTemplateReport()">
                                    <i class="fas fa-file-alt"></i> Generate Report
                                </button>
                                <button class="action-btn" onclick="downloadAnalysis()">
                                    <i class="fas fa-download"></i> PDF
                                </button>
                                <button class="action-btn" onclick="shareAnalysis()">
                                    <i class="fas fa-share"></i> Share
                                </button>
                                <button class="action-btn chat-toggle" onclick="toggleChat()">
                                    <i class="fas fa-comments"></i> Discuss
                                </button>
                            </div>
                        </div>
                        <!-- Separate Content Areas for Each Analyst -->
                        <div class="analyst-pages">
                            <!-- Industry Analyst Page -->
                            <div class="analyst-page" id="industryPage" style="display: none;">
                                <div class="streaming-content" id="industryContent"></div>
                                <div class="sources-section" id="industrySources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Industry Research Sources
                                    </div>
                                    <div class="sources-grid" id="industrySourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Fundamentals Analyst Page -->
                            <div class="analyst-page" id="fundamentalsPage" style="display: none;">
                                <div class="streaming-content" id="fundamentalsContent"></div>
                                <div class="sources-section" id="fundamentalsSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Fundamentals Research Sources
                                    </div>
                                    <div class="sources-grid" id="fundamentalsSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Technical Analyst Page -->
                            <div class="analyst-page" id="technicalPage" style="display: none;">
                                <div class="streaming-content" id="technicalContent"></div>
                                <div class="sources-section" id="technicalSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Technical Research Sources
                                    </div>
                                    <div class="sources-grid" id="technicalSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Risk Analyst Page -->
                            <div class="analyst-page" id="riskPage" style="display: none;">
                                <div class="streaming-content" id="riskContent"></div>
                                <div class="sources-section" id="riskSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Risk Assessment Sources
                                    </div>
                                    <div class="sources-grid" id="riskSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- ESG Analyst Page -->
                            <div class="analyst-page" id="esgPage" style="display: none;">
                                <div class="streaming-content" id="esgContent"></div>
                                <div class="sources-section" id="esgSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        ESG Research Sources
                                    </div>
                                    <div class="sources-grid" id="esgSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Valuation Analyst Page -->
                            <div class="analyst-page" id="valuationPage" style="display: none;">
                                <div class="streaming-content" id="valuationContent"></div>
                                <div class="sources-section" id="valuationSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Valuation Research Sources
                                    </div>
                                    <div class="sources-grid" id="valuationSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Bull Case Analysis Page -->
                            <div class="analyst-page" id="bullPage" style="display: none;">
                                <div class="streaming-content" id="bullContent"></div>
                                <div class="sources-section" id="bullSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Bull Case Research Sources
                                    </div>
                                    <div class="sources-grid" id="bullSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Bear Case Analysis Page -->
                            <div class="analyst-page" id="bearPage" style="display: none;">
                                <div class="streaming-content" id="bearContent"></div>
                                <div class="sources-section" id="bearSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Bear Case Research Sources
                                    </div>
                                    <div class="sources-grid" id="bearSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Catalysts Analysis Page -->
                            <div class="analyst-page" id="catalystsPage" style="display: none;">
                                <div class="streaming-content" id="catalystsContent"></div>
                                <div class="sources-section" id="catalystsSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Catalysts Research Sources
                                    </div>
                                    <div class="sources-grid" id="catalystsSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Drivers & Developments Page -->
                            <div class="analyst-page" id="driversPage" style="display: none;">
                                <div class="streaming-content" id="driversContent"></div>
                                <div class="sources-section" id="driversSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Drivers & Developments Research Sources
                                    </div>
                                    <div class="sources-grid" id="driversSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Consensus Analysis Page -->
                            <div class="analyst-page" id="consensusPage" style="display: none;">
                                <div class="streaming-content" id="consensusContent"></div>
                                <div class="sources-section" id="consensusSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Consensus Analysis Research Sources
                                    </div>
                                    <div class="sources-grid" id="consensusSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Anti-Consensus Analysis Page -->
                            <div class="analyst-page" id="anti_consensusPage" style="display: none;">
                                <div class="streaming-content" id="anti_consensusContent"></div>
                                <div class="sources-section" id="anti_consensusSources" style="display: none;">
                                    <div class="sources-title">
                                        <i class="fas fa-external-link-alt"></i>
                                        Anti-Consensus Research Sources
                                    </div>
                                    <div class="sources-grid" id="anti_consensusSourcesGrid"></div>
                                </div>
                            </div>
                            
                            <!-- Investment Report Viewer Page -->
                            <div class="analyst-page" id="reportPage" style="display: none;">
                                <div class="report-viewer-container">
                                    <!-- Final Rendered Report Display (Visual Report First) -->
                                    <div class="report-section">
                                        <div class="section-title">
                                            <i class="fas fa-file-alt"></i>
                                            Report
                                        </div>
                                        <div class="rendered-report-viewer" id="renderedReportViewer">
                                            <div class="report-placeholder">
                                                Investment report will appear here as AI generates the content...
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Raw HTML Code Generation Display (Below Visual Report) -->
                                    <div class="report-section">
                                        <div class="section-title">
                                            <i class="fas fa-code"></i>
                                            Raw HTML Code Generation
                                        </div>
                                        <div class="raw-html-viewer" id="rawHtmlViewer">
                                            <pre><code id="rawHtmlCode">// Raw HTML code will appear here as it's being generated by AI...</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Default/Welcome Page -->
                            <div class="analyst-page" id="defaultPage" style="display: block;">
                                <div class="streaming-content" id="defaultContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Professional Chat Interface -->
                <div class="analysis-chat" id="analysisChat">
                    <div class="chat-header">
                        <div class="chat-title" id="chatAnalystName">Discuss with Analyst</div>
                        <div class="chat-subtitle">Continue the conversation</div>
                        <button onclick="clearChatHistory()" style="background: none; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; float: right; margin-top: -20px;">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message">
                            <div class="message-avatar ai">AI</div>
                            <div class="message-content ai">
                                Hello! I've completed my analysis. Feel free to ask any follow-up questions or request additional insights on specific areas.
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-section">
                        <div class="chat-input-container">
                            <textarea 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder="Ask follow-up questions about the analysis..."
                                rows="1"></textarea>
                            <button class="chat-send" id="chatSend" onclick="sendChatMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DEBUG: Script started loading
        console.log('ðŸ”§ DEBUG: JavaScript script tag reached');
        
        // JavaScript is now loading properly - emergency function no longer needed
        
        // Enhanced Professional Variables
        let currentProject = null;
        let currentAnalysis = null;
        let ws = null;
        let analysisCache = {}; // Cache for completed analyses
        let currentChatAnalyst = null;
        let chatHistory = {}; // Chat history per analyst
        let currentChatSession = null;
        
        // Global Session Management for Multi-User Support
        let userSession = {
            id: `user_${Date.now()}_${Math.random().toString(36).substr(2, 12)}_${Math.floor(Math.random() * 1000000)}`,
            connectionId: `conn_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`,
            startTime: new Date().toISOString(),
            userAgent: navigator.userAgent,
            clientIP: 'unknown', // Will be set by server
            isolated: true // Ensure complete isolation
        };
        
        // Initialize Professional System with DEBUG LOGGING
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Robeco Professional Investment Platform Initializing...');
            console.log('ðŸ†” Initializing with Session ID:', userSession.id);
            
            // Initialize analysis persistence with session isolation
            if (window.initAnalysisPersistence) {
                window.initAnalysisPersistence(userSession.id);
            }
            
            console.log('DEBUG: JavaScript loaded successfully to line 2208');
            try {
                initWebSocket();
                console.log('DEBUG: WebSocket initialization completed');
                setupEventListeners();
                console.log('DEBUG: Event listeners setup completed');
                console.log('DEBUG: Initialization completed');
            } catch (error) {
                console.error('DEBUG: Error during initialization:', error);
                console.error('DEBUG: Error stack:', error.stack);
            }
        });

        // Enhanced WebSocket Connection with dynamic port detection
        function initWebSocket() {
            // Use the same port as the current page
            const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = wsProtocol + '//' + window.location.hostname + ':' + currentPort + '/ws/professional';
            console.log('ðŸ”— Connecting to: ' + wsUrl + ' (auto-detected port: ' + currentPort + ')');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('âœ… Professional WebSocket connected');
                console.log('ðŸ†” Session ID:', userSession.id);
                console.log('ðŸ”— Connection ID:', userSession.connectionId);
                
                // Send session info to server for isolation
                ws.send(JSON.stringify({
                    type: 'session_init',
                    data: {
                        session_id: userSession.id,
                        connection_id: userSession.connectionId,
                        start_time: userSession.startTime,
                        user_agent: userSession.userAgent,
                        client_info: {
                            timestamp: Date.now(),
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            language: navigator.language
                        }
                    }
                }));
                
                updateConnectionStatus('Connected');
                updateApiStatus('ready');
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleAnalysisMessage(message);
                } catch (error) {
                    console.error('âŒ Error parsing message:', error);
                }
            };
            
            ws.onerror = function(error) {
                console.error('âŒ WebSocket error:', error);
                updateConnectionStatus('Connection Error');
                updateApiStatus('error');
                
                // User notification about WebSocket connection error
                showUserDebugError('WebSocket Connection Error', 
                    'Lost connection to the analysis backend server.',
                    [
                        'Check if the backend server is running',
                        'Verify network connectivity',
                        'Check browser console for detailed error messages',
                        'Try refreshing the page to reconnect',
                        'If problem persists, restart the backend server'
                    ]
                );
            };
            
            ws.onclose = function() {
                console.log('âŒ Connection closed, reconnecting...');
                updateConnectionStatus('Reconnecting...');
                
                // User notification about connection closure with reconnection info
                showUserDebugWarning('Connection Lost', 
                    'WebSocket connection closed. Attempting automatic reconnection in 3 seconds.'
                );
                
                setTimeout(initWebSocket, 3000);
            };
        }

        // Enhanced Project Setup with Stock Data - DEBUG VERSION
        console.log('ðŸ”§ DEBUG: About to define setupInvestmentProject function');
        
        async function setupInvestmentProject() {
            console.log('DEBUG: setupInvestmentProject function called');
            console.log('DEBUG: Function definition reached successfully');
            const company = document.getElementById('companyInput').value.trim();
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            const query = document.getElementById('queryInput').value.trim();

            if (!company || !ticker) {
                alert('Please enter both company name and ticker symbol');
                return;
            }

            // Show loading state
            const setupButton = document.querySelector('.setup-button');
            const originalButtonContent = setupButton.innerHTML;
            setupButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching Stock Data...';
            setupButton.disabled = true;

            try {
                // Fetch stock data using relative URL (automatically uses current server port)
                const response = await fetch('/api/stock/' + ticker);
                const stockData = await response.json();
                
                // Collect simplified context data
                const dataSources = {
                    dataSources: document.getElementById('dataSourcesInput').value.trim(),
                    keyInformation: document.getElementById('keyInformationInput').value.trim(),
                    investmentContext: document.getElementById('investmentContextInput').value.trim()
                };
                
                console.log('ðŸ” FRONTEND DEBUG: Context collected from form:', dataSources);

                // Check if context was already saved
                const existingContext = localStorage.getItem('robecoDataSources_' + ticker);
                const savedContext = existingContext ? JSON.parse(existingContext) : dataSources;
                
                currentProject = {
                    company: company,
                    ticker: ticker,
                    query: query,
                    stockData: stockData,
                    dataSources: savedContext,
                    timestamp: new Date().toISOString()
                };
                
                console.log('ðŸ”¥ FRONTEND DEBUG: PROJECT CREATED WITH CONTEXT:', savedContext);
                console.log('ðŸ” FRONTEND DEBUG: Full currentProject:', currentProject);
                
                // Enable analyst cards
                document.querySelectorAll('.analyst-card').forEach(card => {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                });

                // Update welcome screen
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('analysisDisplay').style.display = 'block';
                
                // Show enhanced project initialization display
                displayEnhancedProjectInitialization(currentProject);
                
            } catch (error) {
                console.error('Error fetching stock data:', error);
                
                // Check if context was already saved (fallback case)
                const existingContext = localStorage.getItem('robecoDataSources_' + ticker);
                const dataSources = {
                    dataSources: document.getElementById('dataSourcesInput').value.trim(),
                    keyInformation: document.getElementById('keyInformationInput').value.trim(),
                    investmentContext: document.getElementById('investmentContextInput').value.trim()
                };
                const savedContext = existingContext ? JSON.parse(existingContext) : dataSources;

                currentProject = {
                    company: company,
                    ticker: ticker,
                    query: query,
                    dataSources: savedContext,
                    timestamp: new Date().toISOString()
                };
                
                console.log('ðŸ”¥ FALLBACK PROJECT WITH CONTEXT:', savedContext);
                
                displayBasicProjectInitialization(currentProject);
            } finally {
                // Restore button state
                setupButton.innerHTML = originalButtonContent;
                setupButton.disabled = false;
            }
        }



        function displayEnhancedProjectInitialization(project) {
            console.log('DEBUG: displayEnhancedProjectInitialization called');
            console.log('DEBUG: Project data:', project);
            const stockData = project.stockData;
            
            updateAnalysisTitle(project.company + ' (' + project.ticker + ') - Ready for Analysis');
            
            let stockInfoHtml = '';
            console.log('DEBUG: Starting HTML string concatenation');
            if (stockData && stockData.success) {
                const changeColor = stockData.price_change >= 0 ? '#48bb78' : '#f56565';
                const changeIcon = stockData.price_change >= 0 ? 'â†—ï¸' : 'â†˜ï¸';
                
                // Stock Price Chart First
                stockInfoHtml = '<div class="stock-chart-container" style="background: linear-gradient(135deg, #fafbfc 0%, #ffffff 100%); border-radius: 20px; padding: 32px; margin: 24px 0; box-shadow: 0 8px 30px rgba(0, 31, 63, 0.06); border: none; position: relative; overflow: hidden;">' +
                    '<div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--robeco-blue), var(--robeco-orange), #48bb78);"></div>' +
                    '<div class="chart-header">' +
                        '<div class="chart-title">ðŸ“ˆ ' + (stockData.company_name || project.company) + ' - 5 Year Price History</div>' +
                        '<div class="chart-period">Monthly Data â€¢ ' + (stockData.chart_data_points || 0) + ' Points</div>' +
                    '</div>' +
                    '<canvas id="stockChart" class="stock-chart-canvas"></canvas>' +
                '</div>' +
                
                // Basic stock information 
                '<div style="background: linear-gradient(135deg, var(--robeco-blue-alpha-05), var(--robeco-orange-alpha-05)); border-radius: 20px; padding: 32px; margin: 24px 0; box-shadow: 0 8px 32px rgba(15, 55, 102, 0.12), 0 2px 8px rgba(15, 55, 102, 0.08);">' +
                    '<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px; align-items: flex-start;">' +
                        '<div>' +
                            '<h2 style="color: var(--robeco-navy); font-size: 28px; margin: 0 0 8px 0; font-weight: 700;">' +
                                (stockData.company_name || project.company) +
                            '</h2>' +
                            '<div style="color: var(--text-secondary); font-size: 16px; margin-bottom: 16px;">' +
                                stockData.ticker + ' â€¢ ' + (stockData.exchange || 'Exchange') + ' â€¢ ' + (stockData.sector || 'Sector') + ' â€¢ ' + (stockData.country || 'Country') +
                            '</div>' +
                            '<div style="display: flex; gap: 24px; align-items: center; margin-bottom: 20px;">' +
                                '<div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 20px; border-radius: 16px; box-shadow: 0 6px 25px rgba(0, 31, 63, 0.08); border: none;">' +
                                    '<div style="font-size: 32px; font-weight: 700; color: var(--robeco-navy); margin-bottom: 4px;">' +
                                        (stockData.currency || '$') + stockData.current_price +
                                    '</div>' +
                                    '<div style="font-size: 16px; color: ' + changeColor + '; font-weight: 600;">' +
                                        changeIcon + ' ' + (stockData.price_change > 0 ? '+' : '') + stockData.price_change + ' (' + (stockData.price_change_pct > 0 ? '+' : '') + stockData.price_change_pct + '%)' +
                                    '</div>' +
                                    '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">' +
                                        'Day Range: ' + (stockData.day_range || 'N/A') +
                                    '</div>' +
                                '</div>' +
                                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 13px;">' +
                                    '<div><strong>Market Cap:</strong><br>' + formatNumber(stockData.market_cap) + '</div>' +
                                    '<div><strong>Enterprise Value:</strong><br>' + formatNumber(stockData.enterprise_value) + '</div>' +
                                    '<div><strong>Volume:</strong><br>' + formatNumber(stockData.volume, false) + '</div>' +
                                    '<div><strong>Avg Volume:</strong><br>' + formatNumber(stockData.avg_volume, false) + '</div>' +
                                '</div>' +
                            '</div>';
            
            // Add analyst recommendation if available
            if (stockData.recommendation_key) {
                const rating = stockData.recommendation_mean ? '(' + stockData.recommendation_mean.toFixed(1) + '/5.0)' : '';
                const currency = stockData.currency || '$';
                const targetRange = stockData.target_high_price && stockData.target_low_price ? 
                    ' (' + currency + stockData.target_low_price.toFixed(2) + ' - ' + currency + stockData.target_high_price.toFixed(2) + ')' : '';
                const targetPrice = stockData.target_mean_price ? stockData.target_mean_price.toFixed(2) : 'N/A';
                
                stockInfoHtml += '<div style="background: rgba(72, 187, 120, 0.1); padding: 16px 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(72, 187, 120, 0.15);">' +
                    '<div style="font-size: 14px; font-weight: 600; color: #48bb78; margin-bottom: 4px;">' +
                        'ðŸ“Š Analyst Consensus: ' + stockData.recommendation_key.toUpperCase() + ' ' + rating +
                    '</div>' +
                    '<div style="font-size: 12px; color: var(--text-secondary);">' +
                        (stockData.number_of_analyst_opinions || 0) + ' analysts â€¢ Target: ' + currency + targetPrice + targetRange +
                    '</div>' +
                '</div>';
            }
            
            // Complete the header section
            stockInfoHtml += '</div>' +
                '<div style="text-align: center;">' +
                    '<div style="background: var(--gradient-primary); color: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow-elevated); margin-bottom: 16px;">' +
                        '<i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 12px;"></i>' +
                        '<div style="font-size: 18px; font-weight: 600;">Ready for Analysis</div>' +
                    '</div>';
            
            if (stockData.website) {
                stockInfoHtml += '<a href="' + stockData.website + '" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; color: var(--robeco-blue); text-decoration: none; font-size: 13px; font-weight: 500;">' +
                    '<i class="fas fa-external-link-alt"></i> Company Website' +
                '</a>';
            }
            
            stockInfoHtml += '</div>' +
            '</div>' +
        '</div>';

// Comprehensive Financial Metrics - Single Row Layout
const gridCols = stockData.dividend_yield ? 'repeat(4, 1fr)' : 'repeat(3, 1fr)';
stockInfoHtml += '<div style="display: grid; grid-template-columns: ' + gridCols + '; gap: 16px; margin: 32px 0;">' +
    // Valuation Metrics
    '<div style="background: rgba(248, 250, 252, 0.8); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0, 31, 63, 0.05);">' +
        '<h4 style="color: var(--robeco-navy); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 6px; font-weight: 600;">' +
            '<i class="fas fa-calculator" style="color: var(--robeco-blue);"></i> Valuation Metrics' +
        '</h4>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">' +
            '<div style="padding: 6px 0;"><strong>P/E Ratio:</strong><br><span style="color: var(--robeco-blue); font-weight: 600;">' + (stockData.pe_ratio ? stockData.pe_ratio.toFixed(2) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Forward P/E:</strong><br><span style="color: var(--robeco-blue); font-weight: 600;">' + (stockData.forward_pe ? stockData.forward_pe.toFixed(2) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>PEG Ratio:</strong><br><span style="color: var(--robeco-blue); font-weight: 600;">' + (stockData.peg_ratio ? stockData.peg_ratio.toFixed(2) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>P/B Ratio:</strong><br><span style="color: var(--robeco-blue); font-weight: 600;">' + (stockData.price_to_book ? stockData.price_to_book.toFixed(2) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>P/S Ratio:</strong><br><span style="color: var(--robeco-blue); font-weight: 600;">' + (stockData.price_to_sales ? stockData.price_to_sales.toFixed(2) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>EV/EBITDA:</strong><br><span style="color: var(--robeco-blue); font-weight: 600;">' + (stockData.enterprise_to_ebitda ? stockData.enterprise_to_ebitda.toFixed(2) : 'N/A') + '</span></div>' +
        '</div>' +
    '</div>';
    
    // Dividend Information
    stockInfoHtml += (stockData.dividend_yield ? 
    '<div style="background: rgba(254, 243, 199, 0.6); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(251, 146, 60, 0.05);">' +
        '<h4 style="color: var(--robeco-navy); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 6px; font-weight: 600;">' +
            '<i class="fas fa-coins" style="color: var(--robeco-orange);"></i> Dividend Information' +
        '</h4>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">' +
            '<div style="padding: 6px 0;"><strong>Div Yield:</strong><br><span style="color: var(--robeco-orange); font-weight: 600;">' + (stockData.dividend_yield * 100).toFixed(2) + '%</span></div>' +
            '<div style="padding: 6px 0;"><strong>Annual Rate:</strong><br><span style="color: var(--robeco-orange); font-weight: 600;">' + (stockData.currency || '$') + (stockData.trailing_annual_dividend_rate ? stockData.trailing_annual_dividend_rate.toFixed(3) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Payout Ratio:</strong><br><span style="color: var(--robeco-orange); font-weight: 600;">' + (stockData.payout_ratio ? (stockData.payout_ratio * 100).toFixed(1) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>5Y Avg Yield:</strong><br><span style="color: var(--robeco-orange); font-weight: 600;">' + (stockData.five_year_avg_dividend_yield ? stockData.five_year_avg_dividend_yield.toFixed(2) + '%' : 'N/A') + '</span></div>' +
        '</div>' +
    '</div>' : '');
    
    // Financial Health
    stockInfoHtml += '<div style="background: rgba(240, 253, 244, 0.7); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(72, 187, 120, 0.05);">' +
        '<h4 style="color: var(--robeco-navy); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 6px; font-weight: 600;">' +
            '<i class="fas fa-heart-pulse" style="color: #48bb78;"></i> Financial Health' +
        '</h4>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">' +
            '<div style="padding: 6px 0;"><strong>ROE:</strong><br><span style="color: #48bb78; font-weight: 600;">' + (stockData.return_on_equity ? (stockData.return_on_equity * 100).toFixed(2) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>ROA:</strong><br><span style="color: #48bb78; font-weight: 600;">' + (stockData.return_on_assets ? (stockData.return_on_assets * 100).toFixed(2) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Profit Margin:</strong><br><span style="color: #48bb78; font-weight: 600;">' + (stockData.profit_margins ? (stockData.profit_margins * 100).toFixed(2) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Op Margin:</strong><br><span style="color: #48bb78; font-weight: 600;">' + (stockData.operating_margins ? (stockData.operating_margins * 100).toFixed(2) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Current Ratio:</strong><br><span style="color: #48bb78; font-weight: 600;">' + (stockData.current_ratio ? stockData.current_ratio.toFixed(2) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Debt/Equity:</strong><br><span style="color: #48bb78; font-weight: 600;">' + (stockData.debt_to_equity ? stockData.debt_to_equity.toFixed(2) : 'N/A') + '</span></div>' +
        '</div>' +
    '</div>' +
    
    // Growth & Performance
    '<div style="background: rgba(248, 250, 252, 0.8); border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(99, 102, 241, 0.05);">' +
        '<h4 style="color: var(--robeco-navy); margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 6px; font-weight: 600;">' +
            '<i class="fas fa-trending-up" style="color: #6366f1;"></i> Growth & Performance' +
        '</h4>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">' +
            '<div style="padding: 6px 0;"><strong>Revenue Growth:</strong><br><span style="color: #6366f1; font-weight: 600;">' + (stockData.revenue_growth ? (stockData.revenue_growth * 100).toFixed(2) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Earnings Growth:</strong><br><span style="color: #6366f1; font-weight: 600;">' + (stockData.earnings_growth ? (stockData.earnings_growth * 100).toFixed(2) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>52W Change:</strong><br><span style="color: #6366f1; font-weight: 600;">' + (stockData.week_52_change ? (stockData.week_52_change * 100).toFixed(2) + '%' : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>Beta:</strong><br><span style="color: #6366f1; font-weight: 600;">' + (stockData.beta ? stockData.beta.toFixed(2) : 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>52W High:</strong><br><span style="color: #6366f1; font-weight: 600;">' + (stockData.currency || '$') + (stockData.week_52_high || 'N/A') + '</span></div>' +
            '<div style="padding: 6px 0;"><strong>52W Low:</strong><br><span style="color: #6366f1; font-weight: 600;">' + (stockData.currency || '$') + (stockData.week_52_low || 'N/A') + '</span></div>' +
        '</div>' +
    '</div>' +
'</div>';

// Business Summary  
stockInfoHtml += (stockData.business_summary ? 
'<div style="background: linear-gradient(135deg, #f1f5f9 0%, #ffffff 100%); border-radius: 20px; padding: 32px; margin: 32px 0; box-shadow: 0 6px 25px rgba(99, 102, 241, 0.1); border: none; position: relative; overflow: hidden;">' +
    '<div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(135deg, #6366f1, #8b5cf6);"></div>' +
    '<h4 style="color: var(--robeco-navy); margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">' +
        '<i class="fas fa-building"></i> Company Overview' +
    '</h4>' +
    '<p style="color: var(--text-primary); font-size: 14px; line-height: 1.6; margin: 0; text-align: justify;">' +
        stockData.business_summary +
    '</p>' +
'</div>' : '');

// Chart already added at the beginning
            } else {
                stockInfoHtml = '<div style="background: var(--bg-accent); border: 2px solid var(--robeco-blue-alpha-20); border-radius: 16px; padding: 24px; margin: 24px 0; text-align: center;">' +
                    '<h2 style="color: var(--robeco-navy); margin: 0 0 8px 0;">' + project.company + ' (' + project.ticker + ')</h2>' +
                    '<p style="color: var(--text-secondary); margin: 0;">Stock data loading - Analysis ready to proceed</p>' +
                '</div>';
            }

            const enhancedInstructions = '<div style="max-width: 1000px; margin: 0 auto;">' +
                '<div style="text-align: center; margin-bottom: 32px;">' +
                    '<h1 style="color: var(--robeco-navy); font-size: 36px; margin: 0 0 16px 0; font-weight: 800;">' +
                        'ðŸŽ¯ Investment Analysis Ready' +
                    '</h1>' +
                    '<p style="color: var(--text-secondary); font-size: 18px; margin: 0;">' +
                        'Select analysts to begin comprehensive research' +
                    '</p>' +
                '</div>' +
                stockInfoHtml +
                '<div style="background: white; border-radius: 16px; padding: 32px; margin: 32px 0; box-shadow: var(--shadow-elevated);">' +
                    '<h3 style="color: var(--robeco-blue); margin: 0 0 24px 0; font-size: 24px; font-weight: 700;">' +
                        'ðŸš€ Next Steps: Choose Your Analysts' +
                    '</h3>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">' +
                        '<div style="background: var(--robeco-blue-alpha-05); padding: 24px; border-radius: 16px; box-shadow: 0 4px 16px rgba(15, 55, 102, 0.08);">' +
                            '<h4 style="color: var(--robeco-navy); margin: 0 0 12px 0;">ðŸ“Š Available Analysts</h4>' +
                            '<ul style="margin: 0; padding-left: 20px; color: var(--text-primary);">' +
                                '<li><strong>Industry Analysis</strong> - Market positioning & competition</li>' +
                                '<li><strong>Fundamentals</strong> - Financial performance & metrics</li>' +
                                '<li><strong>Technical Analysis</strong> - Chart patterns & price trends</li>' +
                                '<li><strong>Risk Assessment</strong> - Risk factors & scenarios</li>' +
                                '<li><strong>ESG Analysis</strong> - Sustainability & governance</li>' +
                                '<li><strong>Valuation</strong> - Fair value & price targets</li>' +
                            '</ul>' +
                        '</div>' +
                        '<div style="background: var(--robeco-orange-alpha-05); padding: 24px; border-radius: 16px; box-shadow: 0 4px 16px rgba(233, 105, 44, 0.08);">' +
                            '<h4 style="color: var(--robeco-navy); margin: 0 0 12px 0;">ðŸ’¡ How It Works</h4>' +
                            '<ol style="margin: 0; padding-left: 20px; color: var(--text-primary);">' +
                                '<li>Click any analyst in the sidebar</li>' +
                                '<li>Watch real-time analysis generation</li>' +
                                '<li>Use chat for follow-up questions</li>' +
                                '<li>Run multiple analysts for full coverage</li>' +
                            '</ol>' +
                        '</div>' +
                    '</div>' +
                    '<div style="background: var(--gradient-primary); color: white; padding: 24px; border-radius: 12px; text-align: center;">' +
                        '<i class="fas fa-rocket" style="font-size: 32px; margin-bottom: 16px;"></i>' +
                        '<h3 style="margin: 0 0 8px 0; font-size: 20px;">Ready for Analysis</h3>' +
                        '<p style="margin: 0; opacity: 0.9;">Click any analyst to begin comprehensive investment research</p>' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            document.getElementById('defaultContent').innerHTML = enhancedInstructions;
            
            // Initialize stock chart if we have chart data
            if (stockData && stockData.chart_data && stockData.chart_data.length > 0) {
                setTimeout(function() {
                    initializeStockChart(stockData);
                }, 100);
            }
        }

        function displayBasicProjectInitialization(project) {
            updateAnalysisTitle(project.company + ' (' + project.ticker + ') - Ready for Analysis');
            
            const basicInstructions = '<div style="text-align: center; padding: 40px;">' +
                '<h1 style="color: var(--robeco-navy); font-size: 32px; margin-bottom: 16px;">ðŸŽ¯ Project Initialized</h1>' +
                '<h2 style="color: var(--robeco-blue); margin-bottom: 32px;">' + project.company + ' (' + project.ticker + ')</h2>' +
                '<p style="color: var(--text-primary); font-size: 18px;">Select any specialist analyst to begin comprehensive analysis</p>' +
            '</div>';
            
            document.getElementById('defaultContent').innerHTML = basicInstructions;
        }

        function formatNumber(num, isCurrency = true) {
            if (!num) return 'N/A';
            const prefix = isCurrency ? '$' : '';
            if (num >= 1e12) return prefix + (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return prefix + (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return prefix + (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return prefix + (num / 1e3).toFixed(2) + 'K';
            return prefix + num.toLocaleString();
        }

        // Initialize Stock Price Chart
        function initializeStockChart(stockData) {
            const ctx = document.getElementById('stockChart');
            if (!ctx) {
                console.error('Stock chart canvas not found');
                return;
            }

            // Prepare chart data
            const chartData = stockData.chart_data.map(point => ({
                x: new Date(point.date),
                y: point.close
            }));

            // Create gradient
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 102, 204, 0.3)');
            gradient.addColorStop(1, 'rgba(0, 102, 204, 0.05)');

            // Determine if stock is up or down overall
            const firstPrice = stockData.chart_data[0]?.close || 0;
            const lastPrice = stockData.chart_data[stockData.chart_data.length - 1]?.close || 0;
            const isUp = lastPrice >= firstPrice;
            const lineColor = isUp ? '#48bb78' : '#f56565';

            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: stockData.company_name + ' Price',
                        data: chartData,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: lineColor,
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1a202c',
                            bodyColor: '#4a5568',
                            borderColor: 'rgba(0, 102, 204, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('en-US', { 
                                        year: 'numeric', 
                                        month: 'long' 
                                    });
                                },
                                label: function(context) {
                                    return (stockData.currency || '$') + context.parsed.y.toFixed(4);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: '5-Year Period',
                                color: '#718096',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 102, 204, 0.1)',
                                drawTicks: false
                            },
                            ticks: {
                                color: '#718096',
                                font: {
                                    size: 11
                                },
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (' + (stockData.currency || '$') + '),',
                                color: '#718096',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 102, 204, 0.1)',
                                drawTicks: false
                            },
                            ticks: {
                                color: '#718096',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return (stockData.currency || '$') + value.toFixed(2);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });

            console.log('ðŸ“ˆ Stock chart initialized for ' + stockData.company_name + ' with ' + chartData.length + ' data points');
        }

        // Page Switching Functions
        function switchToAnalystPage(analystType) {
            // Hide all analyst pages
            const allPages = document.querySelectorAll('.analyst-page');
            allPages.forEach(page => page.style.display = 'none');
            
            // Show the selected analyst page
            const targetPage = document.getElementById(analystType + 'Page');
            if (targetPage) {
                targetPage.style.display = 'block';
                console.log('ðŸ“„ Switched to ' + analystType + ' page');
            } else {
                // Fallback to default page if analyst page not found
                document.getElementById('defaultPage').style.display = 'block';
                console.log('âš ï¸ ' + analystType + ' page not found, showing default');
            }
        }

        function getAnalystContentId(analystType) {
            return analystType + 'Content';
        }

        function getAnalystSourcesId(analystType) {
            return analystType + 'Sources';
        }

        function getAnalystSourcesGridId(analystType) {
            return analystType + 'SourcesGrid';
        }

        // Bulk File Upload Functions
        let currentBulkSession = null;
        
        // Enable/disable bulk upload button based on file selection
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('bulkFileInput');
            const uploadButton = document.getElementById('bulkUploadButton');
            
            if (fileInput && uploadButton) {
                fileInput.addEventListener('change', function() {
                    uploadButton.disabled = this.files.length === 0;
                });
            }
        });
        
        async function startBulkUpload() {
            console.log('ðŸš€ BULK UPLOAD STARTED');
            
            const fileInput = document.getElementById('bulkFileInput');
            const uploadButton = document.getElementById('bulkUploadButton');
            const progressDiv = document.getElementById('bulkUploadProgress');
            const progressFill = document.getElementById('bulkProgressFill');
            const progressText = document.getElementById('bulkProgressText');
            
            console.log('ðŸ“‚ File input:', fileInput ? (fileInput.files.length + ' files selected') : 'NOT FOUND');
            console.log('ðŸŽ¯ Current project:', currentProject ? (currentProject.company + ' (' + currentProject.ticker + ')') : 'NOT SET');
            console.log('ðŸ”Œ WebSocket status:', ws ? ws.readyState : 'NOT CONNECTED');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                console.error('âŒ No files selected');
                alert('Please select files to upload');
                return;
            }
            
            if (!currentProject) {
                console.error('âŒ No project setup');
                alert('Please setup a project first');
                return;
            }
            
            // Validate file count
            if (fileInput.files.length > 10) {
                console.error('âŒ Too many files:', fileInput.files.length);
                alert('Maximum 10 files allowed per upload');
                return;
            }
            
            // Check WebSocket connection
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('âŒ WebSocket not connected. State:', ws ? ws.readyState : 'NULL');
                console.error('âŒ WebSocket states: CONNECTING=0, OPEN=1, CLOSING=2, CLOSED=3');
                
                showUserDebugError('WebSocket Connection Required', 
                    'Cannot upload files because WebSocket connection is not established.',
                    [
                        'Refresh the page to re-establish connection',
                        'Check if backend server is running',
                        'Wait a few seconds for automatic reconnection',
                        'Check browser console for WebSocket connection details'
                    ]
                );
                return;
            }
            
            console.log('âœ… All validations passed. Starting upload process...');
            
            // Show progress
            progressDiv.style.display = 'block';
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            progressFill.style.width = '10%';
            progressText.textContent = 'Preparing files for upload...';
            
            try {
                console.log('ðŸ“ Processing', fileInput.files.length, 'files for WebSocket transmission...');
                
                // Prepare files data for WebSocket transmission
                const filesData = [];
                
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    console.log('ðŸ“„ Processing file ' + (i + 1) + ':', {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: new Date(file.lastModified).toISOString()
                    });
                    
                    // Convert file to base64
                    console.log('ðŸ”„ Converting file ' + (i + 1) + ' to base64...');
                    const fileContent = await fileToBase64(file);
                    console.log('âœ… File ' + (i + 1) + ' converted. Base64 length:', fileContent.length);
                    
                    filesData.push({
                        filename: file.name,
                        content: fileContent,
                        size: file.size,
                        type: file.type
                    });
                    
                    // Update progress
                    const fileProgress = 10 + (i / fileInput.files.length) * 20;
                    progressFill.style.width = fileProgress + '%';
                    progressText.textContent = 'Preparing files... (' + (i + 1) + '/' + fileInput.files.length + ')';
                    
                    // Small delay for UI updates
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('ðŸ“¦ Files prepared for transmission:', {
                    totalFiles: filesData.length,
                    totalDataSize: filesData.reduce((acc, f) => acc + f.content.length, 0),
                    filenames: filesData.map(f => f.filename)
                });
                
                progressFill.style.width = '30%';
                progressText.textContent = 'Starting AI analysis...';
                
                // Initialize streaming analysis display
                console.log('ðŸŽ¬ Initializing bulk analysis display...');
                initializeBulkAnalysisDisplay();
                
                // Prepare WebSocket message
                const wsMessage = {
                    type: 'start_bulk_analysis',
                    files_data: filesData,
                    company_ticker: currentProject.ticker
                };
                
                console.log('ðŸ“¡ Sending WebSocket message:', {
                    type: wsMessage.type,
                    company_ticker: wsMessage.company_ticker,
                    files_count: wsMessage.files_data.length,
                    message_size: JSON.stringify(wsMessage).length
                });
                
                // Send via WebSocket for real-time streaming
                ws.send(JSON.stringify(wsMessage));
                console.log('âœ… WebSocket message sent successfully');
                
            } catch (error) {
                console.error('Bulk upload error:', error);
                
                showUserDebugError('Bulk Upload Failed', 
                    'File upload encountered an error: ' + error.message,
                    [
                        'Check if files are valid and not corrupted',
                        'Ensure files are not too large (max 10MB each)',
                        'Verify WebSocket connection is stable',
                        'Try uploading fewer files at once',
                        'Check browser console for detailed error information'
                    ]
                );
                
                progressDiv.style.display = 'none';
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<i class="fas fa-file-upload"></i> Analyze Documents';
            }
        }
        
        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove data URL prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        // Initialize real-time analysis display
        function initializeBulkAnalysisDisplay() {
            // Switch to analysis display
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('analysisDisplay').style.display = 'block';
            
            updateAnalysisTitle('ðŸ“„ Real-Time Document Analysis - ' + currentProject.company + ' (' + currentProject.ticker + ')');
            
            // Create streaming analysis container
            const streamingHtml = "" +
                "<div class=\"bulk-streaming-container\" style=\"max-width: 100%; margin: 0 auto;\">" +
                    "<div class=\"streaming-header\" style=\"background: linear-gradient(135deg, var(--robeco-blue-alpha-05), var(--robeco-orange-alpha-05)); border-radius: 20px; padding: 32px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(15, 55, 102, 0.12); text-align: center;\">" +
                        "<h2 style=\"color: var(--robeco-navy); margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 12px;\">" +
                            "<i class=\"fas fa-robot\" style=\"color: var(--robeco-blue); animation: pulse 2s infinite;\"></i>" +
                            "AI Document Analysis in Progress" +
                        "</h2>" +
                        "<div id=\"streamingStatus\" style=\"color: var(--text-secondary); font-size: 16px; margin-bottom: 20px;\">" +
                            "Initializing AI analysis engine..." +
                        "</div>" +
                        "<div class=\"streaming-progress\" style=\"background: white; border-radius: 12px; padding: 12px; margin: 0 auto; max-width: 400px;\">" +
                            "<div class=\"progress-bar\">" +
                                "<div class=\"progress-fill\" id=\"streamingProgressFill\" style=\"width: 0%;\"></div>" +
                            "</div>" +
                            "<div class=\"progress-text\" id=\"streamingProgressText\" style=\"margin-top: 8px; font-size: 14px;\">Starting...</div>" +
                        "</div>" +
                    "</div>" +
                    "" +
                    "<div class=\"streaming-content\" style=\"background: white; border-radius: 20px; padding: 32px; box-shadow: 0 8px 32px rgba(15, 55, 102, 0.12); min-height: 400px;\">" +
                        "<div class=\"analysis-output\" id=\"streamingAnalysisOutput\" style=\"font-family: 'Inter', sans-serif; line-height: 1.7; color: var(--text-primary); white-space: pre-wrap; font-size: 15px;\">" +
                            "<div style=\"text-align: center; color: var(--text-muted); font-style: italic; padding: 40px;\">" +
                                "<i class=\"fas fa-hourglass-half\" style=\"font-size: 24px; margin-bottom: 16px; display: block;\"></i>" +
                                "Waiting for AI analysis to begin..." +
                            "</div>" +
                        "</div>" +
                    "</div>" +
                    "" +
                    "<div class=\"streaming-footer\" style=\"text-align: center; margin-top: 24px; color: var(--text-muted); font-size: 14px;\">" +
                        "<i class=\"fas fa-info-circle\"></i> Analysis results will appear here in real-time as the AI processes your documents" +
                    "</div>" +
                "</div>" +
                "" +
                "<style>" +
                    "@keyframes pulse {" +
                        "0% { opacity: 1; }" +
                        "50% { opacity: 0.5; }" +
                        "100% { opacity: 1; }" +
                    "}" +
                    "" +
                    ".streaming-content {" +
                        "position: relative;" +
                    "}" +
                    "" +
                    ".streaming-content::before {" +
                        "content: '';" +
                        "position: absolute;" +
                        "top: 0;" +
                        "left: 0;" +
                        "right: 0;" +
                        "height: 4px;" +
                        "background: linear-gradient(90deg, var(--robeco-blue), var(--robeco-orange), #48bb78);" +
                        "border-radius: 20px 20px 0 0;" +
                    "}" +
                    "" +
                    ".analysis-output {" +
                        "max-height: 600px;" +
                        "overflow-y: auto;" +
                        "scrollbar-width: thin;" +
                        "scrollbar-color: var(--robeco-blue-alpha-20) transparent;" +
                    "}" +
                    "" +
                    ".analysis-output::-webkit-scrollbar {" +
                        "width: 6px;" +
                    "}" +
                    "" +
                    ".analysis-output::-webkit-scrollbar-track {" +
                        "background: transparent;" +
                    "}" +
                    "" +
                    ".analysis-output::-webkit-scrollbar-thumb {" +
                        "background: var(--robeco-blue-alpha-20);" +
                        "border-radius: 3px;" +
                    "}" +
                "</style>";
            
            document.getElementById('defaultContent').innerHTML = streamingHtml;
        }
        
        // Bulk Analysis Streaming Handlers
        function handleBulkAnalysisInitiated(data) {
            console.log('ðŸ“‚ Bulk analysis initiated:', data);
            
            const progressFill = document.getElementById('bulkProgressFill');
            const progressText = document.getElementById('bulkProgressText');
            const streamingStatus = document.getElementById('streamingStatus');
            const streamingProgressFill = document.getElementById('streamingProgressFill');
            const streamingProgressText = document.getElementById('streamingProgressText');
            
            // Update sidebar progress
            if (progressFill && progressText) {
                progressFill.style.width = '40%';
                progressText.textContent = 'Connected to AI analysis engine...';
            }
            
            // Update main streaming display
            if (streamingStatus) streamingStatus.textContent = "Connected! Analyzing " + data.file_count + " documents for " + data.company_ticker;
            if (streamingProgressFill) streamingProgressFill.style.width = '20%';
            if (streamingProgressText) streamingProgressText.textContent = 'Analysis engine connected...';
        }
        
        function handleBulkAnalysisStarted(data) {
            console.log('ðŸ¤– Bulk analysis started:', data);
            
            const streamingStatus = document.getElementById('streamingStatus');
            const streamingProgressFill = document.getElementById('streamingProgressFill');
            const streamingProgressText = document.getElementById('streamingProgressText');
            const analysisOutput = document.getElementById('streamingAnalysisOutput');
            
            if (streamingStatus) streamingStatus.innerHTML = "<i class=\"fas fa-cogs fa-spin\"></i> " + data.message;
            if (streamingProgressFill) streamingProgressFill.style.width = '30%';
            if (streamingProgressText) streamingProgressText.textContent = "Processing " + data.file_count + " documents...";
            
            if (analysisOutput) {
                analysisOutput.innerHTML = "" +
                    "<div style=\"text-align: center; color: var(--robeco-blue); font-weight: 600; margin-bottom: 24px; padding: 20px; background: var(--robeco-blue-alpha-05); border-radius: 12px;\">" +
                        "<i class=\"fas fa-robot fa-2x\" style=\"margin-bottom: 16px; display: block; animation: pulse 2s infinite;\"></i>" +
                        data.message +
                        "<div style=\"font-size: 14px; color: var(--text-secondary); margin-top: 8px;\">" +
                            "Real-time analysis results will appear below" +
                        "</div>" +
                    "</div>";
            }
        }
        
        function handleBulkAnalysisStatus(data) {
            console.log('ðŸ“Š Bulk analysis status:', data);
            
            const streamingProgressFill = document.getElementById('streamingProgressFill');
            const streamingProgressText = document.getElementById('streamingProgressText');
            
            if (streamingProgressFill) streamingProgressFill.style.width = data.progress + '%';
            if (streamingProgressText) streamingProgressText.textContent = data.message;
        }
        
        let bulkAnalysisContent = '';
        function handleBulkAnalysisChunk(data) {
            console.log('ðŸ”¥ Bulk analysis chunk received:', data.content_chunk.length, 'chars');
            
            const analysisOutput = document.getElementById('streamingAnalysisOutput');
            const streamingProgressFill = document.getElementById('streamingProgressFill');
            const streamingProgressText = document.getElementById('streamingProgressText');
            
            if (data.content_chunk) {
                bulkAnalysisContent += data.content_chunk;
                
                if (analysisOutput) {
                    // Create formatted content with markdown-like styling
                    const formattedContent = formatBulkAnalysisContent(bulkAnalysisContent);
                    analysisOutput.innerHTML = formattedContent;
                    
                    // Auto-scroll to bottom
                    analysisOutput.scrollTop = analysisOutput.scrollHeight;
                }
            }
            
            // Update progress
            if (streamingProgressFill) streamingProgressFill.style.width = data.progress + '%';
            if (streamingProgressText) streamingProgressText.textContent = "Streaming analysis... (" + data.chunk_id + " chunks received)";
        }
        
        function handleBulkAnalysisCompleted(data) {
            console.log('âœ… Bulk analysis completed:', data);
            
            const progressDiv = document.getElementById('bulkUploadProgress');
            const uploadButton = document.getElementById('bulkUploadButton');
            const streamingStatus = document.getElementById('streamingStatus');
            const streamingProgressFill = document.getElementById('streamingProgressFill');
            const streamingProgressText = document.getElementById('streamingProgressText');
            
            // Hide sidebar progress
            if (progressDiv) progressDiv.style.display = 'none';
            
            // Reset upload button
            if (uploadButton) {
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<i class="fas fa-file-upload"></i> Analyze Documents';
                document.getElementById('bulkFileInput').value = '';
                uploadButton.disabled = true; // Keep disabled until new files selected
            }
            
            // Update streaming display
            if (streamingStatus) {
                streamingStatus.innerHTML = "<i class=\"fas fa-check-circle\" style=\"color: #48bb78;\"></i> Analysis completed successfully!";
            }
            if (streamingProgressFill) streamingProgressFill.style.width = '100%';
            if (streamingProgressText) streamingProgressText.textContent = 'Analysis complete';
            
            // Store results for analyst integration
            if (currentProject && data.session_id) {
                currentProject.bulkAnalysisSession = data.session_id;
                currentProject.bulkAnalysisContent = bulkAnalysisContent;
            }
            
            // Add integration note
            const analysisOutput = document.getElementById('streamingAnalysisOutput');
            if (analysisOutput) {
                const currentContent = analysisOutput.innerHTML;
                analysisOutput.innerHTML = currentContent + "" +
                    "<div style=\"margin-top: 32px; padding: 24px; background: var(--bg-accent); border-radius: 12px; text-align: center;\">" +
                        "<h4 style=\"color: var(--robeco-blue); margin-bottom: 12px;\">" +
                            "<i class=\"fas fa-lightbulb\"></i> Analysis Complete - Ready for Specialist Reviews" +
                        "</h4>" +
                        "<p style=\"color: var(--text-secondary); margin-bottom: 16px;\">" +
                            "This document analysis has been saved and will be available as additional context when you run individual analyst reports." +
                        "</p>" +
                        "<div style=\"display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;\">" +
                            "<button onclick=\"handleAnalystClick('fundamentals')\" class=\"integration-button\" style=\"background: var(--robeco-blue); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;\">" +
                                "<i class=\"fas fa-chart-bar\"></i> Run Fundamentals Analysis" +
                            "</button>" +
                            "<button onclick=\"handleAnalystClick('valuation')\" class=\"integration-button\" style=\"background: var(--robeco-orange); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;\">" +
                                "<i class=\"fas fa-calculator\"></i> Run Valuation Analysis" +
                            "</button>" +
                            "<button onclick=\"handleAnalystClick('risk')\" class=\"integration-button\" style=\"background: var(--investment-error); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;\">" +
                                "<i class=\"fas fa-shield-alt\"></i> Run Risk Analysis" +
                            "</button>" +
                        "</div>" +
                    "</div>";
            }
        }
        
        function handleBulkAnalysisError(data) {
            console.error('âŒ Bulk analysis error:', data);
            
            const progressDiv = document.getElementById('bulkUploadProgress');
            const uploadButton = document.getElementById('bulkUploadButton');
            const streamingStatus = document.getElementById('streamingStatus');
            const analysisOutput = document.getElementById('streamingAnalysisOutput');
            
            // Hide progress and reset button
            if (progressDiv) progressDiv.style.display = 'none';
            if (uploadButton) {
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<i class="fas fa-file-upload"></i> Analyze Documents';
            }
            
            // Show error
            if (streamingStatus) {
                streamingStatus.innerHTML = "<i class=\"fas fa-exclamation-triangle\" style=\"color: #f56565;\"></i> Analysis failed";
            }
            
            if (analysisOutput) {
                let errorContent = "" +
                    "<div style=\"text-align: center; color: #f56565; padding: 40px;\">" +
                        "<i class=\"fas fa-exclamation-triangle\" style=\"font-size: 48px; margin-bottom: 16px; display: block;\"></i>" +
                        "<h3 style=\"margin-bottom: 12px;\">Analysis Failed</h3>" +
                        "<p style=\"color: var(--text-secondary); margin-bottom: 20px;\">" + data.error + "</p>";
                
                // Add specific instructions for missing API key
                if (data.error_type === 'missing_api_key') {
                    errorContent += "" +
                        "<div style=\"background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left; color: #856404;\">" +
                            "<h4 style=\"color: #856404; margin-bottom: 12px;\"><i class=\"fas fa-key\"></i> How to Fix This:</h4>" +
                            "<ol style=\"margin: 0; padding-left: 20px;\">" +
                                "<li style=\"margin-bottom: 8px;\">Get a Google Gemini API key from <a href=\"https://aistudio.google.com/app/apikey\" target=\"_blank\" style=\"color: #0066CC;\">Google AI Studio</a></li>" +
                                "<li style=\"margin-bottom: 8px;\">Set the environment variable:<br>" +
                                    "<code style=\"background: #f8f9fa; padding: 4px 8px; border-radius: 4px; font-family: monospace;\">export GEMINI_API_KEY=your_api_key_here</code>" +
                                "</li>" +
                                "<li style=\"margin-bottom: 8px;\">Restart the server</li>" +
                                "<li>Refresh this page</li>" +
                            "</ol>" +
                        "</div>";
                }
                
                errorContent += "" +
                        "<button onclick=\"location.reload()\" style=\"margin-top: 16px; background: var(--robeco-blue); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;\">" +
                            "<i class=\"fas fa-refresh\"></i> Refresh Page" +
                        "</button>" +
                    "</div>";
                
                analysisOutput.innerHTML = errorContent;
            }
            
            alert('Analysis failed: ' + data.error);
        }
        
        // Format bulk analysis content with proper styling
        function formatBulkAnalysisContent(content) {
            if (!content) return '';
            
            // Convert markdown-like formatting to HTML
            let formatted = content
                .replace(/^# (.*$)/gm, '<h1 style="color: var(--robeco-navy); font-size: 24px; margin: 24px 0 16px 0; border-bottom: 2px solid var(--robeco-blue); padding-bottom: 8px;">$1</h1>')
                .replace(/^## (.*$)/gm, '<h2 style="color: var(--robeco-blue); font-size: 20px; margin: 20px 0 12px 0;">$1</h2>')
                .replace(/^### (.*$)/gm, '<h3 style="color: var(--robeco-navy); font-size: 16px; margin: 16px 0 8px 0;">$1</h3>')
                .replace(/^\*\*(.*?)\*\*/gm, '<strong style="color: var(--robeco-navy);">$1</strong>')
                .replace(/^\* (.*$)/gm, '<div style="margin-left: 16px; color: var(--text-secondary);">â€¢ $1</div>')
                .replace(/^- (.*$)/gm, '<div style="margin-left: 16px; color: var(--text-secondary);">â€¢ $1</div>')
                .replace(/\n\n/g, '<br><br>');
            
            return "<div style=\"line-height: 1.7;\">" + formatted + "</div>";
        }
        
        async function pollBulkAnalysisResults(sessionId) {
            const progressFill = document.getElementById('bulkProgressFill');
            const progressText = document.getElementById('bulkProgressText');
            const uploadButton = document.getElementById('bulkUploadButton');
            const progressDiv = document.getElementById('bulkUploadProgress');
            
            let attempts = 0;
            const maxAttempts = 60; // 5 minutes max
            
            const poll = async () => {
                try {
                    const response = await fetch("/api/upload/status/" + sessionId);
                    const status = await response.json();
                    
                    if (!status.success) {
                        throw new Error('Failed to check status');
                    }
                    
                    attempts++;
                    
                    if (status.status === 'completed') {
                        progressFill.style.width = '100%';
                        progressText.textContent = 'Analysis completed! Loading results...';
                        
                        // Get results
                        const resultsResponse = await fetch("/api/upload/results/" + sessionId);
                        const results = await resultsResponse.json();
                        
                        if (results.success) {
                            displayBulkAnalysisResults(results.analysis_results);
                        }
                        
                        // Reset UI
                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                            uploadButton.disabled = false;
                            uploadButton.innerHTML = '<i class="fas fa-file-upload"></i> Analyze Documents';
                            document.getElementById('bulkFileInput').value = '';
                            uploadButton.disabled = true;
                        }, 2000);
                        
                    } else if (status.status === 'failed') {
                        throw new Error(status.error_message || 'Analysis failed');
                        
                    } else if (status.status === 'processing') {
                        const progress = Math.min(50 + (attempts * 2), 90);
                        progressFill.style.width = progress + '%';
                        progressText.textContent = "Processing... (" + status.processed_files + "/" + status.total_files + " files)";
                        
                        if (attempts < maxAttempts) {
                            setTimeout(poll, 5000); // Poll every 5 seconds
                        } else {
                            throw new Error('Analysis timeout');
                        }
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    alert('Analysis failed: ' + error.message);
                    
                    progressDiv.style.display = 'none';
                    uploadButton.disabled = false;
                    uploadButton.innerHTML = '<i class="fas fa-file-upload"></i> Analyze Documents';
                }
            };
            
            poll();
        }
        
        // Toggle file details visibility
        function toggleFileDetails(button) {
            const card = button.closest('.file-result-card');
            const summary = card.querySelector('.file-summary');
            
            if (summary.style.maxHeight === '200px') {
                summary.style.maxHeight = 'none';
                button.textContent = 'Collapse';
            } else {
                summary.style.maxHeight = '200px';
                button.textContent = 'Details';
            }
        }
        
        // Markdown to HTML converter for proper formatting
        function convertMarkdownToHtml(text) {
            if (!text) return '';
            
            // Convert markdown to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold** to <strong>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic* to <em>
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')          // ### header to h3
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')           // ## header to h2
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')            // # header to h1
                .replace(/^â€¢ (.*$)/gim, '<li>$1</li>')            // â€¢ bullet to <li>
                .replace(/^- (.*$)/gim, '<li>$1</li>')            // - bullet to <li>
                .replace(/\n\n/g, '</p><p>')                      // double newline to paragraphs
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')       // wrap <li> in <ul>
                .replace(/<\/ul>\s*<ul>/g, '')                    // merge consecutive <ul>
                .replace(/^(.*)$/gm, '<p>$1</p>')                 // wrap lines in <p>
                .replace(/<p><\/p>/g, '')                         // remove empty paragraphs
                .replace(/<p>(<h[1-6]>.*<\/h[1-6]>)<\/p>/g, '$1') // unwrap headers
                .replace(/<p>(<ul>.*<\/ul>)<\/p>/gs, '$1');       // unwrap lists
        }
        
        function displayBulkAnalysisResults(results) {
            // Switch to analysis display if not already shown
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('analysisDisplay').style.display = 'block';
            
            updateAnalysisTitle("ðŸ“„ Bulk Document Analysis - " + currentProject.company + " (" + currentProject.ticker + ")");
            
            // Create comprehensive results display with improved spacing
            let resultsHtml = "" +
                "<div class=\"bulk-results-container\" style=\"max-width: 100%; margin: 0; padding: 0;\">" +
                    "<div class=\"bulk-summary-card\" style=\"background: linear-gradient(135deg, var(--robeco-blue-alpha-05), var(--robeco-orange-alpha-05)); border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(15, 55, 102, 0.08);\">" +
                        "<h2 style=\"color: var(--robeco-navy); margin-bottom: 16px; display: flex; align-items: center; gap: 12px;\">" +
                            "<i class=\"fas fa-chart-line\" style=\"color: var(--robeco-blue);\"></i>" +
                            "Document Analysis Summary" +
                        "</h2>" +
                        "<div style=\"color: var(--text-secondary); font-size: 16px; margin-bottom: 20px;\">" +
                            "Analyzed " + results.file_results.length + " documents using AI-powered analysis" +
                        "</div>" +
                        "<div class=\"consolidated-insights\" style=\"background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; border-left: 4px solid var(--robeco-blue);\">" +
                            "<h3 style=\"color: var(--robeco-blue); margin-bottom: 8px; font-size: 16px;\">ðŸ“Š Consolidated Summary</h3>" +
                            "<div style=\"line-height: 1.5; color: var(--text-primary); font-size: 13px; max-height: 400px; overflow-y: auto;\">" + convertMarkdownToHtml(results.consolidated_summary) + "</div>" +
                        "</div>" +
                    "</div>" +
                    "" +
                    "<div class=\"individual-files\" style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;\">";
            
            // Add individual file results with improved layout
            results.file_results.forEach((file, index) => {
                let fileCard = '' +
                    '<div class="file-result-card" style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 12px rgba(0, 31, 63, 0.06); border: 1px solid var(--border-light);">' +
                        '<div class="file-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-light);">' +
                            '<i class="fas fa-file-alt" style="color: var(--robeco-orange); font-size: 16px;"></i>' +
                            '<div style="flex: 1;">' +
                                '<h4 style="color: var(--robeco-navy); margin: 0; font-size: 14px; font-weight: 600;">' + file.filename + '</h4>' +
                                '<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">' + file.file_type + ' â€¢ Confidence: ' + (file.confidence_score * 100).toFixed(0) + '%</div>' +
                            '</div>' +
                            '<button onclick="toggleFileDetails(this)" style="background: var(--robeco-blue); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 10px; cursor: pointer;">Details</button>' +
                        '</div>' +
                        '<div class="file-summary" style="color: var(--text-primary); font-size: 13px; line-height: 1.5; max-height: 200px; overflow-y: auto;">' +
                            convertMarkdownToHtml(file.analysis_summary) +
                        '</div>';
                
                if (file.key_insights.length > 0) {
                    fileCard += '' +
                        '<div class="key-insights" style="margin-top: 12px;">' +
                            '<h5 style="color: var(--robeco-blue); font-size: 12px; margin-bottom: 8px;">ðŸ” Key Insights:</h5>' +
                            '<ul style="font-size: 12px; color: var(--text-secondary); padding-left: 16px;">' +
                                file.key_insights.slice(0, 3).map(insight => '<li>' + insight + '</li>').join('') +
                            '</ul>' +
                        '</div>';
                }
                
                fileCard += '</div>';
                resultsHtml += fileCard;
            });
            
            resultsHtml += '' +
                '    </div>' +
                '    <div class="bulk-integration-note" style="background: var(--bg-accent); border-radius: 12px; padding: 20px; margin-top: 24px; text-align: center;">' +
                '        <h4 style="color: var(--robeco-blue); margin-bottom: 12px;">' +
                '            <i class="fas fa-lightbulb"></i> Integration with Analysts' +
                '        </h4>' +
                '        <p style="color: var(--text-secondary); margin: 0;">' +
                '            These document insights have been integrated and will be available as additional context when you run individual analyst reports.' +
                '        </p>' +
                '    </div>' +
                '</div>';
            
            document.getElementById('defaultContent').innerHTML = resultsHtml;
            
            // Store results for analyst integration
            if (currentProject) {
                currentProject.bulkAnalysisResults = results;
            }
        }

        // Enhanced Analyst Click Handler with Caching
        function handleAnalystClick(analystType) {
            if (!currentProject) {
                alert('Please complete project setup first');
                return;
            }

            console.log('ðŸŽ¯ Analyst clicked: ' + analystType);
            
            // Switch to the analyst's dedicated page first
            switchToAnalystPage(analystType);
            
            // Check if analysis is cached
            const cacheKey = currentProject.ticker + '_' + analystType;
            if (analysisCache[cacheKey]) {
                console.log('ðŸ“‹ Loading cached analysis for ' + analystType);
                displayCachedAnalysis(analystType, analysisCache[cacheKey]);
                return;
            }

            // Start fresh analysis
            startSpecialistAnalysis(analystType);
        }

        // Display Cached Analysis
        function displayCachedAnalysis(analystType, cachedData) {
            // Update UI
            updateAnalystStatus(analystType, 'cached', 'Cached');
            updateAnalysisTitle(analystType.charAt(0).toUpperCase() + analystType.slice(1) + ' Analysis (Cached)');
            
            // Display cached content in analyst-specific area
            const contentId = getAnalystContentId(analystType);
            const contentDiv = document.getElementById(contentId);
            if (contentDiv) {
                contentDiv.innerHTML = cachedData.content;
            }
            
            // Display cached sources
            if (cachedData.sources && cachedData.sources.length > 0) {
                displaySources(cachedData.sources);
            }

            // Show analysis controls
            document.getElementById('refreshBtn').style.display = 'inline-flex';
            document.getElementById('chatToggle').style.display = 'inline-flex';
            
            // Set current analysis for chat
            currentAnalysis = analystType;
            currentChatAnalyst = analystType;
            
            console.log('ðŸ“‹ Displayed cached ' + analystType + ' analysis');
        }

        // Enhanced Analysis Start
        function startSpecialistAnalysis(specialistType) {
            if (!currentProject) {
                alert('Please complete project setup first');
                return;
            }
            
            console.log('ðŸš€ Starting ' + specialistType + ' analysis with real-time streaming');
            
            currentAnalysis = specialistType;
            currentChatAnalyst = specialistType;
            currentAnalystType = specialistType;
            
            // Add bulk analysis context if available
            let enhancedQuery = currentProject.query || '';
            if (currentProject.bulkAnalysisContent) {
                enhancedQuery += "\n\n# BULK DOCUMENT ANALYSIS CONTEXT\n\nPrevious document analysis has been completed for " + currentProject.company + " (" + currentProject.ticker + "). Please integrate the following insights with your specialized analysis:\n\n" + currentProject.bulkAnalysisContent.substring(0, 3000) + (currentProject.bulkAnalysisContent.length > 3000 ? '...\n\n[Note: This is a summary of recent document analysis. Use as additional context for your specialized review.]' : '');
                console.log('ðŸ“„ Added bulk analysis context to specialist analysis');
            }
            
            // Update UI
            updateAnalystStatus(specialistType, 'researching', 'Researching');
            updateAnalysisTitle(specialistType.charAt(0).toUpperCase() + specialistType.slice(1) + ' Analysis - Live Research');
            
            // Clear previous content and reset accumulated content for streaming
            accumulatedContent = ""; // Reset for new analysis
            const contentId = getAnalystContentId(specialistType);
            const sourcesId = getAnalystSourcesId(specialistType);
            const sourcesGridId = getAnalystSourcesGridId(specialistType);
            
            document.getElementById(contentId).innerHTML = '';
            document.getElementById(sourcesId).style.display = 'none';
            document.getElementById(sourcesGridId).innerHTML = '';
            
            // Show progress
            document.getElementById('progressSection').classList.add('active');
            updateProgress('Initializing analysis...', 0);
            
            // Hide welcome, show analysis
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('analysisDisplay').style.display = 'block';
            
            // Send analysis request with data sources
            const analysisRequest = {
                type: 'start_analysis',
                session_id: userSession.id,
                connection_id: userSession.connectionId,
                analyst: specialistType,
                company: currentProject.company,
                ticker: currentProject.ticker,
                user_query: enhancedQuery,
                data_sources: currentProject.dataSources || {}
            };
            
            console.log('ðŸ” FRONTEND DEBUG: Sending analyst request with context:', analysisRequest.data_sources);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(analysisRequest));
                console.log('ðŸ“¤ Analysis request sent:', analysisRequest);
            } else {
                console.error('âŒ WebSocket not connected');
                updateAnalystStatus(specialistType, 'error', 'Connection Error');
                
                showUserDebugError('Cannot Start Analysis', 
                    specialistType + ' analysis cannot start because WebSocket connection is not established.',
                    [
                        'Wait for WebSocket to reconnect automatically',
                        'Refresh the page to re-establish connection',
                        'Check if the backend server is running',
                        'Verify network connectivity'
                    ]
                );
            }
        }

        // Enhanced Message Handler
        function handleAnalysisMessage(message) {
            console.log('ðŸ“¨ Received:', message.type, 'Data keys:', Object.keys(message.data || {}));
            
            switch (message.type) {
                case 'connection_established':
                    updateConnectionStatus('Connected');
                    updateApiStatus('ready');
                    break;
                    
                case 'streaming_analysis_started':
                    updateProgress('Analysis started...', 5);
                    break;
                    
                case 'streaming_status_update':
                    updateProgress(message.data.message, Math.round(message.data.progress * 100));
                    break;
                    
                case 'agent_deployed':
                case 'agent_completed':
                    // Keep current progress handling
                    break;
                    
                case 'streaming_research_source':
                    addResearchSource(message.data.source);
                    break;
                    
                case 'streaming_ai_content':
                    console.log('ðŸ”¥ CONTENT RECEIVED:', message.data.content_chunk ? message.data.content_chunk.length : 'NO CONTENT', 'chars');
                    console.log('ðŸ“„ Content preview:', message.data.content_chunk?.substring(0, 200));
                    appendStreamingContent(message.data.content_chunk);
                    break;
                    
                case 'streaming_chunk':
                    console.log('ðŸ”¥ CHUNK RECEIVED:', message.data.chunk ? message.data.chunk.length : 'NO CONTENT', 'chars');
                    console.log('ðŸ“„ Chunk preview:', message.data.chunk?.substring(0, 200));
                    appendStreamingContent(message.data.chunk);
                    break;
                    
                // Chunked content delivery for large messages
                case 'streaming_ai_content_chunked_start':
                    console.log('ðŸ“¦ CHUNKED START: Expecting', message.data.total_chunks, 'chunks for', message.data.citations_count, 'citations');
                    window.chunkAssembly = {
                        chunks: new Array(message.data.total_chunks),
                        receivedCount: 0,
                        totalChunks: message.data.total_chunks,
                        chunkId: message.data.chunk_id,
                        citationsCount: message.data.citations_count
                    };
                    break;
                    
                case 'streaming_ai_content_chunk':
                    if (window.chunkAssembly && window.chunkAssembly.chunkId === message.data.chunk_id) {
                        window.chunkAssembly.chunks[message.data.chunk_index] = message.data.chunk_content;
                        window.chunkAssembly.receivedCount++;
                        console.log('ðŸ“¦ CHUNK ' + (message.data.chunk_index + 1) + '/' + window.chunkAssembly.totalChunks + ' received');
                        
                        if (message.data.is_final_chunk) {
                            console.log('ðŸ“¦ All chunks received, waiting for assembly signal...');
                        }
                    } else {
                        console.warn('ðŸ“¦ Received chunk for unknown assembly:', message.data.chunk_id);
                    }
                    break;
                    
                case 'streaming_ai_content_final':
                    // Check if we need to assemble chunks
                    if (message.data.content_complete === "CHUNKED_CONTENT" && window.chunkAssembly) {
                        message.data.content_complete = window.chunkAssembly.chunks.join('');
                        console.log('ðŸ“¦ ASSEMBLED chunked content:', message.data.content_complete.length, 'chars');
                        window.chunkAssembly = null; // Clear assembly
                    }
                    
                    console.log('ðŸŽ¯ FINAL CONTENT WITH CITATIONS:', message.data.content_complete ? message.data.content_complete.length : 'NO CONTENT', 'chars');
                    console.log('ðŸ“š Citations count:', message.data.citations_count);
                    console.log('ðŸ” currentAnalystType before handler:', currentAnalystType);
                    
                    // COMPREHENSIVE FRONTEND WEBSOCKET DEBUG TRACE
                    console.log('ðŸ” *** FRONTEND WEBSOCKET DEBUG TRACE START ***');
                    console.log('   ðŸ“¨ WebSocket message received at:', new Date().toISOString());
                    console.log('   ðŸ“Š Message data keys:', Object.keys(message.data));
                    console.log('   ðŸ”¢ Message data types:', {
                        content_complete: typeof message.data.content_complete,
                        citations_count: typeof message.data.citations_count,
                        replace_content: typeof message.data.replace_content
                    });
                    
                    if (message.data.content_complete) {
                        const wsRawCitations = (message.data.content_complete.match(/\[(\d+)\]/g) || []);
                        console.log('   ðŸ“š Citations in WebSocket content:', wsRawCitations.length, 'patterns:', wsRawCitations.slice(0, 10));
                        console.log('   ðŸ“„ WebSocket content sample (chars 0-200):', message.data.content_complete.substring(0, 200));
                        console.log('   ðŸ“„ WebSocket content sample (chars 1000-1200):', message.data.content_complete.substring(1000, 1200));
                        console.log('   ðŸ“„ WebSocket content sample (last 200):', message.data.content_complete.substring(message.data.content_complete.length - 200));
                        
                        // Check for citation patterns throughout content
                        const citationPositions = [];
                        let match;
                        const regex = /\[(\d+)\]/g;
                        while ((match = regex.exec(message.data.content_complete)) !== null) {
                            citationPositions.push({ number: match[1], position: match.index });
                        }
                        console.log('   ðŸŽ¯ Citation positions in WebSocket content:', citationPositions.slice(0, 10));
                    } else {
                        console.log('   âŒ NO CONTENT in WebSocket message!');
                    }
                    console.log('ðŸ” *** FRONTEND WEBSOCKET DEBUG TRACE END ***');
                    
                    // ENHANCED DEBUGGING - Check for citations in raw content
                    if (message.data.content_complete) {
                        const rawCitations = (message.data.content_complete.match(/\[(\d+)\]/g) || []).length;
                        console.log('ðŸ” CRITICAL DEBUG: Citations in raw streaming_ai_content_final:', rawCitations);
                        console.log('ðŸ“„ Raw content first 1000 chars:', message.data.content_complete.substring(0, 1000));
                        console.log('ðŸ“„ Raw content last 1000 chars:', message.data.content_complete.substring(message.data.content_complete.length - 1000));
                        
                        // User notification about final content arrival
                        if (rawCitations > 0) {
                            showUserDebugSuccess('Final Content Received', 
                                'Received final content with ' + rawCitations + ' citations (' + (message.data.content_complete.length / 1000).toFixed(1) + 'k chars)');
                        } else if (message.data.citations_count > 0) {
                            showUserDebugError('Citation Mismatch in WebSocket', 
                                'Backend claims ' + message.data.citations_count + ' citations but raw content has ' + rawCitations + '.'
                                [
                                    'This is a backend citation generation bug',
                                    'Citations were lost between generation and WebSocket sending',
                                    'Check backend logs for citation insertion failures',
                                    'Try running the analysis again'
                                ]
                            );
                        }
                    } else {
                        showUserDebugError('Empty Final Content', 
                            'Received streaming_ai_content_final message but content is empty.',
                            [
                                'This is a backend streaming error',
                                'Analysis may have failed during final processing',
                                'Check backend logs for errors',
                                'Try refreshing page and running analysis again'
                            ]
                        );
                    }
                    
                    try {
                        // Check if this is chunked assembly mode
                        if (message.data.assembly_mode === 'chunked' && window.chunkAssembly) {
                            console.log('ðŸ“¦ CHUNKED ASSEMBLY: Reconstructing content from', window.chunkAssembly.totalChunks, 'chunks');
                            
                            // Verify all chunks received
                            const missingChunks = window.chunkAssembly.chunks.findIndex(chunk => chunk === undefined);
                            if (missingChunks >= 0) {
                                console.error('âŒ Missing chunks detected at index:', missingChunks);
                                return;
                            }
                            
                            // Assemble complete content from chunks
                            const assembledContent = window.chunkAssembly.chunks.join('');
                            
                            // Create final data with assembled content
                            const finalData = {
                                ...message.data,
                                content_complete: assembledContent,
                                citations_count: window.chunkAssembly.citationsCount
                            };
                            
                            console.log('âœ… CHUNKED ASSEMBLY COMPLETE:', assembledContent.length, 'chars,', finalData.citations_count, 'citations');
                            
                            handleFinalContentWithCitations(finalData);
                            
                            // Clean up
                            window.chunkAssembly = null;
                            
                        } else {
                            // Standard single message handling
                            handleFinalContentWithCitations(message.data);
                        }
                        
                    } catch (error) {
                        console.error('âŒ Error in handleFinalContentWithCitations:', error);
                        console.error('Stack trace:', error.stack);
                        
                        showUserDebugError('Final Content Processing Error', 
                            'Error occurred while processing final analysis content: ' + error.message,
                            [
                                'This is likely a JavaScript processing bug',
                                'The backend analysis completed but frontend failed to display it',
                                'Check browser console for detailed stack trace',
                                'Try refreshing the page and running analysis again',
                                'Report this error if it persists'
                            ]
                        );
                    }
                    break;
                    
                case 'streaming_analysis_completed':
                    handleAnalysisComplete(message.data);
                    break;
                    
                case 'streaming_analysis_error':
                    handleAnalysisError(message.data);
                    break;
                    
                // Bulk Analysis Streaming Messages
                case 'bulk_analysis_initiated':
                    console.log('ðŸŽ¬ BULK_ANALYSIS_INITIATED received:', message.data);
                    handleBulkAnalysisInitiated(message.data);
                    break;
                    
                case 'bulk_analysis_started':
                    console.log('ðŸš€ BULK_ANALYSIS_STARTED received:', message.data);
                    handleBulkAnalysisStarted(message.data);
                    break;
                    
                case 'bulk_analysis_status':
                    console.log('ðŸ“Š BULK_ANALYSIS_STATUS received:', message.data);
                    handleBulkAnalysisStatus(message.data);
                    break;
                    
                case 'bulk_analysis_chunk':
                    console.log('ðŸ“„ BULK_ANALYSIS_CHUNK received:', message.data.content_chunk ? message.data.content_chunk.length + ' chars' : 'no content');
                    handleBulkAnalysisChunk(message.data);
                    break;
                    
                case 'bulk_analysis_completed':
                    console.log('âœ… BULK_ANALYSIS_COMPLETED received:', message.data);
                    handleBulkAnalysisCompleted(message.data);
                    break;
                    
                case 'bulk_analysis_error':
                    console.error('âŒ BULK_ANALYSIS_ERROR received:', message.data);
                    handleBulkAnalysisError(message.data);
                    break;
                    
                case 'chat_response':
                    handleChatResponse(message.data);
                    break;
                    
                case 'chat_history':
                    handleChatHistory(message.data);
                    break;
                    
                case 'chat_history_cleared':
                    handleChatHistoryCleared(message.data);
                    break;
                    
                case 'chat_error':
                    handleChatError(message.data);
                    break;
                    
                case 'chat_debug':
                    handleChatDebug(message.data);
                    break;
                    
                // Report Generation Messages
                case 'generate_report_acknowledged':
                    console.log('âœ… GENERATE_REPORT_ACKNOWLEDGED received:', message.data);
                    handleReportGenerationAcknowledged(message.data);
                    break;
                    
                case 'report_generation_started':
                    console.log('ðŸ“‹ REPORT_GENERATION_STARTED received:', message.data);
                    handleReportGenerationStarted(message.data);
                    break;
                    
                case 'report_generation_completed':
                    console.log('âœ… REPORT_GENERATION_COMPLETED received:', message.data);
                    handleReportGenerationCompleted(message.data);
                    break;
                    
                case 'report_generation_progress':
                    console.log('ðŸ“Š REPORT_GENERATION_PROGRESS received:', message.data);
                    handleReportGenerationProgress(message.data);
                    break;
                    
                case 'report_generation_streaming':
                    console.log('ðŸ”„ REPORT_GENERATION_STREAMING received:', message.data);
                    handleReportGenerationStreaming(message.data);
                    break;
                    
                case 'report_generation_error':
                    console.error('âŒ REPORT_GENERATION_ERROR received:', message.data);
                    handleReportGenerationError(message.data);
                    break;
                    
                case 'report_generation_section_complete':
                    console.log('ðŸ“‘ REPORT_SECTION_COMPLETE received:', message.data);
                    handleReportSectionComplete(message.data);
                    break;
                    
                case 'report_generation_complete':
                    console.log('âœ… REPORT_GENERATION_COMPLETE received:', message.data);
                    handleReportGenerationFinalComplete(message.data);
                    break;
                    
                // Word generation handlers
                case 'word_generation_started':
                    console.log('ðŸ“„ WORD_GENERATION_STARTED received:', message.data);
                    handleWordGenerationStarted(message.data);
                    break;
                    
                case 'word_generation_progress':
                    console.log('ðŸ“„ WORD_GENERATION_PROGRESS received:', message.data);
                    handleWordGenerationProgress(message.data);
                    break;
                    
                case 'word_generation_completed':
                    console.log('âœ… WORD_GENERATION_COMPLETED received:', message.data);
                    handleWordGenerationCompleted(message.data);
                    break;
                    
                case 'word_generation_error':
                    console.error('âŒ WORD_GENERATION_ERROR received:', message.data);
                    handleWordGenerationError(message.data);
                    break;
                    
                case 'progress':
                    console.log('ðŸ”„ PROGRESS received:', message.data);
                    handleReportProgress(message.data);
                    break;
            }
        }

        // Enhanced Analysis Complete Handler
        function handleAnalysisComplete(data) {
            console.log('âœ… Analysis completed:', data);
            
            // Update progress
            updateProgress('Analysis completed', 100);
            setTimeout(() => {
                document.getElementById('progressSection').classList.remove('active');
            }, 2000);
            
            // Update analyst status
            if (currentAnalysis) {
                updateAnalystStatus(currentAnalysis, 'completed', 'Completed');
                
                // Cache the analysis
                const cacheKey = currentProject.ticker + '_' + currentAnalysis;
                const contentId = getAnalystContentId(currentAnalysis);
                analysisCache[cacheKey] = {
                    content: document.getElementById(contentId).innerHTML,
                    sources: Array.from(document.querySelectorAll('.source-card')).map(card => ({
                        title: card.querySelector('.source-title').textContent,
                        url: card.href,
                        index: card.querySelector('.source-index').textContent
                    })),
                    timestamp: new Date().toISOString(),
                    analyst: currentAnalysis
                };
                
                console.log('ðŸ’¾ Cached analysis for ' + currentAnalysis);
                
                // Save to persistence system for report generation
                if (window.robecoAnalysisPersistence) {
                    window.robecoAnalysisPersistence.saveAnalysis({
                        company: currentProject.company,
                        ticker: currentProject.ticker,
                        analystType: currentAnalysis,
                        objective: currentProject.objective || '',
                        content: document.getElementById(contentId).innerHTML,
                        sources: Array.from(document.querySelectorAll('.source-card')).map(card => ({
                            title: card.querySelector('.source-title')?.textContent || '',
                            url: card.href || '',
                            credibility_score: 0.9
                        })),
                        qualityScore: 0.9,
                        processingTime: data.processing_time || 0
                    });
                    console.log('ðŸ“ Analysis saved to persistence system for report generation');
                } else {
                    console.warn('âš ï¸ Analysis persistence system not loaded');
                }
            }
            
            // Show post-analysis controls
            document.getElementById('refreshBtn').style.display = 'inline-flex';
            document.getElementById('chatToggle').style.display = 'inline-flex';
        }

        // Enhanced Status Management
        function updateAnalystStatus(analystType, statusClass, statusText) {
            const card = document.querySelector('[data-specialist="' + analystType + '"]');
            if (!card) return;
            
            // Remove existing status classes
            card.classList.remove('active', 'completed', 'cached');
            
            // Add new status class
            if (statusClass !== 'ready') {
                card.classList.add(statusClass);
            }
            
            // Update status element
            const statusElement = card.querySelector('.analyst-status');
            if (statusElement) {
                statusElement.textContent = statusText;
                statusElement.className = 'analyst-status ' + statusClass;
            }
        }

        // Enhanced Chat Functionality
        function toggleChat() {
            const chatPanel = document.getElementById('analysisChat');
            const toggleBtn = document.getElementById('chatToggle');
            
            if (chatPanel.classList.contains('active')) {
                chatPanel.classList.remove('active');
                toggleBtn.classList.remove('active');
            } else {
                chatPanel.classList.add('active');
                toggleBtn.classList.add('active');
                
                // Update chat header and load history
                if (currentChatAnalyst) {
                    document.getElementById('chatAnalystName').textContent = 
                        'Discuss with ' + currentChatAnalyst.charAt(0).toUpperCase() + currentChatAnalyst.slice(1) + ' Analyst';
                    
                    // Load chat history for this analyst
                    loadChatHistory(currentChatAnalyst);
                }
                
                // Focus chat input
                document.getElementById('chatInput').focus();
            }
        }

        function loadChatHistory(analystType) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_chat_history',
                    analyst: analystType
                }));
            }
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message || !currentChatAnalyst) return;
            
            // Add user message to chat UI
            addChatMessage('user', message);
            
            // Clear input
            chatInput.value = '';
            
            // Get analysis content for context from current analyst
            let analysisContent = '';
            if (currentChatAnalyst) {
                const contentId = getAnalystContentId(currentChatAnalyst);
                analysisContent = document.getElementById(contentId).innerHTML || '';
            }
            
            // Send to backend for AI response with full context
            const chatRequest = {
                type: 'chat_message',
                analyst: currentChatAnalyst,
                message: message,
                company: currentProject.company,
                ticker: currentProject.ticker,
                analysis_content: analysisContent,
                context: 'post_analysis_discussion'
            };
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(chatRequest));
                
                // Add loading message
                addChatMessage('ai', 'Thinking...', true);
            }
        }

        function addChatMessage(sender, message, extraClass = '', isLoading = false) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ' + (extraClass || '');
            
            let avatarText = 'AI';
            if (sender === 'user') avatarText = 'PM';
            else if (sender === 'system') avatarText = 'ðŸ”§';
            
            messageDiv.innerHTML = 
                '<div class="message-avatar ' + sender + '">' + avatarText + '</div>' +
                '<div class="message-content ' + sender + ' ' + (extraClass || '') + '">' +
                    (isLoading ? '<div class="loading-indicator"><div class="spinner"></div>Analyzing...</div>' : message) +
                '</div>';
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleChatResponse(data) {
            // Remove loading message
            const loadingMessages = document.querySelectorAll('.chat-message .loading-indicator');
            loadingMessages.forEach(msg => msg.parentElement.parentElement.remove());
            
            // Add AI response
            addChatMessage('ai', data.response);
            
            console.log('ðŸ’¬ Chat response received from ' + data.analyst + ' analyst');
        }

        function handleChatHistory(data) {
            // Clear current chat display
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // Display conversation history
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    addChatMessage(msg.role === 'user' ? 'user' : 'ai', msg.content);
                });
                console.log('ðŸ“œ Loaded ' + data.messages.length + ' chat messages for ' + data.analyst);
            } else {
                // Add initial greeting if no history
                addChatMessage('ai', 'Hello! I\'ve completed my ' + data.analyst + ' analysis. Feel free to ask any follow-up questions or request additional insights on specific areas.');
            }
        }

        function handleChatHistoryCleared(data) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            addChatMessage('ai', 'Chat history cleared. I\'m ready to discuss my ' + data.analyst + ' analysis with you.');
            console.log('ðŸ—‘ï¸ Chat history cleared for ' + data.analyst);
        }

        function handleChatError(data) {
            console.error('âŒ Chat error:', data.error);
            addChatMessage('ai', 'Error: ' + data.error);
        }
        
        function handleChatDebug(data) {
            console.log('ðŸ”§ Chat debug:', data.message);
            
            // Show debug message in chat
            const debugClass = data.severity === 'critical' ? 'debug-critical' : 'debug-info';
            addChatMessage('system', data.message, debugClass);
            
            // If critical API key problem, show user notification
            if (data.severity === 'critical' && data.action_needed) {
                showUserDebugError('API Key Problem', 
                    data.message, 
                    [
                        'Add working API keys to primary_gemini_key.txt',
                        'Check API key permissions and quotas',
                        'Contact administrator if problem persists'
                    ]
                );
            }
        }

        function clearChatHistory() {
            if (!currentChatAnalyst) return;
            
            if (confirm('Clear chat history with ' + currentChatAnalyst + ' analyst?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'clear_chat_history',
                        analyst: currentChatAnalyst
                    }));
                }
            }
        }

        // Report Generation Handlers
        async function initializeRawHtmlWithCSS() {
            // Load complete CSScode.txt structure to show basic template immediately
            try {
                const response = await fetch('/static/Report Example/CSScode.txt');
                if (response.ok) {
                    const cssTemplate = await response.text();
                    // Add generation indicator to the template
                    const enhancedTemplate = cssTemplate.replace(
                        '</body>',
                        `
<!-- ðŸ”„ AI Content Generation Area -->
<div class="presentation-container">
    <div class="slide">
        <div class="section-title">ðŸ”„ AI Generating Investment Report...</div>
        <p>Investment analysis in progress...</p>
    </div>
</div>

</body>`
                    );
                    document.getElementById('rawHtmlCode').textContent = enhancedTemplate;
                    console.log('âœ… Raw HTML initialized with complete CSS template structure');
                } else {
                    console.warn('âš ï¸ Could not load CSScode.txt, using fallback template');
                    // Fallback to basic template
                    const fallbackTemplate = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robeco - Investment Analysis</title>
    <style>
        :root { --robeco-blue: #005F90; }
        .presentation-container { width: 1620px; margin: 0; }
        .slide { width: 1620px; height: 2291px; padding: 105px 98px; }
        .section-title { font-size: 25.5px; font-weight: 700; color: var(--robeco-blue); }
    </style>
</head>
<body>
    <div class="presentation-container">
        <div class="slide">
            <div class="section-title">ðŸ”„ AI Generating Investment Report...</div>
        </div>
    </div>
</body>
</html>`;
                    document.getElementById('rawHtmlCode').textContent = fallbackTemplate;
                }
            } catch (error) {
                console.error('âŒ Error loading CSS template:', error);
            }
        }

        function handleReportGenerationAcknowledged(data) {
            console.log('âœ… Report generation acknowledged by server:', data.message);
            
            // Update user with immediate feedback
            showUserDebugSuccess('Request Acknowledged', 
                'âœ… Server confirmed report generation request\n' +
                'ðŸ”„ Processing is starting...\n' +
                'ðŸ“Š Estimated time: 1-2 minutes'
            );
        }
        
        function restoreGenerateButton() {
            // Restore the generate button to normal state
            const generateBtn = document.querySelector('.generate-report-btn');
            if (generateBtn) {
                generateBtn.innerHTML = '<i class="fas fa-magic" style="margin-right: 8px;"></i>Generate HTML Report';
                generateBtn.disabled = false;
                generateBtn.style.opacity = '1';
            }
        }

        function handleReportGenerationStarted(data) {
            console.log('ðŸ“‹ Report generation started for', data.ticker);
            
            // Set report generation mode
            isGeneratingReport = true;
            currentAnalystType = 'report';
            
            // Switch to report viewer page
            switchToAnalystPage('report');
            
            // Initialize Raw HTML with CSS template structure first
            initializeRawHtmlWithCSS();
            
            // Clear rendered report viewer and reset completion state
            const renderedReportViewer = document.getElementById('renderedReportViewer');
            renderedReportViewer.innerHTML = '<div class="report-placeholder">ðŸ”„ Generating investment report...</div>';
            
            // Clear completion markers to allow new streaming updates
            renderedReportViewer.removeAttribute('data-report-completed');
            renderedReportViewer.removeAttribute('data-completion-time');
            console.log('ðŸ”„ WEBSOCKET DEBUG - Completion markers cleared, ready for new streaming');
            
            showUserDebugSuccess('Report Generation Started', 
                'Generating investment report for ' + data.company + ' using all completed analyses');
        }


        function handleReportSectionComplete(data) {
            console.log('ðŸ“‘ Report section completed:', data.section, '- Progress:', data.progress + '%');
            console.log('ðŸ“„ Content length received:', data.content ? data.content.length : 'none');
            console.log('ðŸ” DEBUG: data keys:', Object.keys(data));
            console.log('ðŸ” DEBUG: data.characters:', data.characters);
            console.log('ðŸ” DEBUG: Content preview (first 200 chars):', data.content ? data.content.substring(0, 200) : 'NONE');
            
            // Update raw HTML with ACCUMULATED content (not replacing)
            const rawHtmlCode = document.getElementById('rawHtmlCode');
            if (rawHtmlCode && data.content) {
                // Add section progress comment at the top
                const sectionProgressComment = `<!-- ðŸ“Š REPORT GENERATION PROGRESS: ${data.section.toUpperCase()} COMPLETE (${data.progress}%) -->
<!-- ðŸ“„ ACCUMULATED CONTENT: ${(data.characters/1000).toFixed(1)}k characters -->
<!-- âœ… This contains all content from previous sections plus this section -->

`;
                rawHtmlCode.textContent = sectionProgressComment + data.content;
                rawHtmlCode.scrollTop = rawHtmlCode.scrollHeight; // Auto-scroll to bottom
                console.log('âœ… Updated raw HTML code with accumulated content:', data.content.length, 'chars');
            }
            
            // Update rendered report viewer with ACCUMULATED content
            const renderedReportViewer = document.getElementById('renderedReportViewer');
            if (renderedReportViewer && data.content) {
                // Add a visible progress indicator at the top of the content
                let contentWithProgress = data.content;
                
                // Add progress indicator based on section
                const sectionProgress = {
                    'overview': 'Step 1/3: Overview & Investment Thesis Complete',
                    'analysis': 'Step 2/3: Overview + Analysis Complete', 
                    'financial': 'Step 3/3: Complete Report (All Sections)'
                };
                
                const progressIndicator = `
                    <div style="background: #005F90; color: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center; font-weight: bold;">
                        ðŸ“Š ${sectionProgress[data.section] || 'Report Generation In Progress'} - ${data.progress}%
                        <br><small>Content: ${(data.characters/1000).toFixed(1)}k characters accumulated</small>
                    </div>
                `;
                
                // SMOOTH ACCUMULATIVE DISPLAY: Don't replace content, build it up gradually
                console.log('ðŸ” SMOOTH ACCUMULATION DEBUG:');
                console.log('   - Section:', data.section);
                console.log('   - Content length:', data.content ? data.content.length : 'null');
                
                // Get current content in the viewer
                const currentContent = renderedReportViewer.innerHTML;
                const isFirstSection = data.section === 'overview' || currentContent.trim() === '';
                
                console.log('   - Is first section?', isFirstSection);
                console.log('   - Current content length:', currentContent.length);
                
                if (isFirstSection) {
                    // First section: Show progress indicator + content directly
                    console.log('   âœ… First section - showing directly');
                    const finalDisplayContent = progressIndicator + data.content;
                    renderedReportViewer.innerHTML = finalDisplayContent;
                } else {
                    // Subsequent sections: Update progress indicator and add new slides smoothly
                    console.log('   âœ… Subsequent section - updating progress and content smoothly');
                    
                    // Extract just the new slides from the accumulated content
                    // The backend sends ALL slides (accumulated), but we want to show growth
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.content;
                    const allSlides = Array.from(tempDiv.querySelectorAll('div.slide'));
                    
                    // Count slides currently displayed
                    const currentSlides = renderedReportViewer.querySelectorAll('div.slide');
                    console.log('   - Current slides in DOM:', currentSlides.length);
                    console.log('   - Total slides from backend:', allSlides.length);
                    
                    // Update progress indicator (replace the old one)
                    const existingProgress = renderedReportViewer.querySelector('div[style*="background: #005F90"]');
                    if (existingProgress) {
                        existingProgress.outerHTML = progressIndicator;
                    }
                    
                    // Add any new slides that aren't already displayed
                    for (let i = currentSlides.length; i < allSlides.length; i++) {
                        console.log(`   ðŸ“„ Adding new slide ${i + 1}:`, allSlides[i].id || 'no-id');
                        // Add with a smooth fade-in effect
                        const newSlide = allSlides[i].cloneNode(true);
                        newSlide.style.opacity = '0';
                        newSlide.style.transition = 'opacity 0.5s ease-in';
                        renderedReportViewer.appendChild(newSlide);
                        
                        // Trigger fade-in after a brief delay
                        setTimeout(() => {
                            newSlide.style.opacity = '1';
                        }, 100);
                    }
                }
                
                // DEBUG: Verify what's actually in the DOM after smooth accumulation
                const finalSlides = renderedReportViewer.querySelectorAll('div.slide');
                console.log('ðŸ” SMOOTH ACCUMULATION VERIFICATION:');
                console.log('   ðŸ“„ Total slides now in DOM:', finalSlides.length);
                console.log('   ðŸ“„ Slide IDs in DOM:', Array.from(finalSlides).map(slide => slide.id).filter(id => id));
                console.log('   âœ… Content accumulation method:', isFirstSection ? 'DIRECT_LOAD' : 'SMOOTH_APPEND');
                
                renderedReportViewer.scrollTop = renderedReportViewer.scrollHeight; // Auto-scroll to bottom
                console.log('âœ… Smooth accumulative display completed - slides grow incrementally, not replaced');
            }
            
            // Show section completion notification
            showUserDebugSuccess(`${data.section.toUpperCase()} Section Complete`, 
                `${data.status} (${(data.characters/1000).toFixed(1)}k chars ACCUMULATED)`);
        }
        
        function handleReportGenerationFinalComplete(data) {
            console.log('âœ… Final report generation completed:', data);
            console.log('ðŸ“„ Final HTML length:', data.final_html ? data.final_html.length : 'none');
            
            // Clear report generation mode
            isGeneratingReport = false;
            
            // Update with final accumulated HTML
            const rawHtmlCode = document.getElementById('rawHtmlCode');
            if (rawHtmlCode && data.final_html) {
                // Add final completion comment
                const finalCompletionComment = `<!-- âœ… COMPLETE INVESTMENT REPORT GENERATED SUCCESSFULLY -->
<!-- ðŸ“Š TOTAL CONTENT: ${(data.final_html.length/1000).toFixed(1)}k characters -->
<!-- ðŸŽ¯ All 3 sections included: Overview + Analysis + Financial -->

`;
                rawHtmlCode.textContent = finalCompletionComment + data.final_html;
                rawHtmlCode.scrollTop = 0; // Scroll to top to see completion message
                console.log('âœ… Updated raw HTML with final content:', data.final_html.length, 'chars');
            }
            
            // Display final rendered report (without progress indicator)
            const renderedReportViewer = document.getElementById('renderedReportViewer');
            if (renderedReportViewer && data.final_html) {
                // Add final completion indicator
                const completionIndicator = `
                    <div style="background: #28a745; color: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center; font-weight: bold;">
                        âœ… Complete Investment Report Generated Successfully!
                        <br><small>Total content: ${(data.final_html.length/1000).toFixed(1)}k characters</small>
                    </div>
                `;
                
                renderedReportViewer.innerHTML = completionIndicator + data.final_html;
                renderedReportViewer.scrollTop = 0; // Scroll to top to see completion message
                console.log('âœ… Updated rendered report with final content and completion indicator:', data.final_html.length, 'chars');
            }
            
            // Store the HTML report for Word conversion
            latestHtmlReport = data.final_html;
            console.log('ðŸ“„ HTML report stored for Word conversion:', latestHtmlReport ? latestHtmlReport.length : 0, 'characters');
            
            // Enable Word generation button
            const wordBtn = document.getElementById('generateWordBtn');
            if (wordBtn && latestHtmlReport) {
                // Enable and style the Word button
                wordBtn.disabled = false;
                wordBtn.style.opacity = '1';
                wordBtn.style.cursor = 'pointer';
                wordBtn.style.background = 'rgba(255,140,0,0.2)';
                wordBtn.style.color = 'white';
                wordBtn.style.borderColor = 'rgba(255,140,0,0.3)';
                
                console.log('âœ… Word generation button enabled after HTML report completion');
            }
            
            // Enable PDF generation button
            const pdfBtn = document.getElementById('generatePdfBtn');
            if (pdfBtn && latestHtmlReport) {
                // Enable and style the PDF button
                pdfBtn.disabled = false;
                pdfBtn.style.opacity = '1';
                pdfBtn.style.cursor = 'pointer';
                pdfBtn.style.background = 'rgba(220,53,69,0.2)';
                pdfBtn.style.color = 'white';
                pdfBtn.style.borderColor = 'rgba(220,53,69,0.3)';
                
                console.log('âœ… PDF generation button enabled after HTML report completion');
            }
                
            // Show Word and PDF availability notification
            showUserDebugSuccess('Document Export Available', 
                'ðŸ“„ HTML report ready\nâœ… Word and PDF document conversion now available\nðŸ”„ Click "Generate Word Document" or "Generate PDF Document" button');
            
            // Show final success notification
            showUserDebugSuccess('Complete Report Generated Successfully', 
                `âœ… ${data.status}\n` +
                `ðŸ“„ Content: ${(data.characters/1000).toFixed(1)}k characters\n` + 
                `ðŸ“‘ Sections: ${data.sections_completed.join(', ')}\n` +
                `ðŸŽ¨ Report ready for viewing and export`);
        }

        function handleReportGenerationCompleted(data) {
            console.log('âœ… Report generation completed (LEGACY):', data);
            console.log('ðŸ” WEBSOCKET DEBUG - handleReportGenerationCompleted data keys:', Object.keys(data));
            console.log('ðŸ” WEBSOCKET DEBUG - data.report_html length:', data.report_html ? data.report_html.length : 'NULL');
            console.log('ðŸ” WEBSOCKET DEBUG - data.raw_content length:', data.raw_content ? data.raw_content.length : 'NULL');
            
            // Clear report generation mode  
            isGeneratingReport = false;
            
            // Show success notification with details
            showUserDebugSuccess('Report Generated Successfully', 
                `Investment report completed for ${data.ticker} using ${data.template_used}\n` +
                `Content: ${(data.content_length/1000).toFixed(1)}k chars | Final: ${(data.final_length/1000).toFixed(1)}k chars`);
            
            // Display raw HTML code in the code viewer (replace any accumulated content)
            if (data.raw_content) {
                const rawHtmlElement = document.getElementById('rawHtmlCode');
                if (rawHtmlElement) {
                    rawHtmlElement.textContent = data.raw_content;
                    console.log('âœ… WEBSOCKET DEBUG - Raw HTML content set successfully:', data.raw_content.length, 'characters');
                } else {
                    console.error('âŒ WEBSOCKET DEBUG - rawHtmlCode element not found!');
                }
            } else {
                console.warn('âš ï¸ WEBSOCKET DEBUG - No raw_content provided in completion data');
            }
            
            // Display final rendered report in the viewer - THIS IS THE CRITICAL PART
            if (data.report_html) {
                const renderedReportElement = document.getElementById('renderedReportViewer');
                if (renderedReportElement) {
                    // FORCE the content update and prevent any subsequent overrides
                    renderedReportElement.innerHTML = data.report_html;
                    
                    // Add a completion marker to prevent future overwrites
                    renderedReportElement.setAttribute('data-report-completed', 'true');
                    renderedReportElement.setAttribute('data-completion-time', new Date().toISOString());
                    
                    console.log('âœ… WEBSOCKET DEBUG - Rendered report content set successfully:', data.report_html.length, 'characters');
                    console.log('ðŸ”’ WEBSOCKET DEBUG - Report marked as completed, subsequent updates blocked');
                    
                    // Scroll to top to show the complete report
                    renderedReportElement.scrollTop = 0;
                } else {
                    console.error('âŒ WEBSOCKET DEBUG - renderedReportViewer element not found!');
                }
            } else {
                console.error('âŒ WEBSOCKET DEBUG - No report_html provided in completion data!');
                console.log('ðŸ” WEBSOCKET DEBUG - Available data fields:', Object.keys(data));
            }
            
            // Optional: Also save to localStorage for persistence
            const reportData = {
                id: 'report_' + Date.now(),
                company_name: data.company_name,
                ticker: data.ticker,
                report_html: data.report_html,
                raw_content: data.raw_content,
                generation_time: data.timestamp,
                analyses_included: data.analyses_count,
                template_used: data.template_used
            };
            
            const savedReports = JSON.parse(localStorage.getItem('robeco_generated_reports') || '[]');
            savedReports.unshift(reportData);
            
            // Keep only last 10 reports
            if (savedReports.length > 10) {
                savedReports.splice(10);
            }
            
            localStorage.setItem('robeco_generated_reports', JSON.stringify(savedReports));
            console.log('ðŸ“„ Report saved to local storage');
            
            // Store the HTML report for Word conversion
            latestHtmlReport = data.raw_content || data.report_html;
            console.log('ðŸ“„ HTML report stored for Word conversion:', latestHtmlReport ? latestHtmlReport.length : 0, 'characters');
            
            // Show Word generation button
            const wordBtn = document.getElementById('generateWordBtn');
            if (wordBtn && latestHtmlReport) {
                // Enable and style the Word button
                wordBtn.disabled = false;
                wordBtn.style.opacity = '1';
                wordBtn.style.cursor = 'pointer';
                wordBtn.style.background = 'rgba(255,140,0,0.2)';
                wordBtn.style.color = 'white';
                wordBtn.style.borderColor = 'rgba(255,140,0,0.3)';
                wordBtn.title = 'Click to generate Word document from HTML report';
            }
            
            // Show PDF generation button
            const pdfBtn = document.getElementById('generatePdfBtn');
            if (pdfBtn && latestHtmlReport) {
                // Enable and style the PDF button
                pdfBtn.disabled = false;
                pdfBtn.style.opacity = '1';
                pdfBtn.style.cursor = 'pointer';
                pdfBtn.style.background = 'rgba(220,53,69,0.2)';
                pdfBtn.style.color = 'white';
                pdfBtn.style.borderColor = 'rgba(220,53,69,0.3)';
                pdfBtn.title = 'Click to generate PDF document from HTML report';
                
                // Add hover effects back
                wordBtn.onmouseover = function() {
                    if (!this.disabled) {
                        this.style.background = 'rgba(255,140,0,0.3)';
                        this.style.borderColor = 'rgba(255,140,0,0.5)';
                    }
                };
                wordBtn.onmouseout = function() {
                    if (!this.disabled) {
                        this.style.background = 'rgba(255,140,0,0.2)';
                        this.style.borderColor = 'rgba(255,140,0,0.3)';
                    }
                };
                
                console.log('ðŸ“„ Word generation button enabled');
                
                // Show additional success message about Word conversion being available
                setTimeout(() => {
                    showUserDebugSuccess('Word Export Available', 
                        'You can now convert your HTML report to Word format!',
                        [{
                            text: 'Generate Word Document',
                            action: () => generateWordReport()
                        }]
                    );
                }, 2000); // Show after 2 seconds delay
            }
        }

        function handleReportGenerationError(data) {
            console.error('âŒ Report generation failed:', data.error);
            
            // Clear report generation mode
            isGeneratingReport = false;
            
            // Restore the generate button to normal state
            restoreGenerateButton();
            
            // Clear any stored HTML report and disable Word button
            latestHtmlReport = null;
            const wordBtn = document.getElementById('generateWordBtn');
            if (wordBtn) {
                wordBtn.disabled = true;
                wordBtn.style.opacity = '0.4';
                wordBtn.style.cursor = 'not-allowed';
                wordBtn.style.background = 'rgba(255,140,0,0.1)';
                wordBtn.style.color = 'rgba(255,255,255,0.4)';
                wordBtn.style.borderColor = 'rgba(255,140,0,0.2)';
                wordBtn.title = 'Generate HTML report first to enable Word conversion';
            }
            
            // Update raw HTML viewer to show error
            document.getElementById('rawHtmlCode').textContent = '// Report generation failed: ' + data.error;
            
            // Show user-friendly error message
            showUserDebugError('Report Generation Failed', 
                'Failed to generate investment report: ' + data.error,
                [
                    'Make sure you have run multiple agent analyses first',
                    'Check that the backend server has working API keys', 
                    'Try running analyses again before generating report',
                    'Check browser console for detailed error information',
                    'ðŸ”„ You can try again by clicking "Generate HTML Report"'
                ]
            );
        }

        // Real-time Report Generation Handlers
        function handleReportGenerationProgress(data) {
            console.log('ðŸ“Š Report progress:', data.status, '-', data.message);
            
            // Show user-friendly notifications for ALL progress updates
            const statusMessages = {
                'initializing': 'ðŸ—ï¸ Initializing report template...',
                'template_loading': 'ðŸ“‹ Loading Robeco investment template...',
                'fetching_data': 'ðŸ“Š Fetching stock market data...',
                'ai_generating': 'ðŸ¤– AI generating professional investment report...',
                'call1_starting': 'ðŸ“Š Generating overview and analysis sections...',
                'processing': 'âš™ï¸ Processing analysis data...',
                'formatting': 'ðŸŽ¨ Formatting professional layout...',
                'finalizing': 'âœ… Finalizing investment report...'
            };
            
            // Show notification for current status
            const userMessage = statusMessages[data.status] || data.message || 'Processing...';
            showUserDebugInfo('Report Generation Progress', userMessage);
            
            // Update persistent progress indicator
            updatePersistentProgressIndicator(data.status, userMessage);
            
            // DO NOT update raw HTML viewer - preserve accumulated content
            // The raw HTML should only show actual report content, not progress messages
            
            // Handle special phase transitions with enhanced notifications
            if (data.phase) {
                switch(data.phase) {
                    case 'call1_starting':
                        showUserDebugInfo('AI Generation Started', 'ðŸš€ Beginning overview and analysis generation...');
                        break;
                    case 'call1_complete':
                        showUserDebugSuccess('Phase 1 Complete', 'âœ… Overview & Analysis (Slides 1-5) generated successfully!');
                        break;
                    case 'transition':
                        showUserDebugInfo('Preparing Next Phase', 'ðŸ”„ Preparing industry analysis and financial deep dive...');
                        break;
                    case 'call2_starting':
                        showUserDebugInfo('Phase 2 Started', 'ðŸš€ Beginning industry analysis & financial deep dive...');
                        break;
                    default:
                        showUserDebugSuccess('Report Progress', data.message + ` (${data.progress}%)`);
                }
            } else {
                // Standard progress notification
                showUserDebugSuccess('Report Progress', data.message + ` (${data.progress}%)`);
            }
        }

        function handleReportProgress(data) {
            console.log('ðŸ”„ Report progress update:', data.message, '- Progress:', data.progress + '%');
            
            // Show progress notification WITHOUT clearing accumulated content
            showUserDebugSuccess('Report Progress', data.message + ` (${data.progress}%)`);
            
            // Update progress bar if it exists but DON'T touch the content areas
            updateProgress(data.message, data.progress, data.phase);
        }

        function handleReportGenerationStreaming(data) {
            // ULTRA-DEBUG: Comprehensive frontend logging to match backend debug
            console.log('ðŸ”„ Streaming HTML chunk:', data.chunk_number, 'chunks,', data.accumulated_html ? data.accumulated_html.length : 0, 'total chars');
            
            // ULTRA-DEBUG: Log debug info if available
            if (data.debug_info) {
                console.log('ðŸ› ï¸ DEBUG INFO:', 
                    `slides=${data.debug_info.slides_detected}, ` +
                    `page=${data.debug_info.last_page_detected}, ` +
                    `ocf=${data.debug_info.operating_cash_flow_seen}, ` +
                    `content="${(data.debug_info.recent_content_sample || '').substring(0, 80)}..."`
                );
                
                // ULTRA-DEBUG: Alert for Call 2 critical milestones
                if (data.call_phase && data.call_phase.startsWith('call2')) {
                    console.log('ðŸš¨ CALL 2 TRACKING:', 
                        `chunk=${data.chunk_number}, ` +
                        `slides=${data.debug_info.slides_detected}, ` +
                        `page=${data.debug_info.last_page_detected}, ` +
                        `ocf=${data.debug_info.operating_cash_flow_seen}`
                    );
                    
                    // Critical failure point detection
                    if (data.debug_info.operating_cash_flow_seen && data.debug_info.last_page_detected === 10) {
                        console.warn('âš ï¸ CRITICAL: Call 2 at slide 10 + Operating Cash Flow - HIGH RISK of early stopping!');
                    }
                    
                    // Progress tracking for Call 2
                    if (data.debug_info.last_page_detected >= 11) {
                        console.log('âœ… PROGRESS: Call 2 successfully past slide 10 danger zone');
                    }
                }
            }
            
            // Show progress updates during report generation
            if (data.message) {
                updateProgress(data.message, data.progress || 0);
            }
            
            // Enhanced streaming progress notification with debug info
            if (data.chunk_number && data.chunk_number % 25 === 0) {
                let debugInfo = '';
                if (data.debug_info) {
                    debugInfo = ` [Slides: ${data.debug_info.slides_detected}, Page: ${data.debug_info.last_page_detected}]`;
                }
                
                showUserDebugSuccess('AI Generation Progress', 
                    `ðŸ“ ${data.message || 'Generating content'} (${data.chunk_number} chunks, ${((data.accumulated_html?.length || 0) / 1000).toFixed(1)}k chars)${debugInfo}`);
            }
            
            // ULTRA-DEBUG: Log milestone achievements for Call 2
            if (data.call_phase && data.call_phase.startsWith('call2') && data.chunk_number) {
                if (data.chunk_number === 100) {
                    console.log('ðŸ“Š CALL 2 MILESTONE 100: Early generation progress check');
                } else if (data.chunk_number === 200) {
                    console.log('ðŸ“Š CALL 2 MILESTONE 200: Mid-generation check - should see multiple slides');
                } else if (data.chunk_number === 400) {
                    console.log('ðŸ“Š CALL 2 MILESTONE 400: Late generation - should be approaching completion');
                }
            }
            
            // Update raw HTML code viewer with progressive accumulative content
            const rawHtmlCode = document.getElementById('rawHtmlCode');
            if (rawHtmlCode && data.accumulated_html) {
                let htmlContent = data.accumulated_html;
                
                // Initialize accumulated raw HTML storage if not exists
                if (!window.accumulatedRawHtml) {
                    window.accumulatedRawHtml = '';
                }
                
                // Handle different phases for progressive accumulative raw HTML display
                if (data.status === 'css_template_loaded') {
                    // Initialize with CSS template content
                    window.accumulatedRawHtml = htmlContent + `

<!-- ðŸ¤– AI GENERATION READY TO START -->
<!-- ðŸ“Š CSS Template loaded from CSScode.txt -->

`;
                    rawHtmlCode.textContent = window.accumulatedRawHtml;
                } else if (data.status === 'final_complete') {
                    // For final complete, use the locally accumulated HTML (which has everything)
                    console.log('ðŸ Final complete - using window.accumulatedRawHtml:', window.accumulatedRawHtml ? window.accumulatedRawHtml.length : 0, 'chars');
                    console.log('ðŸ Backend data.accumulated_html:', data.accumulated_html ? data.accumulated_html.length : 0, 'chars');
                    
                    // Use local accumulated content which has been building up during streaming
                    let finalHtml = window.accumulatedRawHtml;
                    
                    // Add final completion marker
                    finalHtml += `

<!-- ðŸŽ‰ REPORT GENERATION COMPLETE -->
</body>
</html>`;
                    
                    rawHtmlCode.textContent = finalHtml;
                    console.log('âœ… Raw HTML updated with complete accumulated content:', finalHtml.length, 'chars');
                } else if (data.call_phase === 'call1' && data.chunk_number === 1) {
                    // At the start of Call 1, add separator and start accumulating
                    window.accumulatedRawHtml += `
<!-- ðŸ¤– CALL 1 STARTED -->
<!-- ðŸ“Š Phase: CALL 1 (Slides 1-7) -->

` + htmlContent;
                    rawHtmlCode.textContent = window.accumulatedRawHtml;
                } else if (data.call_phase === 'call2' && data.chunk_number === 1) {
                    // At the start of Call 2, add separator and continue accumulating
                    window.accumulatedRawHtml += `

<!-- ðŸ¤– CALL 1 COMPLETE - STARTING CALL 2 -->
<!-- ðŸ“Š Phase: CALL 2 (Slides 8-15) -->

` + htmlContent;
                    rawHtmlCode.textContent = window.accumulatedRawHtml;
                } else if (data.call_phase === 'call1' || data.call_phase === 'call2') {
                    // For streaming phases, truly accumulate content progressively  
                    if (data.call_phase === 'call1') {
                        // For Call 1 streaming, replace only the Call 1 content
                        const cssAndStart = window.accumulatedRawHtml.split('<!-- ðŸ¤– CALL 1 STARTED -->')[0];
                        window.accumulatedRawHtml = cssAndStart + `<!-- ðŸ¤– CALL 1 STARTED -->
<!-- ðŸ“Š Phase: CALL 1 (Slides 1-7) -->
` + htmlContent;
                    } else if (data.call_phase === 'call2') {
                        // For Call 2 streaming, keep all Call 1 content and replace only Call 2 content
                        const beforeCall2 = window.accumulatedRawHtml.split('<!-- ðŸ¤– CALL 2 STARTED -->')[0];
                        window.accumulatedRawHtml = beforeCall2 + `<!-- ðŸ¤– CALL 2 STARTED -->
<!-- ðŸ“Š Phase: CALL 2 (Slides 8-15) -->
` + htmlContent;
                    }
                    rawHtmlCode.textContent = window.accumulatedRawHtml;
                }
                
                // Auto-scroll to bottom to show latest content
                rawHtmlCode.scrollTop = rawHtmlCode.scrollHeight;
                console.log('ðŸ“„ Raw HTML progressively updated:', window.accumulatedRawHtml.length, 'total chars');
            }
            
            // Update rendered report viewer with live preview during streaming
            const renderedReportViewer = document.getElementById('renderedReportViewer');
            
            // CHECK: Don't override if report is already completed
            if (renderedReportViewer && renderedReportViewer.getAttribute('data-report-completed') === 'true') {
                console.log('ðŸ”’ WEBSOCKET STREAMING BLOCKED - Report already completed, ignoring streaming update');
                return;
            }
            
            if (renderedReportViewer && data.accumulated_html) {
                // Add enhanced streaming indicator for report generation
                let streamingHtml = data.accumulated_html;
                // Handle different streaming phases
                if (data.status && data.status.startsWith('streaming_html') && isGeneratingReport) {
                    const statusMessage = data.message || 'Generating content';
                    const spinnerStyle = 'display: inline-block; animation: spin 1s linear infinite; margin-right: 8px;';
                    const callPhase = data.call_phase || 'generation';
                    const phaseLabel = callPhase === 'call1' ? 'CALL 1 (Slides 1-7)' : 
                                     callPhase === 'call2' ? 'CALL 2 (Slides 8-15)' : 
                                     'AI Generation';
                    
                    // Store the current call content separately to prevent mixing
                    if (callPhase === 'call1') {
                        // During Call 1, show only Call 1 content
                        streamingHtml = `
                            <div class="live-generation-banner" style="background: linear-gradient(135deg, #005F90, #FF6B35); color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold; box-shadow: 0 4px 12px rgba(0,95,144,0.3);">
                                <div style="${spinnerStyle}">âš¡</div>
                                ðŸ¤– Live ${phaseLabel}: ${statusMessage}
                                <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">
                                    Chunk ${data.chunk_number} â€¢ ${(data.accumulated_html.length / 1000).toFixed(1)}k characters â€¢ Real-time streaming
                                </div>
                            </div>
                        ` + data.accumulated_html;
                        
                        // Store Call 1 content for later combination
                        window.call1Content = data.accumulated_html;
                    } else if (callPhase === 'call2') {
                        // During Call 2, validate Call 1 is complete before showing combination
                        const call1Html = window.call1Content || '';
                        
                        // Check if Call 1 is properly completed (contains slide 7)
                        const call1Complete = call1Html.includes('Page 7 / 15');
                        
                        if (!call1Complete) {
                            // If Call 1 is not complete, show warning and only Call 1 content
                            streamingHtml = `
                                <div class="warning-banner" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold;">
                                    âš ï¸ Call 1 incomplete - waiting for completion before showing Call 2
                                </div>
                            ` + call1Html;
                        } else {
                            // Call 1 is complete, continue with Call 2 in same document with proper spacing
                            let call2Html = data.accumulated_html;
                            
                            // Add proper spacing between Call 1 and Call 2
                            let combinedHtml = call1Html + `

<!-- ===== CALL 2 CONTINUATION (Slides 8-15) ===== -->

` + call2Html;
                            
                            streamingHtml = `
                                <div class="live-generation-banner" style="background: linear-gradient(135deg, #005F90, #FF6B35); color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold; box-shadow: 0 4px 12px rgba(0,95,144,0.3);">
                                    <div style="${spinnerStyle}">âš¡</div>
                                    ðŸ¤– Live ${phaseLabel}: ${statusMessage}
                                    <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">
                                        Chunk ${data.chunk_number} â€¢ ${(data.accumulated_html.length / 1000).toFixed(1)}k characters â€¢ Real-time streaming
                                    </div>
                                </div>
                            ` + combinedHtml;
                        }
                    } else {
                        // Default streaming
                        streamingHtml = `
                            <div class="live-generation-banner" style="background: linear-gradient(135deg, #005F90, #FF6B35); color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold; box-shadow: 0 4px 12px rgba(0,95,144,0.3);">
                                <div style="${spinnerStyle}">âš¡</div>
                                ðŸ¤– Live ${phaseLabel}: ${statusMessage}
                                <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">
                                    Chunk ${data.chunk_number} â€¢ ${(data.accumulated_html.length / 1000).toFixed(1)}k characters â€¢ Real-time streaming
                                </div>
                            </div>
                        ` + data.accumulated_html;
                    }
                }
                
                // Handle Call 1 incomplete - show warning
                else if (data.status === 'call1_incomplete') {
                    const call1Html = data.accumulated_html || '';
                    streamingHtml = `
                        <div class="error-banner" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 20px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold; font-size: 16px;">
                            ðŸš¨ CALL 1 INCOMPLETE: Missing slide 7 - Generation stopped early
                            <div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
                                Please retry the generation. Current content: ${call1Html.length.toLocaleString()} characters
                            </div>
                        </div>
                    ` + call1Html;
                    
                    // Update the main streaming content
                    if (streamingContainer) {
                        streamingContainer.innerHTML = streamingHtml;
                    }
                    
                    // Update raw HTML view
                    rawHtmlContent = streamingHtml;
                    updateRawHtmlView();
                    
                    // Update rendered preview 
                    updateRenderedPreview(streamingHtml);
                    
                    console.error('ðŸš¨ CALL 1 INCOMPLETE detected - missing slide 7');
                }
                
                // Handle Call 1 completion - show only Call 1 content
                else if (data.status === 'call1_complete') {
                    // Validate Call 1 completion before storing
                    const call1Html = data.accumulated_html;
                    const call1Complete = call1Html.includes('Page 7 / 15');
                    
                    if (!call1Complete) {
                        console.warn('âš ï¸ Call 1 marked complete but missing slide 7!');
                        streamingHtml = `
                            <div class="warning-banner" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold;">
                                âš ï¸ Call 1 incomplete - missing slide 7 (${call1Html.length.toLocaleString()} chars generated)
                            </div>
                        ` + call1Html;
                    } else {
                        // Store complete Call 1 content for combining with Call 2
                        window.call1Content = call1Html;
                        streamingHtml = `
                            <div class="completion-banner" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold;">
                                âœ… ${data.message} (All 7 slides generated)
                            </div>
                        ` + call1Html;
                    }
                }
                
                // Handle Call 2 completion - this will be replaced by final complete
                else if (data.status === 'call2_complete') {
                    // Don't update the display here, wait for final_complete
                    return;
                }
                
                // Handle final completion - show complete report
                else if (data.status === 'final_complete') {
                    streamingHtml = `
                        <div class="completion-banner" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; font-weight: bold;">
                            ðŸŽ‰ ${data.message}
                        </div>
                    ` + data.accumulated_html;
                    
                    // Mark report as completed to prevent further streaming updates
                    if (renderedReportViewer) {
                        renderedReportViewer.setAttribute('data-report-completed', 'true');
                    }
                }
                
                renderedReportViewer.innerHTML = streamingHtml;
                renderedReportViewer.scrollTop = renderedReportViewer.scrollHeight; // Auto-scroll to bottom
                console.log('ðŸŽ¨ Rendered report updated with streaming preview:', streamingHtml.length, 'chars');
            }
            
            // Update streaming status message
            if (data.chunk_number % 5 === 0) {  // Show every 5th chunk to avoid spam
                showUserDebugSuccess('Live Report Generation', 
                    `${data.message} | Progress: ${data.progress}%`);
            }
        }

        // Refresh Analysis
        function refreshCurrentAnalysis() {
            if (!currentAnalysis || !currentProject) return;
            
            // Clear cache for this analysis
            const cacheKey = currentProject.ticker + '_' + currentAnalysis;
            delete analysisCache[cacheKey];
            
            // Restart analysis
            startSpecialistAnalysis(currentAnalysis);
        }

        // Utility Functions
        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function updateApiStatus(status) {
            const apiStatus = document.getElementById('apiStatus');
            const statusMap = {
                'ready': { class: 'api-ready', icon: 'check-circle', text: 'API Ready' },
                'suspended': { class: 'api-suspended', icon: 'exclamation-triangle', text: 'API Issues' },
                'error': { class: 'api-suspended', icon: 'times-circle', text: 'API Error' },
                'fallback': { class: 'fallback-mode', icon: 'shield-alt', text: 'Fallback Mode' }
            };
            
            const config = statusMap[status] || statusMap['error'];
            apiStatus.className = 'status-indicator ' + config.class;
            apiStatus.innerHTML = '<i class="fas fa-' + config.icon + '"></i><span>' + config.text + '</span>';
        }

        function updateAnalysisTitle(title) {
            document.getElementById('analysisTitle').innerHTML = '<i class="fas fa-chart-area"></i> ' + title;
        }

        function updateProgress(message, percentage, phase = null) {
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            
            // Update basic progress
            progressText.textContent = message;
            progressBar.style.width = percentage + '%';
            
            // Add phase-specific styling and icons
            if (phase) {
                let phaseIcon = '';
                let phaseClass = '';
                
                switch(phase) {
                    case 'call1_starting':
                        phaseIcon = 'ðŸš€ ';
                        phaseClass = 'phase-starting';
                        break;
                    case 'call1_complete':
                        phaseIcon = 'âœ… ';
                        phaseClass = 'phase-complete';
                        break;
                    case 'transition':
                        phaseIcon = 'ðŸ”„ ';
                        phaseClass = 'phase-transition';
                        break;
                    case 'call2_starting':
                        phaseIcon = 'ðŸš€ ';
                        phaseClass = 'phase-starting';
                        break;
                    default:
                        phaseIcon = 'âš¡ ';
                        phaseClass = 'phase-working';
                }
                
                progressText.innerHTML = phaseIcon + message;
                progressText.className = 'progress-text ' + phaseClass;
                
                // Add loading spinner for active phases
                if (phase === 'call1_starting' || phase === 'transition' || phase === 'call2_starting') {
                    progressText.innerHTML += ' <span class="loading-spinner">â—</span>';
                }
            }
        }

        function addResearchSource(source) {
            const sourcesSection = document.getElementById('sourcesSection');
            const sourcesGrid = document.getElementById('sourcesGrid');
            
            sourcesSection.style.display = 'block';
            
            const sourceCard = document.createElement('a');
            sourceCard.className = 'source-card';
            sourceCard.href = source.url;
            sourceCard.target = '_blank';
            sourceCard.innerHTML = 
                '<div class="source-header">' +
                    '<div class="source-index">' + source.index + '</div>' +
                    '<div class="source-title">' + source.title + '</div>' +
                '</div>' +
                '<div class="source-meta">' +
                    '<span class="credibility-badge">' + Math.round(source.credibility_score * 100) + '%</span>' +
                    '<span style="font-size: 10px; color: var(--text-muted);">' + source.type + '</span>' +
                '</div>';
            
            sourcesGrid.appendChild(sourceCard);
        }

        function displaySources(sources) {
            const sourcesSection = document.getElementById('sourcesSection');
            const sourcesGrid = document.getElementById('sourcesGrid');
            
            sourcesGrid.innerHTML = '';
            
            sources.forEach((source, index) => {
                const sourceCard = document.createElement('a');
                sourceCard.className = 'source-card';
                sourceCard.href = source.url;
                sourceCard.target = '_blank';
                sourceCard.innerHTML = 
                    '<div class="source-header">' +
                        '<div class="source-index">' + (index + 1) + '</div>' +
                        '<div class="source-title">' + source.title + '</div>' +
                    '</div>' +
                    '<div class="source-meta">' +
                        '<span class="credibility-badge">' + Math.round((source.credibility_score || 0.9) * 100) + '%</span>' +
                        '<span style="font-size: 10px; color: var(--text-muted);">Research Source</span>' +
                    '</div>';
                sourcesGrid.appendChild(sourceCard);
            });
            
            sourcesSection.style.display = sources.length > 0 ? 'block' : 'none';
        }

        let accumulatedContent = ""; // Global variable to accumulate streaming content
        let currentAnalystType = null; // Track which analyst is currently active
        let isGeneratingReport = false; // Track if we're in report generation mode
        
        function appendStreamingContent(content) {
            console.log('ðŸ’» appendStreamingContent called with:', content ? content.length : 'NO CONTENT', 'chars');
            
            // During report generation, this function is NOT used (report uses handleReportGenerationStreaming)
            // But for regular analysis streaming, continue as normal
            if (isGeneratingReport) {
                console.log('â„¹ï¸ Report generation in progress - this streaming content is for regular analysis, not report generation');
                // For report generation, we rely on handleReportGenerationStreaming instead
                return;
            }
            
            // Get the correct content div for the current analyst
            if (!currentAnalystType) {
                console.warn('âš ï¸ No current analyst type set');
                return;
            }
            
            const contentId = getAnalystContentId(currentAnalystType);
            const contentDiv = document.getElementById(contentId);
            console.log('ðŸ“º contentDiv found:', !!contentDiv, contentDiv ? contentDiv.id : 'NOT FOUND');
            
            if (contentDiv && content) {
                // Accumulate content for progressive streaming
                accumulatedContent += content;
                
                // Convert accumulated markdown to formatted HTML for professional display (NO CITATIONS)
                const formattedContent = formatMarkdownContentWithoutCitations(accumulatedContent);
                contentDiv.innerHTML = formattedContent;
                console.log('âœ… Content streamed and formatted. Chunk:', content.length, 'Total:', accumulatedContent.length);
                // Auto-scroll to bottom
                contentDiv.scrollTop = contentDiv.scrollHeight;
            } else {
                console.error('âŒ Cannot append content:', {contentDiv: !!contentDiv, content: !!content});
            }
        }

        // User-visible debug functions
        function showUserDebugError(title, message, solutions) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position: fixed; top: 120px; right: 20px; background: #fff5f5; border: 1px solid #fed7d7; border-radius: 6px; padding: 12px; max-width: 280px; z-index: 2000; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 12px;';
            
            // Safely handle solutions parameter
            let solutionsHTML = '';
            if (solutions && Array.isArray(solutions) && solutions.length > 0) {
                const solutionsList = solutions.slice(0, 2).map(sol => '<li style="margin: 2px 0; font-size: 11px;">' + sol + '</li>').join('');
                solutionsHTML = '<div style="color: #744210; font-size: 11px;"><strong>Fix:</strong><ul style="margin: 4px 0 0 12px; padding: 0;">' + solutionsList + '</ul></div>';
            }
            
            errorDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;"><span style="color: #f56565; font-size: 12px;">ðŸš¨</span><strong style="color: #c53030; font-size: 12px;">' + title + '</strong><button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 14px; cursor: pointer; color: #c53030;">Ã—</button></div><div style="color: #744210; font-size: 11px; margin-bottom: 6px;">' + message + '</div>' + solutionsHTML;
            
            document.body.appendChild(errorDiv);
            setTimeout(() => { if (errorDiv.parentNode) errorDiv.remove(); }, 8000);
        }
        
        function showUserDebugSuccess(title, message, actions = null) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 120px; right: 20px; background: #f0fff4; border: 1px solid #c6f6d5; border-radius: 6px; padding: 10px; max-width: 280px; z-index: 2000; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 12px;';
            
            let actionsHTML = '';
            if (actions && actions.length > 0) {
                actionsHTML = '<div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">';
                actions.forEach(action => {
                    const buttonId = 'action-btn-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    actionsHTML += `<button id="${buttonId}" style="
                        background: #2f855a; 
                        color: white; 
                        border: none; 
                        padding: 4px 8px; 
                        border-radius: 4px; 
                        font-size: 11px; 
                        cursor: pointer;
                        transition: background 0.2s ease;
                    " onmouseover="this.style.background='#38a169'" onmouseout="this.style.background='#2f855a'">${action.text}</button>`;
                    
                    // Store action for later execution
                    setTimeout(() => {
                        const btn = document.getElementById(buttonId);
                        if (btn) {
                            btn.onclick = () => {
                                action.action();
                                successDiv.remove();
                            };
                        }
                    }, 100);
                });
                actionsHTML += '</div>';
            }
            
            successDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 4px;"><span style="color: #48bb78; font-size: 12px;">âœ…</span><strong style="color: #2f855a; font-size: 12px;">' + title + '</strong><button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 14px; cursor: pointer; color: #2f855a;">Ã—</button></div><div style="color: #2f855a; font-size: 11px; margin-top: 4px;">' + message + '</div>' + actionsHTML;
            
            document.body.appendChild(successDiv);
            setTimeout(() => { if (successDiv.parentNode) successDiv.remove(); }, actions ? 10000 : 5000); // Longer timeout if actions are present
        }
        
        function showUserDebugWarning(title, message, suggestions) {
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; background: linear-gradient(135deg, #fff8dc, #ffeaa7); border: 2px solid #ed8936; border-radius: 12px; padding: 18px; max-width: 380px; z-index: 2000; box-shadow: 0 6px 25px rgba(237, 137, 54, 0.2); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;';
            
            const suggestionsList = suggestions ? suggestions.map(sug => '<li style="margin: 3px 0;">' + sug + '</li>').join('') : '';
            
            warningDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;"><i class="fas fa-exclamation-circle" style="color: #ed8936; font-size: 17px;"></i><strong style="color: #c05621; font-size: 15px;">' + title + '</strong><button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 17px; cursor: pointer; color: #c05621;">Ã—</button></div><div style="color: #c05621; font-size: 13px;">' + message + '</div>' + (suggestions ? '<div style="color: #c05621; font-size: 12px; margin-top: 8px;"><strong>Suggestions:</strong><ul style="margin: 6px 0 0 16px; padding: 0;">' + suggestionsList + '</ul></div>' : '') + '';
            
            document.body.appendChild(warningDiv);
            setTimeout(() => { if (warningDiv.parentNode) warningDiv.remove(); }, 10000);
        }

        function showUserDebugInfo(title, message) {
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = 'position: fixed; top: 160px; right: 20px; background: #ebf8ff; border: 1px solid #90cdf4; border-radius: 6px; padding: 12px; max-width: 280px; z-index: 2000; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 12px;';
            
            infoDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;"><span style="color: #3182ce; font-size: 12px;">â„¹ï¸</span><strong style="color: #2c5282; font-size: 12px;">' + title + '</strong><button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 14px; cursor: pointer; color: #2c5282;">Ã—</button></div><div style="color: #2c5282; font-size: 11px;">' + message + '</div>';
            
            document.body.appendChild(infoDiv);
            setTimeout(() => { if (infoDiv.parentNode) infoDiv.remove(); }, 6000);
        }

        function updatePersistentProgressIndicator(status, message) {
            // Remove any existing persistent indicator
            const existing = document.getElementById('persistent-progress-indicator');
            if (existing) existing.remove();
            
            // Create persistent progress indicator that stays visible
            const progressDiv = document.createElement('div');
            progressDiv.id = 'persistent-progress-indicator';
            progressDiv.style.cssText = `
                position: fixed; 
                top: 20px; 
                right: 20px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; 
                border-radius: 12px; 
                padding: 16px 20px; 
                max-width: 320px; 
                z-index: 2001; 
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); 
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
                font-size: 13px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // Add spinning animation for active generation
            const spinner = status === 'ai_generating' ? '<div style="display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-right: 8px;"></div>' : '';
            
            progressDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    ${spinner}
                    <strong style="font-size: 14px;">ðŸ¤– AI Report Generation</strong>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 24px; height: 24px; color: white; cursor: pointer; font-size: 16px;">Ã—</button>
                </div>
                <div style="color: rgba(255,255,255,0.9); font-size: 12px; line-height: 1.4;">
                    ${message}
                </div>
                <div style="background: rgba(255,255,255,0.2); height: 4px; border-radius: 2px; margin-top: 12px; overflow: hidden;">
                    <div style="background: white; height: 100%; width: 70%; border-radius: 2px; animation: pulse 2s ease-in-out infinite;"></div>
                </div>
            `;
            
            document.body.appendChild(progressDiv);
            
            // Add CSS animations if not already added
            if (!document.getElementById('progress-animations')) {
                const style = document.createElement('style');
                style.id = 'progress-animations';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Citation-free markdown processing for streaming (prevents double conversion)
        function formatMarkdownContentWithoutCitations(content) {
            console.log('ðŸŽ¯ Processing streaming content WITHOUT citation conversion, length:', content.length);
            
            let processedContent = content;
            
            // STEP 1: Process markdown elements (NO CITATIONS)
            processedContent = processedContent
                // Headers
                .replace(/^### (.*$)/gim, '<h3 class="report-h3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="report-h2">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="report-h1">$1</h1>')
                
                // Bold and italic
                .replace(/\*\*([^*]+?)\*\*/g, '<strong class="report-bold">$1</strong>')
                .replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em class="report-italic">$1</em>')
                
                // Code
                .replace(/```([\s\S]*?)```/g, '<pre class="report-code"><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code class="report-inline-code">$1</code>')
                
                // Lists
                .replace(/^[\*\-] (.+)$/gm, '<li class="report-list-item">$1</li>');
            
            // Wrap list items in ul tags
            processedContent = processedContent.replace(/(<li class="report-list-item">.*?<\/li>)(\s*<li class="report-list-item">.*?<\/li>)*/gs, function(match) {
                return '<ul class="report-list">' + match + '</ul>';
            });
            
            // Handle paragraphs (simple)
            processedContent = processedContent
                .replace(/\n\n+/g, '</p><p class="report-paragraph">')
                .replace(/^(?!<[uh]|<li|<t[rd]|<pre|<table|<span)/gm, '<p class="report-paragraph">')
                .replace(/(?<!>|"])$/gm, '</p>');
            
            return processedContent;
        }

        function formatMarkdownContent(content) {
            // SIMPLIFIED and RELIABLE content formatting
            console.log('ðŸŽ¯ Processing content for formatting, length:', content.length);
            
            // COMPREHENSIVE FRONTEND CITATION DEBUG TRACE
            console.log('ðŸ” *** FRONTEND formatMarkdownContent DEBUG TRACE START ***');
            console.log('   ðŸ“Š Input content length:', content.length);
            console.log('   ðŸ“Š Input content type:', typeof content);
            console.log('   ðŸ“„ Input content preview (first 300):', content.substring(0, 300));
            console.log('   ðŸ“„ Input content preview (chars 1000-1300):', content.substring(1000, 1300));
            console.log('   ðŸ“„ Input content preview (last 300):', content.substring(content.length - 300));
            
            // CRITICAL DEBUG: Check if content already has HTML citations
            const existingHtmlCitations = content.includes('<span class="citation-marker"');
            console.log('   ðŸš¨ CRITICAL: Content already has HTML citations?', existingHtmlCitations);
            if (existingHtmlCitations) {
                const sampleHtml = content.match(/<span[^>]*citation-marker[^>]*>[^<]*<\/span>/g);
                console.log('   ðŸ“„ Existing HTML citation samples:', sampleHtml ? sampleHtml.slice(0, 3) : 'NONE');
            }
            
            // Check for incoming citations with non-overlapping patterns
            let incomingCitations = 0;
            let processedContent = content;
            
            // Count citations more accurately - exclude years like (2024)
            const allCitationMatches = content.match(/\[[\s]*(\d{1,2})[\s]*\]|\([\s]*(\d{1,2})[\s]*\)/g) || [];
            incomingCitations = allCitationMatches.length;
            
            console.log('ðŸ“Š INPUT: Found', incomingCitations, 'citation patterns');
            
            // DETAILED CITATION PATTERN DEBUG
            console.log('   ðŸ” Citation pattern matches:', allCitationMatches.slice(0, 15));
            
            // Test different patterns separately for debugging - exclude years
            const bracketCitations = content.match(/\[(\d{1,2})\]/g) || [];
            const spacedBracketCitations = content.match(/\[\s*(\d{1,2})\s*\]/g) || [];
            const parenCitations = content.match(/\(\s*(\d{1,2})\s*\)/g) || [];
            
            console.log('   ðŸ“š Bracket [1] patterns:', bracketCitations.length, 'examples:', bracketCitations.slice(0, 5));
            console.log('   ðŸ“š Spaced [ 1 ] patterns:', spacedBracketCitations.length, 'examples:', spacedBracketCitations.slice(0, 5));
            console.log('   ðŸ“š Paren (1) patterns:', parenCitations.length, 'examples:', parenCitations.slice(0, 5));
            
            // Check specific content locations for citations
            const sampleLocations = [0, 500, 1000, 2000, 5000, content.length - 1000, content.length - 500];
            for (const pos of sampleLocations) {
                if (pos >= 0 && pos < content.length) {
                    const sample = content.substring(pos, Math.min(pos + 100, content.length));
                    const citationsInSample = (sample.match(/\[(\d+)\]/g) || []).length;
                    if (citationsInSample > 0) {
                        console.log('   ðŸ“ Citations at position ' + pos + ': ' + citationsInSample + ' found in: "' + sample.replace(/\n/g, '\\n') + '"');   
                    }
                }
            }
            
            // STEP 1: Process citations FIRST (before any other processing)
            let htmlCitations = 0; // FIXED: Define outside block scope
            
            if (incomingCitations > 0) {
                const beforeProcessing = processedContent;
                
                // ONLY process citations if this is the final content handler call
                if (window.isProcessingFinalContent === true) {
                    console.log('   âœ… FINAL CONTENT MODE: Processing citations for final display');
                    
                    // FIRST: Clean up any existing malformed citations
                    processedContent = processedContent
                        .replace(/\[(\d+)\]\">\[(\d+)\]/g, '[$1]')  // Fix [25]">[25] â†’ [25]
                        .replace(/\[(\d+)\]"\s*>\s*\[(\d+)\]/g, '[$1]'); // Fix variations
                    console.log('   ðŸ§¹ Cleaned malformed citations, new length:', processedContent.length);
                    
                    // ULTIMATE FIX: Only convert citations in main content, not sources section
                    let sourcesIndex = processedContent.indexOf('ðŸ“š Research Sources');
                    if (sourcesIndex === -1) {
                        sourcesIndex = processedContent.indexOf('## ðŸ“š Research Sources');
                    }
                    console.log('   ðŸ“ Sources section found at index:', sourcesIndex);
                    
                    if (sourcesIndex > 0) {
                        // Split into main content and sources
                        const mainContent = processedContent.substring(0, sourcesIndex);
                        const sourcesContent = processedContent.substring(sourcesIndex);
                        
                        // Only process citations in main content - FIXED APPROACH
                        console.log('   ðŸ”§ Processing main content for citations, length:', mainContent.length);
                        const processedMain = mainContent
                            .replace(/\[(\d{1,2})\]/g, function(match, num) {
                                const safeNum = parseInt(num);
                                const html = '<span class="citation-marker" onclick="openCitationSource(' + safeNum + ')">[' + safeNum + ']</span>';
                                console.log('   ðŸ”„ Converting', match, 'â†’', html);
                                return html;
                            });
                        console.log('   âœ… Main content processed with', (processedMain.match(/class="citation-marker"/g) || []).length, 'citations');
                        
                        // Combine main content (with processed citations) + sources (unchanged)
                        processedContent = processedMain + sourcesContent;
                    } else {
                        // No sources section, process entire content - FIXED APPROACH
                        console.log('   ðŸ”§ Processing entire content for citations (no sources section)');
                        processedContent = processedContent
                            .replace(/\[(\d{1,2})\]/g, function(match, num) {
                                const safeNum = parseInt(num);
                                const html = '<span class="citation-marker" onclick="openCitationSource(' + safeNum + ')">[' + safeNum + ']</span>';
                                console.log('   ðŸ”„ Converting', match, 'â†’', html);
                                return html;
                            });
                        console.log('   âœ… Full content processed with', (processedContent.match(/class="citation-marker"/g) || []).length, 'citations');
                    }
                    
                    htmlCitations = (processedContent.match(/<span class="citation-marker"/g) || []).length;
                    console.log('   ðŸŽ¯ FINAL: Converted', incomingCitations, 'to', htmlCitations, 'HTML citations');
                    
                    // ENHANCED DEBUG: Show conversion samples
                    const conversionSamples = processedContent.match(/<span class="citation-marker"[^>]*>\[(\d+)\]<\/span>/g) || [];
                    console.log('   ðŸ” CONVERSION SAMPLES:', conversionSamples.slice(0, 5));
                    
                    // Check for double-conversion patterns
                    const doublePatterns = processedContent.match(/\[(\d+)\]\">\[(\d+)\]/g) || [];
                    if (doublePatterns.length > 0) {
                        console.error('   ðŸš¨ DOUBLE CONVERSION DETECTED:', doublePatterns.slice(0, 3));
                    }
                } else {
                    console.log('   âš ï¸ STREAMING MODE: Skipping citation conversion to prevent double processing');
                    htmlCitations = 0;  // No citations processed during streaming
                    
                    console.log('   ðŸ”§ Added parentheses citation conversion: (1) â†’ HTML markers');
                    
                    // DEBUG: Show actual HTML being generated
                    const citationSample = processedContent.match(/<span class="citation-marker"[^>]*>\[\d+\]<\/span>/g) || [];
                    console.log('   ðŸ” Generated citation HTML samples:', citationSample.slice(0, 3));
                    
                    // TEST: Verify onclick handlers are properly added
                    const onclickMatches = processedContent.match(/onclick="openCitationSource\(\d+\)"/g) || [];
                    console.log('   ðŸ–±ï¸ Citation onclick handlers:', onclickMatches.length, 'found');
                    console.log('   ðŸ–±ï¸ Onclick samples:', onclickMatches.slice(0, 3));
                    
                    // Verify citations were converted with ENHANCED DEBUG
                    htmlCitations = (processedContent.match(/class="citation-marker"/g) || []).length;
                    
                    console.log('   ðŸ”„ Citation conversion results:');
                    console.log('   ðŸ“Š Input citations:', incomingCitations);
                    console.log('   ðŸ“Š Output HTML citations:', htmlCitations);
                    console.log('   ðŸ“„ Before processing sample:', beforeProcessing.substring(0, 500));
                    console.log('   ðŸ“„ After processing sample:', processedContent.substring(0, 500));
                }
                
                // Check for leftover unconverted citations
                const leftoverCitations = (processedContent.match(/\[(\d+)\]/g) || []).length;
                if (leftoverCitations > 0) {
                    console.warn('   âš ï¸ Leftover unconverted citations:', leftoverCitations);
                    const leftoverExamples = processedContent.match(/\[(\d+)\]/g);
                    console.log('   ðŸ“ Leftover examples:', leftoverExamples.slice(0, 5));
                }
                
                if (htmlCitations !== incomingCitations) {
                    console.error('âŒ Citation conversion failed:', htmlCitations, 'vs expected', incomingCitations);
                    console.log('   ðŸ”§ Conversion rate:', ((htmlCitations / incomingCitations) * 100).toFixed(1) + '%');
                    // REMOVED: Annoying citation formatting error notification
                    // Minor citation count mismatches are normal and don't affect functionality
                } else {
                    console.log('âœ… Citations processed successfully:', incomingCitations);
                    if (incomingCitations >= 5) {
                        showUserDebugSuccess('Citations Loaded', 'Successfully formatted ' + incomingCitations + ' citations with clickable links');
                    }
                }
                
                console.log('âœ¨ Citations processed:', incomingCitations, 'â†’', htmlCitations);
            } else {
                console.log('âš ï¸ No citations found in content');
                console.log('ðŸ“„ Content preview:', content.substring(0, 500));
                
                // ENHANCED DEBUG FOR NO CITATIONS CASE
                console.log('   ðŸ” No citations debug:');
                console.log('   ðŸ“Š Content length:', content.length);
                console.log('   ðŸ“Š Content contains brackets:', (content.match(/\[/g) || []).length);
                console.log('   ðŸ“Š Content contains numbers:', (content.match(/\d/g) || []).length);
                console.log('   ðŸ“Š Content contains [number]:', (content.match(/\[\d/g) || []).length);
                
                // Sample different parts of content for citation check
                const positions = [0, Math.floor(content.length * 0.25), Math.floor(content.length * 0.5), Math.floor(content.length * 0.75), content.length - 500];
                for (const pos of positions) {
                    if (pos >= 0 && pos < content.length) {
                        const sample = content.substring(pos, Math.min(pos + 200, content.length));
                        console.log('   ðŸ“ Content at ' + pos + ': "' + sample.replace(/\n/g, '\\n').substring(0, 100) + '..."');
                    }
                }
                
                // REMOVED: Don't show citation warnings during streaming - citations only appear in final message
                // if (content.length > 5000) {
                //     showUserDebugWarning('No Citations Found', 
                //         'Analysis content is long but contains no citations. This may indicate a citation generation issue.',
                //         [
                //             'Check if backend generated citations properly',
                //             'Verify Google Search integration is working', 
                //             'Try running analysis again for citation generation',
                //             'Some analyses may legitimately have no external sources'
                //         ]
                //     );
                // }
            }
            
            console.log('ðŸ” *** FRONTEND formatMarkdownContent DEBUG TRACE END ***');
            
            // STEP 2: Process other markdown elements
            processedContent = processedContent
                // Headers
                .replace(/^### (.*$)/gim, '<h3 class="report-h3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="report-h2">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="report-h1">$1</h1>')
                
                // Bold and italic (be careful not to interfere with citations)
                .replace(/\*\*([^*]+?)\*\*/g, '<strong class="report-bold">$1</strong>')
                .replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em class="report-italic">$1</em>')
                
                // Code
                .replace(/```([\s\S]*?)```/g, '<pre class="report-code"><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code class="report-inline-code">$1</code>')
                
                // Tables (enhanced support for multiple formats)
                .replace(/^\|(.+)\|$/gm, function(match, content) {
                    const cells = content.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.some(cell => cell.includes('-'))) {
                        return ''; // Skip separator rows
                    }
                    const isHeader = content.includes('**') || /^[A-Z\s]+$/.test(content);
                    const tag = isHeader ? 'th' : 'td';
                    const cellsHtml = cells.map(cell => '<' + tag + '>' + cell + '</' + tag + '>').join('');
                    return '<tr>' + cellsHtml + '</tr>';
                })
                // Handle tables without pipes (AI-generated format)
                .replace(/^([A-Z][^|\n]*?)\s{4,}([A-Z][^|\n]*?)\s{4,}([A-Z][^|\n]*?)(\s{4,}([^|\n]*?))?(\s{4,}([^|\n]*?))?$/gm, function(match) {
                    console.log('ðŸ” Potential table header found:', match);
                    const parts = match.split(/\s{4,}/).filter(part => part.trim());
                    if (parts.length >= 3) {
                        const cellsHtml = parts.map(cell => '<th style="padding: 8px; border: 1px solid #ddd; background: #f5f5f5;">' + cell.trim() + '</th>').join('');
                        return '<tr>' + cellsHtml + '</tr>';
                    }
                    return match;
                })
                // Handle table separator lines (--- format)
                .replace(/^-{3,}.*$/gm, '')
                // Wrap table rows
                .replace(/(<tr>.*<\/tr>)/gs, '<table class="report-table" style="width: 100%; border-collapse: collapse; margin: 15px 0;">$1</table>')
                
                // Lists (more reliable)
                .replace(/^[\*\-] (.+)$/gm, '<li class="report-list-item">$1</li>');
            
            // STEP 3: Wrap consecutive list items in ul tags
            processedContent = processedContent.replace(/(<li class="report-list-item">.*?<\/li>)(\s*<li class="report-list-item">.*?<\/li>)*/gs, function(match) {
                return '<ul class="report-list">' + match + '</ul>';
            });
            
            // STEP 4: Handle paragraphs (citation-safe approach)
            processedContent = processedContent
                .replace(/\n\n+/g, '</p><p class="report-paragraph">')
                .replace(/^(?!<[uh]|<li|<t[rd]|<pre|<table|<span)/gm, '<p class="report-paragraph">')
                .replace(/(?<!>|"])$/gm, '</p>');
            
            // STEP 5: Clean up (preserve citation HTML)
            processedContent = processedContent
                .replace(/<\/p><p class="report-paragraph"><\/p>/g, '</p>')
                .replace(/^<p class="report-paragraph"><\/p>/g, '')
                .replace(/<p class="report-paragraph">(<[uh])/g, '$1')
                .replace(/(<\/[uh][1-6]>)<\/p>/g, '$1')
                .replace(/<p class="report-paragraph">(<span class="citation-marker")/g, '$1');
            
            // Final verification
            const finalCitationCount = (processedContent.match(/class="citation-marker"/g) || []).length;
            console.log('âœ… FINAL: Citations in output:', finalCitationCount, '/ Expected:', incomingCitations);
            
            return processedContent;
        }

        function openCitationSource(sourceNumber) {
            // Open the actual source URL in a new tab
            console.log('ðŸ”— Opening citation source:', sourceNumber);
            
            // Look for the source by number in the Research Sources section
            const sourceElements = document.querySelectorAll('a[href*="grounding-api-redirect"]');
            if (sourceElements && sourceElements.length >= sourceNumber) {
                const targetSource = sourceElements[sourceNumber - 1]; // Convert to 0-based index
                if (targetSource) {
                    const sourceUrl = targetSource.href;
                    console.log('ðŸŒ Opening URL:', sourceUrl);
                    
                    // Open in new tab
                    window.open(sourceUrl, '_blank');
                    
                    // Optional: Also scroll to show the source in the references
                    targetSource.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    // Briefly highlight the source
                    targetSource.style.background = 'rgba(0, 123, 123, 0.2)';
                    targetSource.style.padding = '4px 8px';
                    targetSource.style.borderRadius = '4px';
                    setTimeout(() => {
                        targetSource.style.background = '';
                        targetSource.style.padding = '';
                        targetSource.style.borderRadius = '';
                    }, 1500);
                }
            } else {
                console.warn('Source not found:', sourceNumber);
                // Fallback: try to scroll to sources section
                const sourcesElements = document.querySelectorAll('*');
                for (let element of sourcesElements) {
                    if (element.textContent && element.textContent.includes('Research Sources')) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        break;
                    }
                }
            }
        }
        
        // Keep the old function for backward compatibility
        function scrollToSource(sourceNumber) {
            openCitationSource(sourceNumber);
        }

        function handleFinalContentWithCitations(data) {
            // Replace accumulated content with final version that includes all citations
            console.log('ðŸŽ¯ FINAL CONTENT HANDLER CALLED');
            console.log('ðŸ“„ Data received:', {
                hasContent: !!data.content_complete,
                contentLength: data.content_complete ? data.content_complete.length : 0,
                citationsCount: data.citations_count,
                currentAnalyst: currentAnalystType
            });
            
            // CRITICAL: During report generation, DO NOT overwrite accumulated section content
            if (isGeneratingReport) {
                console.log('ðŸš« BLOCKED: handleFinalContentWithCitations during report generation - preserving section accumulated content');
                console.log('ðŸ“Š Report generation in progress - final content handler ignored to preserve section accumulation');
                return;
            }
            
            // CRITICAL DEBUGGING - Check citations in handler
            if (data.content_complete) {
                const handlerCitations = (data.content_complete.match(/\[(\d+)\]/g) || []).length;
                console.log('ðŸ” HANDLER DEBUG: Citations found in handleFinalContentWithCitations:', handlerCitations);
                console.log('ðŸ“„ Handler content sample:', data.content_complete.substring(0, 500));
                if (handlerCitations === 0 && data.citations_count > 0) {
                    console.error('âŒ CRITICAL: No citations found in handler despite backend reporting', data.citations_count);
                    console.log('ðŸ“„ Full content length:', data.content_complete.length);
                    console.log('ðŸ“„ Content type:', typeof data.content_complete);
                    
                    // Show user-visible error with fix instructions
                    showUserDebugError('Citation Processing Error', 
                        'Backend generated ' + data.citations_count + ' citations but they\'re not in the final content.', 
                        [
                            'This is a backend citation generation bug',
                            'Check backend logs for citation insertion failures',
                            'Try running the analysis again',
                            'If persistent, contact support with this error message'
                        ]
                    );
                } else if (handlerCitations > 0) {
                    // Show user success message
                    showUserDebugSuccess('âœ… Citations Received', 'Successfully received ' + handlerCitations + ' citations from backend');
                }
            } else {
                console.error('âŒ CRITICAL: No content_complete in final content handler');
                showUserDebugError('Missing Content Error', 
                    'Backend sent final message but content is missing.',
                    [
                        'This indicates a backend streaming error',
                        'Check if backend completed analysis properly',
                        'Try refreshing the page and running analysis again',
                        'If persistent, this is a server-side bug'
                    ]
                );
            }
            
            if (!currentAnalystType) {
                console.warn('âš ï¸ No current analyst type set for final content');
                // Try to use currentAnalysis as fallback
                if (currentAnalysis) {
                    console.log('ðŸ”„ Using currentAnalysis as fallback:', currentAnalysis);
                    currentAnalystType = currentAnalysis;
                } else {
                    console.error('âŒ No analyst type available - cannot apply final content');
                    return;
                }
            }
            
            const contentId = getAnalystContentId(currentAnalystType);
            const contentDiv = document.getElementById(contentId);
            
            console.log('ðŸŽ¯ Content div found:', !!contentDiv, 'ID:', contentId);
            
            if (contentDiv && data.content_complete) {
                // COMPREHENSIVE FINAL CONTENT DEBUG TRACE
                console.log('ðŸ” *** FRONTEND FINAL CONTENT DEBUG TRACE START ***');
                console.log('   ðŸ“Š Content div found:', !!contentDiv, 'ID:', contentDiv.id);
                console.log('   ðŸ“Š Data complete content length:', data.content_complete.length);
                console.log('   ðŸ“Š Data citations count from backend:', data.citations_count);
                
                // Show citations in content preview
                const citationCount = (data.content_complete.match(/\[(\d+)\]/g) || []).length;
                console.log('   ðŸ“š Citations in final content (regex count):', citationCount);
                console.log('   ðŸ“„ Final content preview (first 500 chars):', data.content_complete.substring(0, 500));
                
                // Debug: Check specific citation patterns
                const testCitations = data.content_complete.match(/\[(\d+)\]/g);
                console.log('   ðŸ” Citation patterns found:', testCitations ? testCitations.slice(0, 10) : 'NONE');
                
                // Check if content contains citations near end 
                const lastChars = data.content_complete.substring(data.content_complete.length - 1000);
                console.log('   ðŸ“„ Last 1000 chars preview:', lastChars.substring(0, 200) + '...');
                
                // Check citation distribution throughout content
                const contentLength = data.content_complete.length;
                const checkPositions = [0, contentLength * 0.2, contentLength * 0.4, contentLength * 0.6, contentLength * 0.8, contentLength - 500];
                for (const pos of checkPositions) {
                    const startPos = Math.floor(pos);
                    if (startPos >= 0 && startPos < contentLength) {
                        const sample = data.content_complete.substring(startPos, Math.min(startPos + 100, contentLength));
                        const sampleCitations = (sample.match(/\[(\d+)\]/g) || []).length;
                        if (sampleCitations > 0) {
                            console.log('   ðŸ“ Citations at ' + (pos/contentLength*100).toFixed(0) + '% (pos ' + startPos + '): ' + sampleCitations + ' found');
                        }
                    }
                }
                
                // Reset accumulated content
                accumulatedContent = data.content_complete;
                
                console.log('   ðŸŽ¯ About to call formatMarkdownContent with', data.content_complete.length, 'chars');
                
                // Set flag to enable citation processing for final content only
                window.isProcessingFinalContent = true;
                
                // Format and display the complete content with citations
                const formattedContent = formatMarkdownContent(data.content_complete);
                
                // Reset flag after processing
                window.isProcessingFinalContent = false;
                
                console.log('   ðŸŽ¯ formatMarkdownContent returned', formattedContent.length, 'chars');
                console.log('   ðŸ“š HTML citations in formatted content:', (formattedContent.match(/class="citation-marker"/g) || []).length);
                console.log('   ðŸ“„ Formatted content preview (first 300):', formattedContent.substring(0, 300));
                
                // CRITICAL DEBUG: Check citation HTML before DOM insertion
                console.log('   ðŸ” BEFORE DOM: Citation HTML samples:');
                const beforeDomCitations = formattedContent.match(/<span class="citation-marker"[^>]*onclick="[^"]*"[^>]*>\[(\d+)\]<\/span>/g) || [];
                console.log('   ðŸ“„ Before DOM citation samples:', beforeDomCitations.slice(0, 3));
                console.log('   ðŸ“Š Before DOM total citations:', beforeDomCitations.length);
                
                contentDiv.innerHTML = formattedContent;
                
                // CRITICAL DEBUG: Check what actually made it to DOM
                console.log('   ðŸ” AFTER DOM: What made it to DOM:');
                const afterDomCitations = contentDiv.innerHTML.match(/<span class="citation-marker"[^>]*onclick="[^"]*"[^>]*>\[(\d+)\]<\/span>/g) || [];
                console.log('   ðŸ“„ After DOM citation samples:', afterDomCitations.slice(0, 3));
                console.log('   ðŸ“Š After DOM total citations:', afterDomCitations.length);
                
                console.log('   âœ… Content applied to DOM element:', contentDiv.id);
                console.log('   ðŸ“Š Final DOM content length:', contentDiv.innerHTML.length);
                console.log('   ðŸ“š Final DOM citation markers:', (contentDiv.innerHTML.match(/class="citation-marker"/g) || []).length);
                
                // TEST: Verify citations are clickable in DOM
                const citationElements = contentDiv.querySelectorAll('.citation-marker');
                console.log('   ðŸ–±ï¸ Clickable citation elements found in DOM:', citationElements.length);
                if (citationElements.length > 0) {
                    console.log('   ðŸ–±ï¸ First citation element onclick:', citationElements[0].onclick);
                    console.log('   ðŸ–±ï¸ First citation element getAttribute onclick:', citationElements[0].getAttribute('onclick'));
                }
                console.log('ðŸ” *** FRONTEND FINAL CONTENT DEBUG TRACE END ***');
                
                // Add visual indicator that this is the final version
                const indicator = document.createElement('div');
                indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--robeco-blue); color: white; padding: 8px 16px; border-radius: 6px; font-size: 12px; z-index: 1000;';
                indicator.innerHTML = "âœ… Final version loaded with " + data.citations_count + " citations";
                document.body.appendChild(indicator);
                setTimeout(() => document.body.removeChild(indicator), 3000);
                
                console.log('âœ… FINAL CONTENT WITH CITATIONS APPLIED SUCCESSFULLY');
                console.log('ðŸ“Š Content length: ' + data.content_complete.length + ' chars');
                console.log('ðŸ“š Citations count: ' + data.citations_count);
                
                // Scroll to top to show the final result
                contentDiv.scrollTop = 0;
            } else {
                console.error('âŒ Cannot apply final content:', {
                    contentDiv: !!contentDiv, 
                    content: !!data.content_complete,
                    currentAnalyst: currentAnalystType
                });
                
                showUserDebugError('Cannot Display Analysis Results', 
                    'Final analysis content cannot be displayed due to missing DOM elements or analyst context.',
                    [
                        'This is a frontend display bug',
                        'The analysis completed successfully but cannot be shown',
                        'Try running the analysis for a different analyst type first',
                        'Refresh the page and try again',
                        'Check browser console for DOM element details'
                    ]
                );
            }
        }

        function handleAnalysisError(data) {
            console.error('âŒ Analysis error:', data);
            
            if (currentAnalysis) {
                updateAnalystStatus(currentAnalysis, 'error', 'Error');
            }
            
            updateProgress('Analysis failed', 0);
            document.getElementById('progressSection').classList.remove('active');
            
            // Show clear error message immediately
            let errorIcon = '<i class="fas fa-exclamation-triangle"></i>';
            let errorTitle = 'Analysis Failed';
            let errorMessage = data.error;
            
            if (data.error_type === 'api_suspended') {
                errorIcon = '<i class="fas fa-key"></i>';
                errorTitle = 'API Keys Suspended';
                updateApiStatus('suspended');
            }
            
            // Show the error prominently in current analyst page
            if (currentAnalystType) {
                const contentId = getAnalystContentId(currentAnalystType);
                document.getElementById(contentId).innerHTML = 
                '<div style="text-align: center; padding: 40px; border: 2px solid var(--investment-error); border-radius: 12px; background: rgba(245, 101, 101, 0.05);">' +
                    '<div style="font-size: 48px; color: var(--investment-error); margin-bottom: 16px;">' +
                        errorIcon +
                    '</div>' +
                    '<h2 style="color: var(--investment-error); margin-bottom: 16px;">' + errorTitle + '</h2>' +
                    '<p style="color: var(--text-primary); margin-bottom: 24px; font-size: 16px; font-weight: 500;">' +
                        errorMessage +
                    '</p>' +
                    (data.error_type === 'api_suspended' ? 
                    '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; text-align: left; font-family: monospace; margin-top: 20px;">' +
                        '<strong>To fix this:</strong><br><br>' +
                        '<code>export GEMINI_API_KEY=your_working_api_key</code><br><br>' +
                        'Then restart the server.' +
                    '</div>' : '') + 
                '</div>';
                
                // Show error in welcome screen too
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('analysisDisplay').style.display = 'block';
            }
        }

        // Export and Share Functions
        function downloadAnalysis() {
            if (!currentAnalysis || !currentProject) return;
            
            const contentId = getAnalystContentId(currentAnalysis);
            const content = document.getElementById(contentId).innerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = currentProject.ticker + '_' + currentAnalysis + '_analysis.html';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        function shareAnalysis() {
            if (!currentAnalysis || !currentProject) return;
            
            const shareData = {
                title: currentProject.company + ' ' + currentAnalysis + ' Analysis',
                text: currentAnalysis + ' analysis for ' + currentProject.company + ' (' + currentProject.ticker + ')',
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareData.title + '\n' + shareData.text);
                alert('Analysis details copied to clipboard');
            }
        }

        function generateTemplateReport() {
            console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ FUNCTION ENTRY: generateTemplateReport() called');
            console.log('ðŸŽ¯ JavaScript execution path reached');
            console.log('ðŸŽ¯ typeof currentProject:', typeof currentProject);
            console.log('ðŸŽ¯ currentProject value:', currentProject);
            
            console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ ABOUT TO CALL showUserDebugInfo...');
            
            // IMMEDIATE USER FEEDBACK - Always show that function was called
            try {
                showUserDebugInfo('Report Generation Starting', 
                    'ðŸš€ Report generation function has been called\n' +
                    'ðŸ“‹ Checking project setup and system status...\n' +
                    'â³ Please wait while we initialize the process'
                );
                console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ showUserDebugInfo completed successfully!');
            } catch (error) {
                console.error('âŒ ERROR in showUserDebugInfo:', error);
                alert('Error in showUserDebugInfo: ' + error.message);
            }
            
            if (!currentProject) {
                console.log('âŒ No currentProject found - showing error');
                showUserDebugError('No Project Setup', 'Please set up a project first before generating a report.');
                return;
            }
            
            console.log('âœ… currentProject exists, proceeding...');
            console.log('ðŸŽ¯ DEBUG: About to show success message...');
            console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ CHECKPOINT A: Before showUserDebugSuccess');
            
            // Update user that project is found
            showUserDebugSuccess('Project Found', 
                `âœ… Project: ${currentProject.company} (${currentProject.ticker})\n` +
                'ðŸ”„ Proceeding with report generation setup...'
            );
            
            console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ CHECKPOINT B: After showUserDebugSuccess');
            
            // âœ¨ IMMEDIATE USER FEEDBACK - Show loading state immediately
            console.log('ðŸ” About to call showUserDebugInfo...');
            try {
                showUserDebugInfo('Report Generation Started', 
                    'ðŸš€ Initiating AI report generation for ' + currentProject.company + ' (' + currentProject.ticker + ')...\n\n' +
                    'ðŸ“Š Preparing comprehensive investment analysis report\n' +
                    'ðŸ”„ This may take 1-2 minutes to complete'
                );
                console.log('âœ… showUserDebugInfo completed successfully');
            } catch (error) {
                console.error('âŒ Error in showUserDebugInfo:', error);
                alert('âŒ Error in showUserDebugInfo: ' + error.message);
            }
            
            // Update button to show processing state
            console.log('ðŸ” About to update button state...');
            showUserDebugInfo('Initializing UI', 'ðŸ”„ Updating button state and preparing interface...');
            
            const generateBtn = document.querySelector('.generate-report-btn');
            console.log('ðŸ” generateBtn found:', !!generateBtn);
            if (generateBtn) {
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Generating Report...';
                generateBtn.disabled = true;
                generateBtn.style.opacity = '0.7';
                console.log('âœ… Button state updated');
                showUserDebugSuccess('Button Updated', 'âœ… Generate button now shows processing state');
            }
            
            // Clear accumulated raw HTML for new report generation
            window.accumulatedRawHtml = '';
            window.lastAccumulatedContent = '';
            window.call1Content = '';
            
            // Clear raw HTML display
            const rawHtmlCode = document.getElementById('rawHtmlCode');
            if (rawHtmlCode) {
                rawHtmlCode.textContent = 'Raw HTML Code Generation\n\n<!-- ðŸ¤– Report Generation Starting... -->';
            }
            
            console.log('ðŸ“‹ Generating template-based report for', currentProject.ticker);
            
            // Collect all stored analyses from the persistence system
            console.log('ðŸ” Checking for stored analyses...');
            showUserDebugInfo('Checking Data', 'ðŸ” Searching for stored analyses...');
            console.log('ðŸ” window.robecoAnalysisPersistence exists:', !!window.robecoAnalysisPersistence);
            
            let storedAnalyses = [];
            try {
                storedAnalyses = window.robecoAnalysisPersistence.getAnalysesByTicker(currentProject.ticker);
                console.log('âœ… Successfully retrieved analyses:', storedAnalyses);
                showUserDebugSuccess('Data Retrieved', `âœ… Found ${storedAnalyses.length} stored analyses`);
            } catch (error) {
                console.error('âŒ Error getting stored analyses:', error);
                showUserDebugError('Data Error', 'âŒ Error getting stored analyses: ' + error.message);
                return;
            }
            
            // Allow report generation even without stored analyses - will generate basic report
            if (storedAnalyses.length === 0) {
                console.log('âš ï¸ No stored analyses found - will generate basic report');
                showUserDebugWarning('No Prior Analyses', 'No stored analyses found. Will generate basic investment report...');
            } else {
                showUserDebugSuccess('Analyses Found', `âœ… Using ${storedAnalyses.length} existing analyses for comprehensive report`);
            }
            
            console.log('ðŸ“Š Found ' + storedAnalyses.length + ' stored analyses for report generation');
            
            // Organize analyses by agent type
            const analysesData = {};
            storedAnalyses.forEach(analysis => {
                analysesData[analysis.analystType] = {
                    content: analysis.content,
                    sources: analysis.sources || [],
                    timestamp: analysis.timestamp,
                    company: analysis.company,
                    ticker: analysis.ticker,
                    quality_score: analysis.qualityScore || 0.9
                };
            });
            
            // Show generation started message
            showUserDebugSuccess('Report Generation Started', 'Generating investment report using ' + Object.keys(analysesData).join(', ') + ' analyses');
            
            // Send report generation request via WebSocket
            console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ REACHED WEBSOCKET SECTION!');
            console.log('ðŸ” WebSocket status check:');
            showUserDebugInfo('Connecting to Server', 'ðŸ”Œ Checking WebSocket connection status...');
            console.log('ðŸ” ws exists:', !!ws);
            console.log('ðŸ” ws.readyState:', ws ? ws.readyState : 'N/A');
            console.log('ðŸ” WebSocket.OPEN:', WebSocket.OPEN);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('âœ… WebSocket is connected, sending message...');
                showUserDebugSuccess('Connected', 'âœ… WebSocket connected - sending report request...');
                const reportRequest = {
                    type: 'generate_report',
                    session_id: userSession.id,
                    connection_id: userSession.connectionId,
                    data: {
                        company_name: currentProject.company,
                        ticker: currentProject.ticker,
                        analyses_data: analysesData,
                        report_focus: 'comprehensive',
                        investment_objective: currentProject.query || 'Comprehensive investment analysis',
                        user_query: currentProject.query || 'Perform comprehensive investment analysis',
                        data_sources: currentProject.dataSources || {}
                    }
                };
                
                console.log('ðŸ” FRONTEND DEBUG: Sending report request with context:', reportRequest.data.data_sources);
                console.log('ðŸ“¤ Sending report generation request:', reportRequest);
                
                try {
                    ws.send(JSON.stringify(reportRequest));
                    console.log('âœ… WebSocket message sent successfully');
                    showUserDebugSuccess('Request Sent', 
                        'âœ… Report generation request sent to server!\n' +
                        'â³ Waiting for server response...\n' +
                        'ðŸ“Š This may take 1-2 minutes to complete'
                    );
                } catch (error) {
                    console.error('âŒ Error sending WebSocket message:', error);
                    showUserDebugError('Send Error', 'âŒ Error sending WebSocket message: ' + error.message);
                }
            } else {
                const connectionStatus = ws ? `ReadyState: ${ws.readyState}` : 'WebSocket not initialized';
                showUserDebugError('Connection Error', 
                    'WebSocket connection not available.\n' +
                    `Status: ${connectionStatus}\n` +
                    'Please refresh and try again.'
                );
            }
        }

        // Global variable to store latest HTML report for Word conversion
        let latestHtmlReport = null;

        function generateWordReport() {
            console.log('ðŸ“„ generateWordReport called');
            console.log('ðŸ“„ currentProject:', currentProject);
            console.log('ðŸ“„ latestHtmlReport length:', latestHtmlReport ? latestHtmlReport.length : 0);
            
            if (!currentProject) {
                showUserDebugError('No Project Setup', 
                    'Please set up an investment project first before generating documents.',
                    [
                        'Enter a company name and ticker symbol in the project setup section',
                        'Click "Set Up Investment Project" to begin',
                        'Complete at least one analyst analysis',
                        'Then generate an HTML report before converting to Word'
                    ]
                );
                return;
            }

            if (!latestHtmlReport || latestHtmlReport.trim().length === 0) {
                showUserDebugError('No HTML Report Available', 
                    'You must generate an HTML report first before converting to Word format.',
                    [
                        'Complete multiple analyst analyses (Fundamentals, Technical, Risk, etc.)',
                        'Click "Generate HTML Report" button to create the report',
                        'Wait for the HTML report generation to complete successfully',
                        'Then the Word generation button will become available'
                    ]
                );
                return;
            }

            // Validate HTML report contains actual content
            if (latestHtmlReport.length < 1000) {
                showUserDebugError('Invalid HTML Report', 
                    'The HTML report appears to be incomplete or corrupted. Please regenerate the HTML report first.',
                    [
                        'Check if the HTML report generation completed successfully',
                        'Try generating the HTML report again',
                        'Ensure all analyst analyses are complete before generating report'
                    ]
                );
                return;
            }

            console.log('ðŸ“„ Generating Word document for', currentProject.ticker);

            // Send Word generation request via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                const wordRequest = {
                    type: 'generate_word_report',
                    data: {
                        company_name: currentProject.company,
                        ticker: currentProject.ticker,
                        html_content: latestHtmlReport
                    }
                };

                console.log('ðŸ“¤ Sending Word generation request:', wordRequest);
                ws.send(JSON.stringify(wordRequest));

                // Show loading state
                const wordBtn = document.getElementById('generateWordBtn');
                if (wordBtn) {
                    wordBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Generating...';
                    wordBtn.disabled = true;
                }

            } else {
                showUserDebugError('Connection Error', 'WebSocket connection not available. Please refresh and try again.');
            }
        }

        function generatePdfReport() {
            console.log('ðŸ“„ generatePdfReport called');
            console.log('ðŸ“„ currentProject:', currentProject);
            console.log('ðŸ“„ latestHtmlReport length:', latestHtmlReport ? latestHtmlReport.length : 0);
            
            if (!currentProject) {
                showUserDebugError('No Project Setup', 
                    'Please set up an investment project first before generating documents.',
                    [
                        'Enter a company name and ticker symbol in the project setup section',
                        'Click "Set Up Investment Project" to begin',
                        'Complete at least one analyst analysis',
                        'Then generate an HTML report before converting to PDF'
                    ]
                );
                return;
            }

            if (!latestHtmlReport || latestHtmlReport.trim().length === 0) {
                showUserDebugError('No HTML Report Available', 
                    'You must generate an HTML report first before converting to PDF format.',
                    [
                        'Complete multiple analyst analyses (Fundamentals, Technical, Risk, etc.)',
                        'Click "Generate HTML Report" button to create the report',
                        'Wait for the HTML report generation to complete successfully',
                        'Then the PDF generation button will become available'
                    ]
                );
                return;
            }

            // Validate HTML report contains actual content
            if (latestHtmlReport.length < 1000) {
                showUserDebugError('Invalid HTML Report', 
                    'The HTML report appears to be incomplete or corrupted. Please regenerate the HTML report first.',
                    [
                        'Check if the HTML report generation completed successfully',
                        'Try generating the HTML report again',
                        'Ensure all analyst analyses are complete before generating report'
                    ]
                );
                return;
            }

            console.log('ðŸ“„ Generating PDF document for', currentProject.ticker);

            // Use fetch API to send PDF generation request
            const pdfData = {
                html_content: latestHtmlReport,
                company_name: currentProject.company,
                ticker: currentProject.ticker,
                format: 'pdf'
            };

            // Show loading state
            const pdfBtn = document.getElementById('generatePdfBtn');
            if (pdfBtn) {
                pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Generating PDF...';
                pdfBtn.disabled = true;
            }

            fetch('/api/professional/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('âœ… PDF generation completed:', data);
                
                // Reset button state
                if (pdfBtn) {
                    pdfBtn.innerHTML = '<i class="fas fa-file-pdf" style="margin-right: 8px;"></i>Generate PDF Document';
                    pdfBtn.disabled = false;
                }

                if (data.status === 'success') {
                    // Show success message with download option
                    showUserDebugSuccess('PDF Document Ready', 
                        `PDF document generated successfully for ${currentProject.company}! Click to download.`,
                        [{
                            text: 'Download PDF Document',
                            action: () => {
                                // Trigger download
                                const downloadUrl = `/api/download/pdf?file_path=${encodeURIComponent(data.file_path)}`;
                                window.open(downloadUrl, '_blank');
                            }
                        }]
                    );
                } else {
                    const errorMessage = (data && data.message) ? data.message : 'Failed to generate PDF document';
                    showUserDebugError('PDF Generation Failed', errorMessage);
                }
            })
            .catch(error => {
                console.error('âŒ PDF generation error:', error);
                
                // Reset button state
                if (pdfBtn) {
                    pdfBtn.innerHTML = '<i class="fas fa-file-pdf" style="margin-right: 8px;"></i>Generate PDF Document';
                    pdfBtn.disabled = false;
                }
                
                const errorMessage = error && error.message ? error.message : 'Unknown error occurred';
                showUserDebugError('PDF Generation Failed', 'Failed to generate PDF document: ' + errorMessage);
            });
        }

        function handleWordGenerationStarted(data) {
            console.log('ðŸ“„ Word generation started:', data);
            showUserDebugSuccess('Word Generation Started', `Converting report for ${data.company_name} to Word format...`);
        }

        function handleWordGenerationProgress(data) {
            console.log('ðŸ“„ Word generation progress:', data);
            // Update UI with progress if needed
        }

        function handleWordGenerationCompleted(data) {
            console.log('âœ… Word generation completed:', data);
            
            // Reset button state
            const wordBtn = document.getElementById('generateWordBtn');
            if (wordBtn) {
                wordBtn.innerHTML = '<i class="fas fa-file-word" style="margin-right: 8px;"></i>Generate Word Document';
                wordBtn.disabled = false;
            }

            // Show success message with download option
            showUserDebugSuccess('Word Document Ready', 
                `Word document generated successfully for ${data.company_name}! Click to download.`,
                [{
                    text: 'Download Word Document',
                    action: () => {
                        // Trigger download
                        const downloadUrl = data.download_url || `/api/download/word?file_path=${encodeURIComponent(data.file_path)}`;
                        window.open(downloadUrl, '_blank');
                    }
                }]
            );
        }

        function handleWordGenerationError(data) {
            console.error('âŒ Word generation error:', data);
            
            // Reset button state
            const wordBtn = document.getElementById('generateWordBtn');
            if (wordBtn) {
                wordBtn.innerHTML = '<i class="fas fa-file-word" style="margin-right: 8px;"></i>Generate Word Document';
                wordBtn.disabled = false;
            }

            showUserDebugError('Word Generation Failed', data.message || 'Failed to generate Word document');
        }


        function exportAnalysis() {
            // Export all cached analyses
            const exportData = {
                project: currentProject,
                analyses: analysisCache,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = (currentProject?.ticker || 'robeco') + '_investment_analysis.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Enhanced Event Listeners
        function setupEventListeners() {
            // Enter key for project setup
            document.getElementById('tickerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setupInvestmentProject();
                }
            });
            
            // Enter key for chat
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // Auto-resize chat input
            document.getElementById('chatInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        // Initialize the platform immediately (script is at bottom of body) - WITH DEBUG
        console.log('DEBUG: Reached script bottom initialization');
        console.log('DEBUG: About to call setupEventListeners');
        try {
            setupEventListeners();
            console.log('DEBUG: setupEventListeners completed successfully');
        } catch (error) {
            console.error('DEBUG: setupEventListeners error:', error);
        }
        
        console.log('DEBUG: About to call initWebSocket');
        try {
            initWebSocket();
            console.log('DEBUG: initWebSocket completed successfully');
        } catch (error) {
            console.error('DEBUG: initWebSocket error:', error);
        }
        
        console.log('ðŸŽ¯ Robeco Professional Investment Platform Ready');
        console.log('DEBUG: Script execution completed at line 3479');
    </script>
</body>
</html>